<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendar Reunião - ConectaKing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1C1C21 0%, #2C2C2F 100%);
            color: #FFFFFF;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #FFC700 0%, #F59E0B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.5;
            transition: all 0.3s;
        }
        
        .step.active {
            opacity: 1;
            background: rgba(255, 199, 0, 0.2);
            border: 2px solid #FFC700;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #FFC700;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .card {
            background: rgba(28, 28, 33, 0.8);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #FFFFFF;
            font-size: 1rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FFC700;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FFC700 0%, #F59E0B 100%);
            color: #000;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 199, 0, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
        }
        
        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .slot-btn {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #FFFFFF;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .slot-btn:hover {
            border-color: #FFC700;
            background: rgba(255, 199, 0, 0.1);
        }
        
        .slot-btn.selected {
            border-color: #FFC700;
            background: rgba(255, 199, 0, 0.2);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #EF4444;
            color: #EF4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22C55E;
            color: #22C55E;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .step-indicator {
                flex-direction: column;
                gap: 10px;
            }
            
            .slots-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-calendar-check"></i> Agendar Reunião</h1>
            <p>Agende uma reunião com <strong><%= ownerName %></strong></p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">Escolha uma data e horário disponível</p>
        </div>
        
        <div class="step-indicator">
            <div class="step active" id="step-1">
                <div class="step-number">1</div>
                <span>Data e Hora</span>
            </div>
            <div class="step" id="step-2">
                <div class="step-number">2</div>
                <span>Informações</span>
            </div>
            <div class="step" id="step-3">
                <div class="step-number">3</div>
                <span>Confirmar</span>
            </div>
        </div>
        
        <!-- Step 1: Selecionar Data e Hora -->
        <div class="card" id="step1-content">
            <h2>Selecione uma data</h2>
            <div class="form-group">
                <input type="date" id="selected-date" min="" required>
            </div>
            <div id="slots-container" class="slots-grid"></div>
            <div id="step1-error" class="error hidden"></div>
            <button class="btn btn-primary" onclick="proceedToStep2()" style="width: 100%; margin-top: 20px;">
                Continuar
            </button>
        </div>
        
        <!-- Step 2: Formulário -->
        <div class="card hidden" id="step2-content">
            <h2>Preencha suas informações</h2>
            <form id="appointment-form">
                <div class="form-group">
                    <label>Tipo de Agendamento *</label>
                    <select id="event-type" required onchange="handleEventTypeChange()">
                        <option value="REUNIAO">Reunião</option>
                        <option value="TRABALHO">Trabalho</option>
                    </select>
                    <small style="opacity: 0.7; font-size: 0.85rem; display: block; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> Reunião: inclui link do Google Meet. Trabalho: apenas agendamento.
                    </small>
                </div>
                <div class="form-group" id="location-group" style="display: none;">
                    <label>Endereço (Opcional)</label>
                    <input type="text" id="location-address" placeholder="Ex: Rua Exemplo, 123 - São Paulo, SP">
                    <small style="opacity: 0.7; font-size: 0.85rem; display: block; margin-top: 5px;">
                        <i class="fas fa-map-marker-alt"></i> Para reuniões presenciais, informe o endereço
                    </small>
                </div>
                <div class="form-group" id="maps-url-group" style="display: none;">
                    <label>Link do Google Maps (Opcional)</label>
                    <input type="url" id="location-maps-url" placeholder="https://maps.google.com/...">
                    <small style="opacity: 0.7; font-size: 0.85rem; display: block; margin-top: 5px;">
                        <i class="fas fa-link"></i> Cole o link do Google Maps do local
                    </small>
                </div>
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="full-name" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>WhatsApp</label>
                    <input type="tel" id="whatsapp" placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                    <label>Observações</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="lgpd-consent" required>
                        Concordo com o tratamento dos meus dados pessoais (LGPD)
                    </label>
                </div>
                <div id="step2-error" class="error hidden"></div>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="goToStep1()" style="flex: 1;">
                        Voltar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="proceedToStep3()" style="flex: 1;">
                        Continuar
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Step 3: Confirmação -->
        <div class="card hidden" id="step3-content">
            <h2>Confirme seu agendamento</h2>
            <div id="confirmation-details"></div>
            <div id="step3-error" class="error hidden"></div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="goToStep2()" style="flex: 1;">
                    Voltar
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmAppointment()" style="flex: 1;">
                    Confirmar com Google
                </button>
            </div>
        </div>
        
        <!-- Success -->
        <div class="card hidden" id="success-content">
            <div class="success">
                <h2><i class="fas fa-check-circle"></i> Agendamento Confirmado!</h2>
                <p id="success-message"></p>
                <a id="meet-link" href="#" target="_blank" class="btn btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-video"></i> Abrir Google Meet
                </a>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = '<%= typeof API_URL !== "undefined" ? API_URL : "https://conectaking-api.onrender.com/api" %>';
        const slug = '<%= slug %>';
        const ownerName = '<%= typeof ownerName !== "undefined" ? ownerName : "Profissional" %>';
        let selectedDate = null;
        let selectedSlot = null;
        let reservationId = null;
        
        // Configurar data mínima (hoje)
        document.getElementById('selected-date').min = new Date().toISOString().split('T')[0];
        
        // Listener para mudança de data
        document.getElementById('selected-date').addEventListener('change', async (e) => {
            selectedDate = e.target.value;
            await loadSlots(selectedDate);
        });
        
        async function loadSlots(date) {
            const container = document.getElementById('slots-container');
            container.innerHTML = '<p>Carregando horários disponíveis...</p>';
            
            try {
                const response = await fetch(`${API_URL}/agenda/${slug}/availability?date=${date}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Erro ao carregar disponibilidade');
                }
                
                const availability = result.data;
                
                if (availability.isBlocked) {
                    container.innerHTML = '<p style="color: #EF4444;">Esta data está bloqueada.</p>';
                    return;
                }
                
                if (availability.slots.length === 0) {
                    container.innerHTML = '<p>Nenhum horário disponível para esta data.</p>';
                    return;
                }
                
                container.innerHTML = '';
                availability.slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'slot-btn';
                    btn.textContent = slot.start_time.substring(0, 5);
                    btn.onclick = () => selectSlot(slot);
                    container.appendChild(btn);
                });
            } catch (error) {
                container.innerHTML = `<p style="color: #EF4444;">Erro: ${error.message}</p>`;
            }
        }
        
        function selectSlot(slot) {
            selectedSlot = slot;
            document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }
        
        function proceedToStep2() {
            if (!selectedDate || !selectedSlot) {
                document.getElementById('step1-error').textContent = 'Por favor, selecione uma data e horário.';
                document.getElementById('step1-error').classList.remove('hidden');
                return;
            }
            
            document.getElementById('step1-error').classList.add('hidden');
            document.getElementById('step1-content').classList.add('hidden');
            document.getElementById('step2-content').classList.remove('hidden');
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-2').classList.add('active');
        }
        
        function goToStep1() {
            document.getElementById('step2-content').classList.add('hidden');
            document.getElementById('step1-content').classList.remove('hidden');
            document.getElementById('step-2').classList.remove('active');
            document.getElementById('step-1').classList.add('active');
        }
        
        function handleEventTypeChange() {
            const eventType = document.getElementById('event-type').value;
            const locationGroup = document.getElementById('location-group');
            const mapsUrlGroup = document.getElementById('maps-url-group');
            
            // Mostrar campos de localização apenas para reuniões (podem ser presenciais)
            if (eventType === 'REUNIAO') {
                locationGroup.style.display = 'block';
                mapsUrlGroup.style.display = 'block';
            } else {
                locationGroup.style.display = 'none';
                mapsUrlGroup.style.display = 'none';
            }
        }
        
        async function proceedToStep3() {
            const form = document.getElementById('appointment-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const eventType = document.getElementById('event-type').value;
            const locationAddress = document.getElementById('location-address').value.trim();
            const locationMapsUrl = document.getElementById('location-maps-url').value.trim();
            
            const formData = {
                full_name: document.getElementById('full-name').value,
                email: document.getElementById('email').value,
                whatsapp: document.getElementById('whatsapp').value,
                notes: document.getElementById('notes').value,
                lgpd_consent: document.getElementById('lgpd-consent').checked,
                event_type: eventType,
                location_address: locationAddress || null,
                location_maps_url: locationMapsUrl || null
            };
            
            // Calcular horários
            const startDateTime = `${selectedDate}T${selectedSlot.start_time}`;
            const duration = <%= (typeof settings !== 'undefined' && settings && settings.meeting_duration_minutes) ? settings.meeting_duration_minutes : 30 %>;
            const endDateTime = new Date(new Date(startDateTime).getTime() + duration * 60000).toISOString();
            
            try {
                const response = await fetch(`${API_URL}/agenda/${slug}/reserve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_at: startDateTime,
                        end_at: endDateTime,
                        ...formData,
                        lgpd_consent_ip: await getClientIP(),
                        lgpd_consent_user_agent: navigator.userAgent
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Erro ao reservar slot');
                }
                
                reservationId = result.data.reservation_id;
                
                // Mostrar detalhes da confirmação
                const eventTypeText = eventType === 'REUNIAO' ? 'Reunião' : 'Trabalho';
                let detailsHTML = `
                    <p><strong>Tipo:</strong> ${eventTypeText}</p>
                    <p><strong>Data:</strong> ${new Date(selectedDate).toLocaleDateString('pt-BR')}</p>
                    <p><strong>Horário:</strong> ${selectedSlot.start_time.substring(0, 5)}</p>
                    <p><strong>Nome:</strong> ${formData.full_name}</p>
                    <p><strong>Email:</strong> ${formData.email}</p>
                `;
                
                if (locationAddress) {
                    detailsHTML += `<p><strong>Local:</strong> ${locationAddress}</p>`;
                }
                if (locationMapsUrl) {
                    detailsHTML += `<p><strong>Mapa:</strong> <a href="${locationMapsUrl}" target="_blank">Ver no Google Maps</a></p>`;
                }
                
                document.getElementById('confirmation-details').innerHTML = detailsHTML;
                
                document.getElementById('step2-content').classList.add('hidden');
                document.getElementById('step3-content').classList.remove('hidden');
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-3').classList.add('active');
            } catch (error) {
                document.getElementById('step2-error').textContent = error.message;
                document.getElementById('step2-error').classList.remove('hidden');
            }
        }
        
        function goToStep2() {
            document.getElementById('step3-content').classList.add('hidden');
            document.getElementById('step2-content').classList.remove('hidden');
            document.getElementById('step-3').classList.remove('active');
            document.getElementById('step-2').classList.add('active');
        }
        
        function confirmAppointment() {
            // Redirecionar para OAuth do Google
            window.location.href = `${API_URL}/oauth/agenda/google/client/start?reservation_id=${reservationId}`;
        }
        
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }
        
        // Verificar se veio da confirmação
        const urlParams = new URLSearchParams(window.location.search);
        const meetLink = urlParams.get('meetLink');
        if (meetLink) {
            document.getElementById('step1-content').classList.add('hidden');
            document.getElementById('step2-content').classList.add('hidden');
            document.getElementById('step3-content').classList.add('hidden');
            document.getElementById('success-content').classList.remove('hidden');
            document.getElementById('meet-link').href = meetLink;
            document.getElementById('success-message').textContent = 'Seu agendamento foi confirmado! Clique no botão abaixo para abrir o Google Meet.';
        }
    </script>
</body>
</html>
