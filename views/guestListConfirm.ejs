<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmação de Presença - <%= guestList.event_title || 'Evento' %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0D0D0F 0%, #1C1C21 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ECECEC;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 32px;
            font-weight: 800;
            color: #FFC700;
            margin-bottom: 12px;
        }
        
        .header p {
            color: #A1A1A1;
            font-size: 16px;
        }
        
        .info-box {
            background: rgba(255, 199, 0, 0.1);
            border: 1px solid rgba(255, 199, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .info-box h3 {
            color: #FFC700;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .guests-list {
            background: #1C1C21;
            border: 1px solid #2C2C2F;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        .guest-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #0D0D0F;
            border: 2px solid #2C2C2F;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }
        
        .guest-item:hover {
            border-color: #FFC700;
            background: rgba(255, 199, 0, 0.05);
        }
        
        .guest-item.checked {
            border-color: #25D366;
            background: rgba(37, 211, 102, 0.1);
        }
        
        .guest-info {
            flex: 1;
        }
        
        .guest-info .name {
            font-weight: 600;
            font-size: 16px;
            color: #ECECEC;
            margin-bottom: 4px;
        }
        
        .guest-info .details {
            font-size: 14px;
            color: #A1A1A1;
        }
        
        .guest-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #FFC700;
        }
        
        .btn-confirm {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #FFC700, #FFA500);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 24px;
        }
        
        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 199, 0, 0.4);
        }
        
        .btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-delete {
            padding: 12px 20px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-delete:hover {
            background: #b71c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
        }
        
        .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-delete-small {
            padding: 8px 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-delete-small:hover {
            background: #b71c1c;
        }
        
        .admin-actions {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(211, 47, 47, 0.1);
            border: 1px solid rgba(211, 47, 47, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .alert {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-success {
            background: rgba(37, 211, 102, 0.2);
            border: 1px solid #25D366;
            color: #25D366;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #A1A1A1;
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: #1C1C21;
            border: 1px solid #2C2C2F;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: 800;
            color: #FFC700;
            margin-bottom: 8px;
        }
        
        .stat-card .label {
            font-size: 14px;
            color: #A1A1A1;
        }
        
        @media (max-width: 768px) {
            .guest-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-<%= viewOnly ? 'check-circle' : 'user-check' %>"></i> <%= viewOnly ? 'Convidados Confirmados' : 'Confirmação de Presença' %></h1>
            <p><%= guestList.event_title || 'Evento' %></p>
        </div>
        
        <% if (guestList.event_description || guestList.event_date || guestList.event_time || guestList.event_location) { %>
        <div class="info-box">
            <h3><i class="fas fa-info-circle"></i> Informações do Evento</h3>
            <% if (guestList.event_description) { %>
            <p style="margin-bottom: 12px;"><%= guestList.event_description %></p>
            <% } %>
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,199,0,0.2);">
                <% if (guestList.event_date) { %>
                <p><i class="fas fa-calendar"></i> <strong>Data:</strong> <%= new Date(guestList.event_date).toLocaleDateString('pt-BR') %></p>
                <% } %>
                <% if (guestList.event_time) { %>
                <p><i class="fas fa-clock"></i> <strong>Horário:</strong> <%= guestList.event_time %></p>
                <% } %>
                <% if (guestList.event_location) { %>
                <p><i class="fas fa-map-marker-alt"></i> <strong>Local:</strong> <%= guestList.event_location %></p>
                <% } %>
            </div>
        </div>
        <% } %>
        
        <div class="stats">
            <div class="stat-card">
                <div class="value" id="total-count"><%= guests.length %></div>
                <div class="label">Total</div>
            </div>
            <div class="stat-card">
                <div class="value" id="confirmed-count"><%= guests.filter(g => g.status === 'confirmed').length %></div>
                <div class="label">Confirmados</div>
            </div>
            <div class="stat-card">
                <div class="value" id="pending-count"><%= guests.filter(g => g.status === 'registered').length %></div>
                <div class="label">Pendentes</div>
            </div>
        </div>
        
        <% if (!viewOnly) { %>
        <div class="admin-actions">
            <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #ECECEC; font-weight: 600;">
                    <input type="checkbox" id="select-all-checkbox" style="width: 20px; height: 20px; accent-color: #FFC700; cursor: pointer;">
                    Selecionar Todos
                </label>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button type="button" class="btn-delete" id="delete-selected-btn" style="display: none;">
                    <i class="fas fa-trash-alt"></i> Excluir Selecionados (<span id="selected-count">0</span>)
                </button>
                <button type="button" class="btn-delete" id="delete-all-btn">
                    <i class="fas fa-trash"></i> Excluir Todos
                </button>
            </div>
        </div>
        <% } %>
        
        <div class="guests-list">
            <% if (guests.length === 0) { %>
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p><%= viewOnly ? 'Nenhum convidado confirmado ainda' : 'Nenhum convidado encontrado' %></p>
            </div>
            <% } else { %>
            <% if (!viewOnly) { %>
            <form id="confirmation-form">
            <% } %>
                <% guests.forEach(guest => { %>
                <div class="guest-item <%= (guest.status === 'confirmed' || guest.status === 'checked_in') ? 'checked' : '' %>">
                    <div class="guest-info">
                        <div class="name" style="font-weight: 700; font-size: 18px; margin-bottom: 8px;"><%= guest.name || 'Nome não informado' %></div>
                        <div class="details" style="display: flex; flex-direction: column; gap: 4px;">
                            <% if (guest.email) { %>
                            <div><i class="fas fa-envelope" style="color: #FFC700; margin-right: 6px;"></i> <strong>Email:</strong> <%= guest.email %></div>
                            <% } else { %>
                            <div style="color: #666;"><i class="fas fa-envelope" style="margin-right: 6px;"></i> Email não informado</div>
                            <% } %>
                            <% if (guest.phone) { %>
                            <div><i class="fas fa-phone" style="color: #FFC700; margin-right: 6px;"></i> <strong>Telefone:</strong> <%= guest.phone %></div>
                            <% } else { %>
                            <div style="color: #666;"><i class="fas fa-phone" style="margin-right: 6px;"></i> Telefone não informado</div>
                            <% } %>
                            <% if (guest.status === 'confirmed' && guest.confirmed_at) { %>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; color: #25D366;">
                                <i class="fas fa-check-circle"></i> Confirmado em: <%= new Date(guest.confirmed_at).toLocaleString('pt-BR') %>
                            </div>
                            <% } %>
                        </div>
                    </div>
                    <% if (!viewOnly) { %>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input 
                            type="checkbox" 
                            class="guest-checkbox" 
                            name="guest_ids" 
                            value="<%= guest.id %>"
                            <%= (guest.status === 'confirmed' || guest.status === 'checked_in') ? 'checked disabled' : '' %>
                            data-guest-id="<%= guest.id %>"
                        >
                        <button type="button" class="btn-delete-small delete-guest-btn" data-guest-id="<%= guest.id %>" data-guest-name="<%= guest.name || 'Convidado' %>">
                            <i class="fas fa-times"></i> Excluir
                        </button>
                    </div>
                    <% } else { %>
                    <div style="color: #25D366; font-size: 24px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <% } %>
                </div>
                <% }); %>
                
                <% if (!viewOnly) { %>
                <button type="submit" class="btn-confirm" id="confirm-btn">
                    <i class="fas fa-check"></i> Confirmar Selecionados
                </button>
            </form>
            <% } %>
            <% } %>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('confirmation-form');
        const confirmBtn = document.getElementById('confirm-btn');
        const token = '<%= token %>';
        const profileItemId = <%= typeof profileItemId !== 'undefined' ? profileItemId : 'null' %>;
        
        // ==========================================================
        // FUNCIONALIDADES DE EXCLUSÃO E SELEÇÃO MÚLTIPLA
        // ==========================================================
        
        // Função para atualizar contador de selecionados
        function updateSelectedCount() {
            if (!form) return;
            
            const selectedCheckboxes = form.querySelectorAll('input[name="guest_ids"]:checked:not(:disabled)');
            const selectedCount = selectedCheckboxes.length;
            const selectedCountSpan = document.getElementById('selected-count');
            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            
            if (selectedCountSpan) {
                selectedCountSpan.textContent = selectedCount;
            }
            
            if (deleteSelectedBtn) {
                if (selectedCount > 0) {
                    deleteSelectedBtn.style.display = 'inline-flex';
                } else {
                    deleteSelectedBtn.style.display = 'none';
                }
            }
            
            // Atualizar checkbox "Selecionar Todos"
            if (selectAllCheckbox && form) {
                const allCheckboxes = form.querySelectorAll('input[name="guest_ids"]:not(:disabled)');
                const allChecked = allCheckboxes.length > 0 && selectedCount === allCheckboxes.length;
                selectAllCheckbox.checked = allChecked;
            }
        }
        
        // Event listener para checkboxes individuais
        if (form) {
            form.addEventListener('change', function(e) {
                if (e.target.name === 'guest_ids') {
                    updateSelectedCount();
                }
            });
        }
        
        // Event listener para "Selecionar Todos"
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox && form) {
            selectAllCheckbox.addEventListener('change', function() {
                const isChecked = this.checked;
                const checkboxes = form.querySelectorAll('input[name="guest_ids"]:not(:disabled)');
                checkboxes.forEach(cb => cb.checked = isChecked);
                updateSelectedCount();
            });
        }
        
        // Função para excluir selecionados
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        if (deleteSelectedBtn && profileItemId) {
            deleteSelectedBtn.addEventListener('click', async function() {
                if (!form) return;
                
                const selectedCheckboxes = form.querySelectorAll('input[name="guest_ids"]:checked:not(:disabled)');
                const guestIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
                
                if (guestIds.length === 0) {
                    alert('Selecione pelo menos um convidado para excluir');
                    return;
                }
                
                if (!confirm(`Tem certeza que deseja excluir ${guestIds.length} convidado(s) selecionado(s)? Esta ação não pode ser desfeita.`)) {
                    return;
                }
                
                deleteSelectedBtn.disabled = true;
                deleteSelectedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
                
                try {
                    // Excluir um por um
                    const deletePromises = guestIds.map(guestId => 
                        fetch(`/api/guest-lists/${profileItemId}/guests/${guestId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                    );
                    
                    const results = await Promise.all(deletePromises);
                    const jsonResults = await Promise.all(results.map(r => r.json()));
                    
                    // Verificar se todas foram bem-sucedidas
                    const allSuccess = jsonResults.every(r => r.success !== false);
                    
                    if (allSuccess) {
                        // Remover itens da lista
                        selectedCheckboxes.forEach(cb => {
                            const guestItem = cb.closest('.guest-item');
                            if (guestItem) {
                                guestItem.style.transition = 'opacity 0.3s';
                                guestItem.style.opacity = '0';
                                setTimeout(() => {
                                    guestItem.remove();
                                    updateSelectedCount();
                                    // Atualizar contador total
                                    const totalCount = parseInt(document.getElementById('total-count').textContent);
                                    document.getElementById('total-count').textContent = Math.max(0, totalCount - 1);
                                }, 300);
                            }
                        });
                        
                        // Recarregar página após um pequeno delay se não houver mais itens
                        setTimeout(() => {
                            const remainingItems = document.querySelectorAll('.guest-item');
                            if (remainingItems.length === 0) {
                                location.reload();
                            }
                        }, 400);
                    } else {
                        throw new Error('Alguns convidados não puderam ser excluídos');
                    }
                } catch (error) {
                    alert('Erro ao excluir convidados: ' + error.message);
                } finally {
                    deleteSelectedBtn.disabled = false;
                    deleteSelectedBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Excluir Selecionados (<span id="selected-count">0</span>)';
                    updateSelectedCount();
                }
            });
        }
        
        // Função para excluir todos os convidados
        const deleteAllBtn = document.getElementById('delete-all-btn');
        if (deleteAllBtn && profileItemId) {
            deleteAllBtn.addEventListener('click', async () => {
                if (!confirm('Tem certeza que deseja excluir TODOS os convidados? Esta ação não pode ser desfeita.')) {
                    return;
                }
                
                deleteAllBtn.disabled = true;
                deleteAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...';
                
                try {
                    const response = await fetch(`/api/guest-lists/${profileItemId}/guests`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(`Todos os convidados foram excluídos com sucesso (${result.deleted_count || 0} excluídos).`);
                        location.reload();
                    } else {
                        throw new Error(result.message || 'Erro ao excluir convidados');
                    }
                } catch (error) {
                    alert('Erro ao excluir convidados: ' + error.message);
                    deleteAllBtn.disabled = false;
                    deleteAllBtn.innerHTML = '<i class="fas fa-trash"></i> Excluir Todos';
                }
            });
        }
        
        // Inicializar contador ao carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateSelectedCount);
        } else {
            updateSelectedCount();
        }
        
        // Função para excluir convidado individual
        document.querySelectorAll('.delete-guest-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const guestId = parseInt(btn.dataset.guestId);
                const guestName = btn.dataset.guestName || 'este convidado';
                
                if (!confirm(`Tem certeza que deseja excluir ${guestName}? Esta ação não pode ser desfeita.`)) {
                    return;
                }
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                try {
                    const response = await fetch(`/api/guest-lists/${profileItemId}/guests/${guestId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // Remover o item da lista
                        const guestItem = btn.closest('.guest-item');
                        guestItem.style.transition = 'opacity 0.3s';
                        guestItem.style.opacity = '0';
                        setTimeout(() => {
                            guestItem.remove();
                            // Atualizar contadores
                            const totalCount = parseInt(document.getElementById('total-count').textContent);
                            document.getElementById('total-count').textContent = Math.max(0, totalCount - 1);
                            // Verificar se a lista está vazia
                            const remainingItems = document.querySelectorAll('.guest-item');
                            if (remainingItems.length === 0) {
                                location.reload();
                            }
                        }, 300);
                        updateSelectedCount();
                    } else {
                        throw new Error(result.message || 'Erro ao excluir convidado');
                    }
                } catch (error) {
                    alert('Erro ao excluir convidado: ' + error.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-times"></i> Excluir';
                }
            });
        });
        
        if (form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const checkboxes = form.querySelectorAll('input[name="guest_ids"]:checked:not(:disabled)');
                const guestIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
                
                if (guestIds.length === 0) {
                    alert('Selecione pelo menos um convidado para confirmar');
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirmando...';
                
                try {
                    const response = await fetch(`/api/guest-lists/public/confirm/${token}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ guest_ids: guestIds })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        // Atualizar interface
                        guestIds.forEach(guestId => {
                            const checkbox = form.querySelector(`input[value="${guestId}"]`);
                            const guestItem = checkbox.closest('.guest-item');
                            checkbox.disabled = true;
                            guestItem.classList.add('checked');
                        });
                        
                        // Atualizar contadores
                        const confirmedCount = parseInt(document.getElementById('confirmed-count').textContent);
                        const pendingCount = parseInt(document.getElementById('pending-count').textContent);
                        document.getElementById('confirmed-count').textContent = confirmedCount + guestIds.length;
                        document.getElementById('pending-count').textContent = Math.max(0, pendingCount - guestIds.length);
                        
                        // Mostrar mensagem de sucesso
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success';
                        alert.innerHTML = `
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <strong>Confirmado!</strong>
                                <p>${result.confirmed_count} convidado(s) confirmado(s) com sucesso.</p>
                            </div>
                        `;
                        form.insertBefore(alert, form.firstChild);
                        
                        setTimeout(() => alert.remove(), 5000);
                    } else {
                        throw new Error(result.message || 'Erro ao confirmar convidados');
                    }
                } catch (error) {
                    alert('Erro ao confirmar convidados: ' + error.message);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check"></i> Confirmar Selecionados';
                }
            });
        }
    </script>
</body>
</html>

