<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio Enviado com Sucesso - King Forms</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <% if (showGuestListInfo && typeof qrToken !== 'undefined' && qrToken) { %>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <% } %>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, <%= primaryColor || '#4A90E2' %> 0%, <%= secondaryColor || '#6BA3F0' %> 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .success-container {
            background: white;
            border-radius: 24px;
            padding: 48px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #4caf50, #45a049);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 32px;
            animation: scaleIn 0.5s ease-out 0.2s both;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }
        
        .success-icon i {
            font-size: 64px;
            color: white;
        }
        
        h1 {
            font-size: 32px;
            font-weight: 700;
            color: #202124;
            margin-bottom: 16px;
        }
        
        .success-message {
            font-size: 18px;
            color: #5f6368;
            margin-bottom: 32px;
            line-height: 1.6;
        }
        
        .response-id {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #5f6368;
        }
        
        .response-id strong {
            color: #202124;
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 32px;
        }
        
        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, <%= primaryColor || '#4A90E2' %> 0%, <%= secondaryColor || '#6BA3F0' %> 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(74, 144, 226, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(74, 144, 226, 0.5);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #5f6368;
        }
        
        .btn-secondary:hover {
            background: #e8eaed;
        }
        
        .info-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            border-radius: 8px;
            padding: 16px;
            margin: 24px 0;
            text-align: left;
        }
        
        .info-box strong {
            color: #2e7d32;
            display: block;
            margin-bottom: 8px;
        }
        
        .info-box p {
            color: #1b5e20;
            font-size: 14px;
            margin: 0;
            line-height: 1.6;
        }
        
        @media (max-width: 600px) {
            .success-container {
                padding: 32px 24px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .success-message {
                font-size: 16px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            #qr-code-section {
                padding: 24px 16px !important;
            }
            
            #qr-code-section > div:first-of-type {
                padding: 16px !important;
            }
            
            #qrcode-container {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                width: 100% !important;
            }
            
            #qrcode-container canvas,
            #qrcode-container img {
                max-width: 100% !important;
                height: auto !important;
                margin: 0 auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="success-container">
        <div class="success-icon">
            <i class="fas fa-check"></i>
        </div>
        
        <h1>
            <% if (showGuestListInfo) { %>
                ‚úÖ Parab√©ns! Inscri√ß√£o Realizada com Sucesso!
            <% } else { %>
                ‚úÖ Formul√°rio Enviado com Sucesso!
            <% } %>
        </h1>
        
        <p class="success-message">
            <%= message || (showGuestListInfo ? 'Parab√©ns! Sua inscri√ß√£o foi realizada com sucesso. Voc√™ foi adicionado √† nossa lista e aguardamos voc√™ no evento!' : 'Obrigado por preencher o formul√°rio. Sua resposta foi registrada com sucesso.') %>
        </p>
        
        <% if (responseId) { %>
        <div class="response-id">
            <strong>N√∫mero de Refer√™ncia</strong>
            <span style="font-family: 'Courier New', monospace; font-size: 18px; font-weight: 700; color: <%= primaryColor || '#4A90E2' %>;">
                REF-<%= String(responseId).padStart(6, '0') %>
            </span>
        </div>
        <% } %>
        
        <% if (typeof submittedData !== 'undefined' && submittedData && Object.keys(submittedData).length > 0) { %>
        <div style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(107, 163, 240, 0.08)); border-radius: 12px; padding: 24px; margin: 24px 0; text-align: left; border: 1px solid rgba(74, 144, 226, 0.2);">
            <h3 style="font-size: 20px; font-weight: 700; color: #202124; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-clipboard-check" style="color: <%= primaryColor || '#4A90E2' %>; font-size: 24px;"></i>
                Informa√ß√µes da Sua Inscri√ß√£o
            </h3>
            <div style="display: grid; gap: 16px;">
                <% Object.keys(submittedData).forEach(key => { %>
                    <% 
                        const value = submittedData[key];
                        const displayValue = typeof value === 'string' ? decodeURIComponent(value) : value;
                    %>
                    <% if (displayValue && displayValue.toString().trim() !== '') { %>
                    <div style="padding: 16px; background: white; border-radius: 10px; border-left: 4px solid <%= primaryColor || '#4A90E2' %>; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                        <div style="font-size: 11px; color: #5f6368; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600;">
                            <%= key.replace(/data_/g, '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) %>
                        </div>
                        <div style="font-size: 17px; color: #202124; font-weight: 600; line-height: 1.5;">
                            <%= displayValue %>
                        </div>
                    </div>
                    <% } %>
                <% }); %>
            </div>
        </div>
        <% } else if (typeof responseData !== 'undefined' && responseData && (responseData.response_data || responseData.responder_name || responseData.responder_email || responseData.responder_phone)) { %>
        <div style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(107, 163, 240, 0.08)); border-radius: 12px; padding: 24px; margin: 24px 0; text-align: left; border: 1px solid rgba(74, 144, 226, 0.2);">
            <h3 style="font-size: 20px; font-weight: 700; color: #202124; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-clipboard-check" style="color: <%= primaryColor || '#4A90E2' %>; font-size: 24px;"></i>
                Informa√ß√µes da Sua Inscri√ß√£o
            </h3>
            <div style="display: grid; gap: 16px;">
                <% if (responseData.responder_name) { %>
                <div style="padding: 16px; background: white; border-radius: 10px; border-left: 4px solid <%= primaryColor || '#4A90E2' %>; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 11px; color: #5f6368; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600;">Nome Completo</div>
                    <div style="font-size: 17px; color: #202124; font-weight: 600;"><%= responseData.responder_name %></div>
                </div>
                <% } %>
                <% if (responseData.responder_email) { %>
                <div style="padding: 16px; background: white; border-radius: 10px; border-left: 4px solid <%= primaryColor || '#4A90E2' %>; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 11px; color: #5f6368; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600;">E-mail</div>
                    <div style="font-size: 17px; color: #202124; font-weight: 600;"><%= responseData.responder_email %></div>
                </div>
                <% } %>
                <% if (responseData.responder_phone) { %>
                <div style="padding: 16px; background: white; border-radius: 10px; border-left: 4px solid <%= primaryColor || '#4A90E2' %>; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div style="font-size: 11px; color: #5f6368; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600;">Telefone/WhatsApp</div>
                    <div style="font-size: 17px; color: #202124; font-weight: 600;"><%= responseData.responder_phone %></div>
                </div>
                <% } %>
                <% if (typeof responseData.response_data === 'object' && responseData.response_data) { %>
                    <% Object.keys(responseData.response_data).forEach(key => { %>
                        <% 
                            const value = responseData.response_data[key];
                            const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
                        %>
                        <% if (displayValue && displayValue.toString().trim() !== '' && key !== 'name' && key !== 'nome' && key !== 'email' && key !== 'phone' && key !== 'whatsapp' && key !== 'telefone') { %>
                        <div style="padding: 16px; background: white; border-radius: 10px; border-left: 4px solid <%= primaryColor || '#4A90E2' %>; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div style="font-size: 11px; color: #5f6368; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-weight: 600;">
                                <%= key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) %>
                            </div>
                            <div style="font-size: 17px; color: #202124; font-weight: 600; line-height: 1.5;">
                                <%= displayValue %>
                            </div>
                        </div>
                        <% } %>
                    <% }); %>
                <% } %>
            </div>
        </div>
        <% } %>
        
        <% if (showWhatsAppInfo && whatsappNumber) { %>
        <div class="info-box">
            <strong><i class="fab fa-whatsapp"></i> Pr√≥ximos Passos</strong>
            <p>Verifique o WhatsApp para continuar o atendimento. Se n√£o recebeu a mensagem, verifique se o n√∫mero est√° correto.</p>
        </div>
        <% } %>
        
        <% if (showGuestListInfo) { %>
        <div class="info-box" style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(69, 160, 73, 0.15)); border-left: 4px solid #4caf50; padding: 24px; border-radius: 12px; margin: 24px 0;">
            <strong style="display: flex; align-items: center; gap: 8px; color: #2e7d32; font-size: 18px; margin-bottom: 12px;">
                <i class="fas fa-check-circle"></i> Parab√©ns! Inscri√ß√£o Confirmada
            </strong>
            <p style="color: #1b5e20; font-size: 16px; line-height: 1.6; margin: 0;">
                üéâ Sua inscri√ß√£o foi realizada com sucesso! Voc√™ foi adicionado √† nossa lista de convidados.<br><br>
                <strong>Aguarde o nosso contato</strong> - entraremos em contato em breve para mais informa√ß√µes.
            </p>
        </div>
        <% } %>
        
        <% if (showGuestListInfo && typeof qrToken !== 'undefined' && qrToken) { %>
        <!-- QR Code de Confirma√ß√£o de Presen√ßa -->
        <div id="qr-code-section" style="background: linear-gradient(135deg, rgba(<%= primaryColor ? parseInt(primaryColor.slice(1, 3), 16) + ',' + parseInt(primaryColor.slice(3, 5), 16) + ',' + parseInt(primaryColor.slice(5, 7), 16) : '74,144,226' %>, 0.05), rgba(<%= secondaryColor ? parseInt(secondaryColor.slice(1, 3), 16) + ',' + parseInt(secondaryColor.slice(3, 5), 16) + ',' + parseInt(secondaryColor.slice(5, 7), 16) : '107,163,240' %>, 0.08)); border: 2px solid rgba(<%= primaryColor ? parseInt(primaryColor.slice(1, 3), 16) + ',' + parseInt(primaryColor.slice(3, 5), 16) + ',' + parseInt(primaryColor.slice(5, 7), 16) : '74,144,226' %>, 0.3); border-radius: 20px; padding: 32px; margin: 32px 0; text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 24px;">
                <i class="fas fa-qrcode" style="font-size: 28px; color: <%= primaryColor || '#4A90E2' %>;"></i>
                <h2 style="margin: 0; font-size: 24px; font-weight: 700; color: #202124;">QR Code de Confirma√ß√£o</h2>
            </div>
            
            <div style="background: rgba(255,255,255,0.9); border-radius: 16px; padding: 24px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <div id="qrcode-container" style="display: flex; justify-content: center; align-items: center;"></div>
            </div>
            
            <!-- Aviso Importante -->
            <div style="background: linear-gradient(135deg, rgba(255, 199, 0, 0.15), rgba(255, 199, 0, 0.25)); border: 2px solid rgba(255, 199, 0, 0.4); border-radius: 12px; padding: 20px; margin: 20px 0;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #FFC700;"></i>
                    <strong style="font-size: 18px; color: #202124;">‚ö†Ô∏è IMPORTANTE</strong>
                </div>
                <p style="font-size: 16px; color: #333; line-height: 1.6; margin: 0;">
                    <strong>Tire um print ou baixe o QR Code</strong> para n√£o perder!<br>
                    Apresente este QR Code na portaria do evento para confirmar sua presen√ßa.
                </p>
            </div>
            
            <!-- Informa√ß√µes do Evento no QR Code -->
            <% if (eventTitle || eventDate || eventAddress) { %>
            <div style="background: white; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: left; border: 1px solid rgba(0,0,0,0.1);">
                <h3 style="font-size: 16px; font-weight: 600; color: #5f6368; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Informa√ß√µes do Evento</h3>
                <% if (eventTitle) { %>
                <div style="margin-bottom: 10px;">
                    <strong style="color: #202124; font-size: 18px;"><%= eventTitle %></strong>
                </div>
                <% } %>
                <% if (eventDate) { %>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #5f6368;">
                    <i class="fas fa-calendar"></i>
                    <span><%= new Date(eventDate).toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></span>
                </div>
                <% } %>
                <% if (eventAddress) { %>
                <div style="display: flex; align-items: flex-start; gap: 8px; color: #5f6368;">
                    <i class="fas fa-map-marker-alt" style="margin-top: 4px;"></i>
                    <span><%= eventAddress %></span>
                </div>
                <% } %>
            </div>
            <% } %>
            
            <!-- Bot√µes de A√ß√£o (com Preview - Melhoria 5) -->
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 24px;">
                <button onclick="showQRCodePreview()" class="btn" style="background: linear-gradient(135deg, <%= primaryColor || '#4A90E2' %> 0%, <%= secondaryColor || '#6BA3F0' %> 100%); color: white; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 20px rgba(74, 144, 226, 0.4);">
                    <i class="fas fa-eye"></i> Ver Preview
                </button>
                <button onclick="downloadQRCode()" class="btn" style="background: rgba(255,255,255,0.1); color: <%= primaryColor || '#4A90E2' %>; border: 2px solid <%= primaryColor || '#4A90E2' %>; padding: 14px 28px; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s;">
                    <i class="fas fa-download"></i> Baixar
                </button>
                <button onclick="shareQRCode()" class="btn btn-secondary" style="background: #f8f9fa; color: #5f6368; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s;">
                    <i class="fab fa-whatsapp"></i> Compartilhar
                </button>
            </div>
        </div>
        <% } %>
        
        <div class="actions">
            <% if (formUrl) { %>
            <a href="<%= formUrl %>" class="btn btn-secondary">
                <i class="fas fa-redo"></i> Preencher Novamente
            </a>
            <% } %>
            
            <button onclick="window.close()" class="btn btn-secondary" style="display: none;">
                <i class="fas fa-times"></i> Fechar
            </button>
        </div>
    </div>
    
    <script>
        // Auto-redirect ap√≥s 10 segundos (opcional)
        <% if (autoRedirect && redirectUrl) { %>
        setTimeout(() => {
            window.location.href = '<%= redirectUrl %>';
        }, 10000);
        <% } %>
        
        // Registrar evento de visualiza√ß√£o da p√°gina de sucesso
        if (typeof gtag !== 'undefined') {
            gtag('event', 'form_submit_success', {
                'event_category': 'Form',
                'event_label': 'Success Page View'
            });
        }
        
        <% if (showGuestListInfo && typeof qrToken !== 'undefined' && qrToken) { %>
        // Gerar QR Code
        const qrToken = '<%- qrToken %>';
        const eventTitle = '<%- typeof eventTitle !== 'undefined' ? eventTitle : "Evento" %>';
        const eventDate = '<%- typeof eventDate !== 'undefined' && eventDate ? eventDate : "" %>';
        const eventAddress = '<%- typeof eventAddress !== 'undefined' ? eventAddress : "" %>';
        const primaryColor = '<%- typeof primaryColor !== 'undefined' ? primaryColor : "#4A90E2" %>';
        const secondaryColor = '<%- typeof secondaryColor !== 'undefined' ? secondaryColor : "#6BA3F0" %>';
        
        // Dados dispon√≠veis no cliente
        <% 
            let personNameValue = '';
            if (typeof responseData !== 'undefined' && responseData && responseData.responder_name) {
                personNameValue = responseData.responder_name;
            } else if (typeof submittedData !== 'undefined' && submittedData) {
                // Tentar encontrar o nome nos dados submetidos
                if (submittedData.name) personNameValue = submittedData.name;
                else if (submittedData.nome) personNameValue = submittedData.nome;
                else if (submittedData.data_name) personNameValue = submittedData.data_name;
                else if (submittedData.data_nome) personNameValue = submittedData.data_nome;
                // Procurar em todas as chaves
                if (!personNameValue) {
                    Object.keys(submittedData).forEach(key => {
                        const keyLower = key.toLowerCase();
                        if ((keyLower.includes('name') || keyLower.includes('nome')) && !personNameValue) {
                            const value = submittedData[key];
                            if (value && typeof value === 'string' && value.trim().length >= 2) {
                                personNameValue = value;
                            }
                        }
                    });
                }
            }
            if (!personNameValue && typeof responseData !== 'undefined' && responseData && responseData.response_data) {
                const responseDataObj = responseData.response_data;
                if (responseDataObj.name) personNameValue = responseDataObj.name;
                else if (responseDataObj.nome) personNameValue = responseDataObj.nome;
                else if (responseDataObj.data_name) personNameValue = responseDataObj.data_name;
                else if (responseDataObj.data_nome) personNameValue = responseDataObj.data_nome;
                // Procurar em todas as chaves
                if (!personNameValue && typeof responseDataObj === 'object') {
                    Object.keys(responseDataObj).forEach(key => {
                        const keyLower = key.toLowerCase();
                        if ((keyLower.includes('name') || keyLower.includes('nome')) && !personNameValue) {
                            const value = responseDataObj[key];
                            if (value && typeof value === 'string' && value.trim().length >= 2) {
                                personNameValue = value;
                            }
                        }
                    });
                }
            }
        %>
        const personName = '<%- personNameValue || "" %>';
        
        console.log('üîç Debug QR Code:', {
            showGuestListInfo: <%= showGuestListInfo %>,
            qrToken: qrToken ? qrToken.substring(0, 10) + '...' : 'null',
            qrTokenLength: qrToken ? qrToken.length : 0
        });
        
        // URL para confirma√ß√£o via QR Code
        // O QR Code cont√©m apenas o token, que ser√° lido pelo scanner
        const qrCodeData = qrToken;
        
        if (!qrCodeData || qrCodeData.trim() === '') {
            console.error('‚ùå QR Token est√° vazio!');
            const container = document.getElementById('qrcode-container');
            if (container) {
                container.innerHTML = '<p style="color: red; padding: 20px;">Erro: QR Token n√£o encontrado. Por favor, entre em contato com o suporte.</p>';
            }
        } else {
            // Fun√ß√£o para gerar QR Code (aguarda DOM e biblioteca estarem prontos)
            let qrCodeAttempts = 0;
            const maxQRCodeAttempts = 50; // 50 * 200ms = 10 segundos m√°ximo
            
            function generateQRCode() {
                qrCodeAttempts++;
                
                if (qrCodeAttempts > maxQRCodeAttempts) {
                    console.error('‚ùå Limite de tentativas excedido. Biblioteca QRCode n√£o carregou.');
                    const container = document.getElementById('qrcode-container');
                    if (container) {
                        container.innerHTML = '<p style="color: red; padding: 20px;">Erro: N√£o foi poss√≠vel carregar a biblioteca de QR Code. Por favor, recarregue a p√°gina.</p>';
                    }
                    return;
                }
                
                console.log('üîÑ Tentando gerar QR Code... (tentativa ' + qrCodeAttempts + '/' + maxQRCodeAttempts + ')');
                
                // Verificar se a biblioteca qrcodejs est√° dispon√≠vel
                // A biblioteca qrcodejs exp√µe QRCode como construtor global
                if (typeof QRCode === 'undefined') {
                    console.warn('‚ö†Ô∏è Biblioteca QRCode ainda n√£o carregou, aguardando...');
                    setTimeout(generateQRCode, 200);
                    return;
                }
                
                const container = document.getElementById('qrcode-container');
                if (!container) {
                    console.warn('‚ö†Ô∏è Container do QR Code n√£o encontrado, aguardando DOM...');
                    setTimeout(generateQRCode, 200);
                    return;
                }
                
                if (!qrCodeData || qrCodeData.trim() === '') {
                    console.error('‚ùå qrCodeData est√° vazio!');
                    container.innerHTML = '<p style="color: red; padding: 20px;">Erro: Dados do QR Code n√£o encontrados.</p>';
                    return;
                }
                
                console.log('‚úÖ Gerando QR Code com token:', qrCodeData.substring(0, 20) + '...');
                
                try {
                    // Limpar container anterior se houver
                    container.innerHTML = '';
                    
                    // Usar qrcodejs que usa new QRCode() para criar o QR code
                    // Esta biblioteca cria o QR code diretamente no container
                    new QRCode(container, {
                        text: qrCodeData,
                        width: 300,
                        height: 300,
                        colorDark: '#000000',
                        colorLight: '#FFFFFF',
                        correctLevel: QRCode.CorrectLevel.M
                    });
                    
                    console.log('‚úÖ QR Code gerado com sucesso!');
                } catch (err) {
                    console.error('‚ùå Erro ao gerar QR Code:', err);
                    container.innerHTML = '<p style="color: red; padding: 20px;">Erro ao gerar QR Code: ' + (err.message || err.toString()) + '. Tente recarregar a p√°gina.</p>';
                }
            }
            
            // Aguardar DOM e biblioteca estarem prontos
            // Usar window.onload para garantir que todos os scripts foram carregados
            if (document.readyState === 'loading') {
                window.addEventListener('load', function() {
                    console.log('üìÑ P√°gina totalmente carregada, iniciando gera√ß√£o de QR Code...');
                    setTimeout(generateQRCode, 100);
                });
            } else {
                // Se a p√°gina j√° carregou, aguardar um pouco e tentar
                console.log('üìÑ DOM j√° est√° pronto, aguardando biblioteca...');
                setTimeout(generateQRCode, 100);
            }
        }
        
        // Fun√ß√£o auxiliar para obter o canvas do QR Code
        function getQRCodeCanvas() {
            const container = document.getElementById('qrcode-container');
            if (!container) return null;
            // A biblioteca qrcodejs cria um canvas dentro do container
            return container.querySelector('canvas') || container.querySelector('img');
        }
        
        // Fun√ß√£o para mostrar preview do QR Code (Melhoria 5)
        function showQRCodePreview() {
            const container = document.getElementById('qrcode-container');
            if (!container) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
            
            // Pegar o canvas ou img do container
            const canvas = container.querySelector('canvas');
            const img = container.querySelector('img');
            const qrCodeDataUrl = canvas ? canvas.toDataURL('image/png') : (img ? img.src : '');
            if (!qrCodeDataUrl) return;
            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 32px; max-width: 600px; width: 100%; text-align: center; position: relative;">
                    <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()" style="position: absolute; top: 16px; right: 16px; background: rgba(0,0,0,0.1); border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; color: #333;">√ó</button>
                    <h2 style="margin: 0 0 24px 0; color: #202124; font-size: 24px; font-weight: 700;">Preview do QR Code</h2>
                    <div style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; display: inline-block; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                        <img src="${qrCodeDataUrl}" style="max-width: 400px; width: 100%; height: auto;" alt="QR Code Preview">
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="downloadQRCode(); this.closest('div[style*=\\'position: fixed\\']').remove();" style="padding: 12px 24px; background: linear-gradient(135deg, ${primaryColor || '#4A90E2'} 0%, ${secondaryColor || '#6BA3F0'} 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fas fa-download"></i> Baixar PNG
                        </button>
                        <button onclick="downloadQRCodePDF(); this.closest('div[style*=\\'position: fixed\\']').remove();" style="padding: 12px 24px; background: #f8f9fa; color: #5f6368; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file-pdf"></i> Baixar PDF
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Fun√ß√£o para baixar QR Code como PNG personalizado (estilo Simpla)
        function downloadQRCode() {
            const container = document.getElementById('qrcode-container');
            if (!container) return;
            
            const canvas = container.querySelector('canvas');
            const img = container.querySelector('img');
            if (!canvas && !img) return;
            
            // Criar canvas personalizado com design estilo Simpla
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = 800;
            finalCanvas.height = 1000;
            const ctx = finalCanvas.getContext('2d');
            
            // Cor de fundo branco
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            // Converter cores hex para RGB
            const primaryRgb = hexToRgb(primaryColor);
            const secondaryRgb = hexToRgb(secondaryColor);
            
            // Header com gradiente (estilo Simpla)
            const gradient = ctx.createLinearGradient(0, 0, finalCanvas.width, 0);
            gradient.addColorStop(0, `rgb(${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b})`);
            gradient.addColorStop(1, `rgb(${secondaryRgb.r}, ${secondaryRgb.g}, ${secondaryRgb.b})`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, finalCanvas.width, 120);
            
            // T√≠tulo no header
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 32px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Confirma√ß√£o de Presen√ßa', finalCanvas.width / 2, 40);
            
            // Subt√≠tulo
            ctx.font = '18px Inter, sans-serif';
            ctx.fillText('Apresente este QR Code na portaria', finalCanvas.width / 2, 75);
            
            // Nome da pessoa (se dispon√≠vel) - estilo Simpla
            let yPos = 180;
            if (personName && personName.trim() !== '') {
                ctx.fillStyle = '#202124';
                ctx.font = 'bold 36px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(personName, finalCanvas.width / 2, yPos);
                yPos += 50;
            }
            
            // Fun√ß√£o para desenhar o resto do conte√∫do e fazer download
            function drawRemainingContentAndDownload(qrImageElement) {
                // QR Code centralizado
                const qrSize = 400;
                const qrX = (finalCanvas.width - qrSize) / 2;
                const qrY = yPos;
                
                // Desenhar QR Code
                ctx.drawImage(qrImageElement, qrX, qrY, qrSize, qrSize);
                
                yPos += qrSize + 40;
                
                // Informa√ß√µes do evento
                ctx.fillStyle = '#202124';
                ctx.font = 'bold 28px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(eventTitle, finalCanvas.width / 2, yPos);
                yPos += 40;
                
                if (eventDate) {
                    ctx.fillStyle = '#5f6368';
                    ctx.font = '20px Inter, sans-serif';
                    ctx.fillText('üìÖ ' + eventDate, finalCanvas.width / 2, yPos);
                    yPos += 35;
                }
                
                if (eventAddress) {
                    ctx.fillStyle = '#5f6368';
                    ctx.font = '18px Inter, sans-serif';
                    const maxWidth = finalCanvas.width - 80;
                    const words = eventAddress.split(' ');
                    let line = 'üìç ';
                    let lines = [];
                    words.forEach(word => {
                        const testLine = line + word + ' ';
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && line !== 'üìç ') {
                            lines.push(line);
                            line = word + ' ';
                        } else {
                            line = testLine;
                        }
                    });
                    lines.push(line);
                    lines.forEach((line, index) => {
                        ctx.fillText(line.trim(), finalCanvas.width / 2, yPos + (index * 25));
                    });
                    yPos += lines.length * 25 + 20;
                }
                
                // Instru√ß√µes finais
                ctx.fillStyle = '#9aa0a6';
                ctx.font = '16px Inter, sans-serif';
                ctx.fillText('Token: ' + qrToken.substring(0, 16) + '...', finalCanvas.width / 2, yPos + 20);
                
                // Footer
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, finalCanvas.height - 60, finalCanvas.width, 60);
                ctx.fillStyle = '#9aa0a6';
                ctx.font = '14px Inter, sans-serif';
                ctx.fillText('King Forms - Sistema de Confirma√ß√£o de Presen√ßa', finalCanvas.width / 2, finalCanvas.height - 35);
                ctx.fillText('¬© 2026 Conecta King. Todos os direitos reservados.', finalCanvas.width / 2, finalCanvas.height - 15);
                
                // Fazer download
                const link = document.createElement('a');
                const fileName = personName && personName.trim() !== '' 
                    ? `QR-Code-${personName.replace(/[^a-z0-9]/gi, '-')}-${Date.now()}.png`
                    : `QR-Code-${eventTitle.replace(/[^a-z0-9]/gi, '-')}-${Date.now()}.png`;
                link.download = fileName;
                link.href = finalCanvas.toDataURL('image/png', 0.95);
                link.click();
            }
            
            // Desenhar QR Code e fazer download
            if (canvas) {
                drawRemainingContentAndDownload(canvas);
            } else if (img) {
                const imgElement = new Image();
                imgElement.crossOrigin = 'anonymous';
                imgElement.onload = function() {
                    drawRemainingContentAndDownload(imgElement);
                };
                imgElement.onerror = function() {
                    alert('Erro ao carregar imagem do QR Code. Por favor, tente novamente.');
                };
                imgElement.src = img.src;
            }
        }
        
        // Fun√ß√£o para compartilhar QR Code via WhatsApp
        function shareQRCode() {
            const container = document.getElementById('qrcode-container');
            if (!container) return;
            
            const canvas = container.querySelector('canvas');
            const img = container.querySelector('img');
            if (!canvas && !img) return;
            
            const qrCodeImage = canvas ? canvas.toDataURL('image/png') : img.src;
            const message = `Ol√°! Este √© meu QR Code de confirma√ß√£o de presen√ßa:\n\n*Evento:* ${eventTitle}${eventDate ? '\n*Data:* ' + eventDate : ''}${eventAddress ? '\n*Local:* ' + eventAddress : ''}\n\nApresente este QR Code na portaria.`;
            
            // Converter imagem para base64 e enviar via WhatsApp
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // Fun√ß√£o para baixar QR Code como PDF (premium design com nome da pessoa)
        function downloadQRCodePDF() {
            // Aguardar carregamento da biblioteca PDF
            function tryDownloadPDF() {
                // Verificar m√∫ltiplas formas de acesso √† biblioteca jsPDF
                let jsPDFLib = null;
                if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                    jsPDFLib = window.jspdf.jsPDF;
                } else if (typeof window.jspdf !== 'undefined' && window.jspdf.default) {
                    jsPDFLib = window.jspdf.default;
                } else if (typeof jsPDF !== 'undefined') {
                    jsPDFLib = jsPDF;
                } else if (typeof window.jsPDF !== 'undefined') {
                    jsPDFLib = window.jsPDF;
                }
                
                if (!jsPDFLib) {
                    // Tentar novamente ap√≥s um delay
                    setTimeout(tryDownloadPDF, 200);
                    return;
                }
                
                const container = document.getElementById('qrcode-container');
                if (!container) return;
                
                const canvas = container.querySelector('canvas');
                const img = container.querySelector('img');
                if (!canvas && !img) return;
                
                const qrCodeImage = canvas ? canvas.toDataURL('image/png') : img.src;
                const doc = new jsPDFLib({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [210, 297] // A4
                });
                
                // Cores
                const primaryRgb = hexToRgb(primaryColor);
                const secondaryRgb = hexToRgb(secondaryColor);
                
                // Header com gradiente (estilo Simpla)
                doc.setFillColor(primaryRgb.r, primaryRgb.g, primaryRgb.b);
                doc.rect(0, 0, 210, 50, 'F');
                
                // T√≠tulo no header
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(26);
                doc.setFont('helvetica', 'bold');
                doc.text('Confirma√ß√£o de Presen√ßa', 105, 20, { align: 'center' });
                
                // Subt√≠tulo
                doc.setFontSize(12);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'normal');
                doc.text('Apresente este QR Code na portaria', 105, 30, { align: 'center' });
                
                // Nome da pessoa (se dispon√≠vel) - estilo Simpla
                let yPos = 65;
                if (personName && personName.trim() !== '') {
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text(personName, 105, yPos, { align: 'center', maxWidth: 190 });
                    yPos += 15;
                }
                
                // QR Code centralizado
                const qrSize = 80; // mm
                const qrX = (210 - qrSize) / 2;
                doc.addImage(qrCodeImage, 'PNG', qrX, yPos, qrSize, qrSize);
                
                yPos += qrSize + 20;
                
                // Informa√ß√µes do Evento
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(eventTitle, 105, yPos, { align: 'center', maxWidth: 190 });
                yPos += 12;
                
                if (eventDate) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(95, 99, 104);
                    doc.text('üìÖ ' + eventDate, 105, yPos, { align: 'center', maxWidth: 190 });
                    yPos += 10;
                }
                
                if (eventAddress) {
                    doc.setFontSize(11);
                    doc.setTextColor(95, 99, 104);
                    doc.text('üìç ' + eventAddress, 105, yPos, { align: 'center', maxWidth: 180 });
                    yPos += 15;
                }
                
                // Instru√ß√µes
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Token: ' + qrToken.substring(0, 16) + '...', 105, yPos + 10, { align: 'center' });
                
                // Footer
                doc.setFillColor(248, 249, 250);
                doc.rect(0, 280, 210, 17, 'F');
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('King Forms - Sistema de Confirma√ß√£o de Presen√ßa', 105, 288, { align: 'center' });
                doc.text('¬© 2026 Conecta King. Todos os direitos reservados.', 105, 293, { align: 'center' });
                
                // Salvar
                const fileName = personName && personName.trim() !== '' 
                    ? `QR-Code-${personName.replace(/[^a-z0-9]/gi, '-')}-${Date.now()}.pdf`
                    : `QR-Code-${eventTitle.replace(/[^a-z0-9]/gi, '-')}-${Date.now()}.pdf`;
                doc.save(fileName);
            }
            
            // Iniciar tentativa de download
            tryDownloadPDF();
        }
        
        // Fun√ß√£o auxiliar para converter hex para RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 74, g: 144, b: 226 };
        }
        
        // Aguardar carregamento da biblioteca PDF
        let pdfLibraryLoaded = false;
        function checkPDFLibrary() {
            if (typeof window.jspdf !== 'undefined' || typeof jsPDF !== 'undefined' || typeof window.jsPDF !== 'undefined') {
                pdfLibraryLoaded = true;
                return true;
            }
            return false;
        }
        
        // Verificar periodicamente se a biblioteca foi carregada
        let pdfCheckAttempts = 0;
        const maxPDFCheckAttempts = 50;
        function waitForPDFLibrary() {
            pdfCheckAttempts++;
            if (checkPDFLibrary() || pdfCheckAttempts >= maxPDFCheckAttempts) {
                pdfLibraryLoaded = true;
                return;
            }
            setTimeout(waitForPDFLibrary, 200);
        }
        
        // Iniciar verifica√ß√£o quando a p√°gina carregar
        if (document.readyState === 'loading') {
            window.addEventListener('load', waitForPDFLibrary);
        } else {
            waitForPDFLibrary();
        }
        <% } %>
    </script>
</body>
</html>
