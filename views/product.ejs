<!DOCTYPE html>
<html lang="pt-BR" style="background-color: <%= details.background_color || '#0D0D0F' %>;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title><%= product.name %> - <%= details.display_name || 'Conecta King' %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Lora:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="stylesheet" href="/css/profile.css?v=<%= cacheBuster %>">
    
    <meta property="og:title" content="<%= product.name %>">
    <meta property="og:description" content="<%= product.description || product.name %>">
    <% 
    // URL completa da imagem para Open Graph
    const imageUrl = product.image_url || details.profile_image_url;
    const fullImageUrl = imageUrl && !imageUrl.startsWith('http') ? `${typeof baseUrl !== 'undefined' ? baseUrl : ''}${imageUrl}` : imageUrl;
    %>
    <meta property="og:image" content="<%= fullImageUrl || '' %>">
    <meta property="og:url" content="<%= typeof baseUrl !== 'undefined' ? baseUrl : '' %>/<%= typeof slug !== 'undefined' ? slug : '' %>/produto/<%= product.id %>">
    <meta property="og:type" content="product">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="<%= product.name %>">
    <meta name="twitter:description" content="<%= product.description || product.name %>">
    <meta name="twitter:image" content="<%= fullImageUrl || '' %>">

    <style>
        body, h1, p, span { font-family: '<%= details.font_family || "Inter" %>', sans-serif !important; }
        
        .product-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .product-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .product-image-container {
            width: 100%;
            max-width: 680px;
            margin: 0 auto 2rem;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            background: rgba(var(--card-r), var(--card-g), var(--card-b), var(--card-opacity));
            padding: 16px;
            position: relative;
        }
        
        .product-image-gallery {
            position: relative;
            width: 100%;
            max-height: 520px;
            overflow: hidden;
            border-radius: 12px;
            background: #0D0D0F;
        }
        
        .product-image-wrapper {
            display: flex;
            transition: transform 0.3s ease;
            width: <%= typeof allImages !== 'undefined' && allImages.length > 0 ? allImages.length * 100 : 100 %>%;
        }
        
        .product-image-slide {
            width: <%= typeof allImages !== 'undefined' && allImages.length > 0 ? 100 / allImages.length : 100 %>%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .product-image {
            width: 100%;
            max-height: 520px;
            display: block;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 10;
            transition: all 0.2s;
        }
        
        .gallery-nav:hover {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .gallery-nav.prev {
            left: 10px;
        }
        
        .gallery-nav.next {
            right: 10px;
        }
        
        .gallery-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .gallery-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }
        
        .gallery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .gallery-dot.active {
            background: rgba(255, 255, 255, 0.9);
            width: 24px;
            border-radius: 4px;
        }
        
        .product-info {
            background: rgba(var(--card-r), var(--card-g), var(--card-b), var(--card-opacity));
            border-radius: 16px;
            padding: 2.5rem;
            margin-bottom: 2rem;
        }
        
        .product-name {
            font-size: 2rem;
            font-weight: 700;
            color: <%= details.text_color || '#ECECEC' %>;
            margin: 0 0 1rem 0;
            line-height: 1.3;
        }
        
        .product-price {
            font-size: 2.5rem;
            font-weight: 800;
            color: <%= details.button_color || '#141417' %>;
            margin: 1.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .product-price::before {
            content: 'R$';
            font-size: 1.5rem;
            opacity: 0.8;
        }
        
        .product-description {
            font-size: 1.1rem;
            line-height: 1.8;
            color: <%= details.text_color || '#ECECEC' %>;
            opacity: 0.9;
            margin: 1.5rem 0 0 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 14px 28px;
            background: rgba(var(--btn-r), var(--btn-g), var(--btn-b), var(--btn-opacity));
            color: <%= details.button_text_color || '#FFFFFF' %>;
            text-decoration: none;
            border-radius: var(--btn-border-radius);
            font-weight: 600;
            font-size: var(--btn-font-size);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .back-button i {
            font-size: 1rem;
        }
        
        .product-add-to-cart-block {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .product-qty-row {
            margin-bottom: 1rem;
        }
        
        .product-qty-row label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: <%= details.text_color || '#ECECEC' %>;
            margin-bottom: 0.5rem;
        }
        
        .product-qty-input {
            width: 100%;
            max-width: 100px;
            padding: 10px 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: <%= details.text_color || '#ECECEC' %>;
            font-size: 1rem;
        }
        
        .add-to-cart-btn-product {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 24px;
            background: rgba(var(--btn-r), var(--btn-g), var(--btn-b), var(--btn-opacity));
            color: <%= details.button_text_color || '#FFFFFF' %>;
            border: none;
            border-radius: var(--btn-border-radius);
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .add-to-cart-btn-product:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .product-cart-added-msg {
            margin-top: 1rem;
            font-size: 1rem;
            color: <%= details.text_color || '#ECECEC' %>;
        }
        
        .product-cart-added-msg a {
            color: <%= details.button_color || '#FFC700' %>;
            font-weight: 600;
            text-decoration: underline;
        }
        
            @media (max-width: 768px) {
            .product-add-to-cart-block {
                margin-top: 1.5rem;
                padding-top: 1.25rem;
            }
            .add-to-cart-btn-product {
                padding: 12px 20px;
                font-size: 1rem;
            }
            .product-container {
                padding: 1rem;
            }
            
            .product-name {
                font-size: 1.5rem;
            }
            
            .product-price {
                font-size: 2rem;
            }
            
            .product-info {
                padding: 1.5rem;
            }
            
            .product-description {
                font-size: 1rem;
            }
        }
        
        :root {
            --btn-r: <%= (details.button_color_rgb && details.button_color_rgb.r) || 20 %>;
            --btn-g: <%= (details.button_color_rgb && details.button_color_rgb.g) || 20 %>;
            --btn-b: <%= (details.button_color_rgb && details.button_color_rgb.b) || 23 %>;
            --btn-opacity: <%= details.button_opacity !== undefined ? details.button_opacity : 1 %>;
            --btn-border-radius: <%= details.button_border_radius || '12px' %>;
            --card-r: <%= (details.card_color_rgb && details.card_color_rgb.r) || 20 %>;
            --card-g: <%= (details.card_color_rgb && details.card_color_rgb.g) || 20 %>;
            --card-b: <%= (details.card_color_rgb && details.card_color_rgb.b) || 23 %>;
            --card-opacity: <%= details.card_opacity !== undefined ? details.card_opacity : 1.0 %>;
            --btn-font-size: <%= details.button_font_size || '1rem' %>;
        }
    </style>
</head>
<body>
    <div class="product-container">
        <div class="product-header">
            <% if (typeof allImages !== 'undefined' && allImages.length > 0) { %>
            <div class="product-image-container">
                <div class="product-image-gallery" id="product-gallery">
                    <button class="gallery-nav prev" id="gallery-prev" <%= allImages.length <= 1 ? 'style="display: none;"' : '' %>>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="product-image-wrapper" id="gallery-wrapper">
                        <% allImages.forEach((imgUrl, index) => { %>
                        <div class="product-image-slide">
                            <img src="<%= imgUrl %>" alt="<%= product.name %> - Imagem <%= index + 1 %>" class="product-image" loading="<%= index === 0 ? 'eager' : 'lazy' %>">
                        </div>
                        <% }); %>
                    </div>
                    <button class="gallery-nav next" id="gallery-next" <%= allImages.length <= 1 ? 'style="display: none;"' : '' %>>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <% if (allImages.length > 1) { %>
                    <div class="gallery-dots" id="gallery-dots">
                        <% allImages.forEach((imgUrl, index) => { %>
                        <button class="gallery-dot <%= index === 0 ? 'active' : '' %>" data-index="<%= index %>"></button>
                        <% }); %>
                    </div>
                    <% } %>
                </div>
            </div>
            <% } %>
        </div>
        
        <div class="product-info">
            <h1 class="product-name"><%= product.name %></h1>
            
            <div class="product-price">
                <%= new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(parseFloat(product.price)) %>
            </div>
            
            <% if (product.description) { %>
            <p class="product-description"><%= product.description %></p>
            <% } %>
            
            <% if (product.youtube_video_url) { %>
            <div class="product-video-block" style="margin-top: 1.5rem;">
                <button type="button" class="btn-watch-video-product btn-watch-video" data-video-url="<%= (product.youtube_video_url || '').replace(/"/g, '&quot;') %>" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: transparent; color: #ff0000; border: 1px solid rgba(255,0,0,0.5); border-radius: 10px; font-weight: 600; cursor: pointer;">
                    <i class="fab fa-youtube"></i> Veja o vídeo para mais explicação desse produto
                </button>
            </div>
            <% } %>
            <% if (typeof isSalesPageProduct !== 'undefined' && isSalesPageProduct && typeof salesPageData !== 'undefined' && salesPageData) { %>
            <div class="product-add-to-cart-block" id="product-add-to-cart-block">
                <div class="product-qty-row">
                    <label for="product-qty">Quantidade</label>
                    <input type="number" id="product-qty" min="1" value="1" class="product-qty-input">
                </div>
                <button type="button" class="add-to-cart-btn-product" id="product-add-to-cart-btn" data-product-id="<%= product.id %>">
                    <i class="fas fa-cart-plus"></i> Adicionar ao carrinho
                </button>
                <p class="product-cart-added-msg" id="product-cart-added-msg" style="display: none;">
                    Adicionado! <a href="<%= profileUrl %>" id="product-goto-cart-link">Ir para o carrinho</a>
                </p>
            </div>
            <% } %>
        </div>
        
        <div style="text-align: center;">
            <a href="<%= profileUrl %>" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <%= typeof backButtonText !== 'undefined' ? backButtonText : 'Voltar ao Catálogo' %>
            </a>
        </div>
    </div>
    
    <% if (typeof allImages !== 'undefined' && allImages.length > 1) { %>
    <script>
        (function() {
            const gallery = document.getElementById('product-gallery');
            const wrapper = document.getElementById('gallery-wrapper');
            const prevBtn = document.getElementById('gallery-prev');
            const nextBtn = document.getElementById('gallery-next');
            const dots = document.querySelectorAll('.gallery-dot');
            let currentIndex = 0;
            const totalImages = <%= allImages.length %>;
            
            function updateGallery() {
                const translateX = -(currentIndex * (100 / totalImages));
                wrapper.style.transform = `translateX(${translateX}%)`;
                
                // Atualizar dots
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentIndex);
                });
                
                // Atualizar botões
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex === totalImages - 1;
            }
            
            prevBtn?.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateGallery();
                }
            });
            
            nextBtn?.addEventListener('click', () => {
                if (currentIndex < totalImages - 1) {
                    currentIndex++;
                    updateGallery();
                }
            });
            
            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    currentIndex = index;
                    updateGallery();
                });
            });
            
            // Suporte a teclado
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && currentIndex > 0) {
                    currentIndex--;
                    updateGallery();
                } else if (e.key === 'ArrowRight' && currentIndex < totalImages - 1) {
                    currentIndex++;
                    updateGallery();
                }
            });
        })();
    </script>
    <% } %>
    
    <% if (product.youtube_video_url) { %>
    <div class="product-video-overlay" id="product-video-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div class="product-video-modal" style="position: relative; width: 100%; max-width: 900px; aspect-ratio: 16/9;">
            <button type="button" class="product-video-close" id="product-video-close" style="position: absolute; top: -44px; right: 0; background: #1C1C21; border: 1px solid #2C2C2F; color: #ECECEC; width: 40px; height: 40px; border-radius: 8px; cursor: pointer;"><i class="fas fa-times"></i></button>
            <div class="product-video-wrap" style="width: 100%; height: 100%; border-radius: 12px; overflow: hidden; background: #000;">
                <iframe id="product-video-iframe" title="Vídeo do produto" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>
    <script>
        (function() {
            function getYouTubeVideoId(url) {
                if (!url || typeof url !== 'string') return null;
                var u = url.trim();
                var m = u.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
                return m ? m[1] : null;
            }
            document.addEventListener('click', function(e) {
                var btn = e.target.closest('.btn-watch-video');
                if (!btn) return;
                e.preventDefault();
                var url = btn.dataset.videoUrl;
                var videoId = getYouTubeVideoId(url);
                var overlay = document.getElementById('product-video-overlay');
                var iframe = document.getElementById('product-video-iframe');
                if (!overlay || !iframe) return;
                if (videoId) {
                    iframe.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1';
                    overlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } else if (url) { window.open(url, '_blank'); }
            });
            var videoClose = document.getElementById('product-video-close');
            var videoOverlay = document.getElementById('product-video-overlay');
            if (videoClose && videoOverlay) {
                function closeVideo() {
                    var ifr = document.getElementById('product-video-iframe');
                    if (ifr) ifr.src = '';
                    videoOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                }
                videoClose.addEventListener('click', closeVideo);
                videoOverlay.addEventListener('click', function(e) { if (e.target === videoOverlay) closeVideo(); });
            }
        })();
    </script>
    <% } %>
    
    <% if (typeof isSalesPageProduct !== 'undefined' && isSalesPageProduct && typeof salesPageData !== 'undefined' && salesPageData) { %>
    <script>
        (function() {
            const CART_KEY = 'sales_page_cart_<%= salesPageData.id %>';
            const product = {
                id: String(<%= product.id %>),
                name: <%= JSON.stringify(product.name || '') %>,
                price: parseFloat(<%= typeof product.price === 'number' ? product.price : parseFloat(product.price) || 0 %>),
                image: <%= JSON.stringify((product.image_url || (typeof allImages !== 'undefined' && allImages.length ? allImages[0] : '') || '') ) %>
            };
            const btn = document.getElementById('product-add-to-cart-btn');
            const qtyInput = document.getElementById('product-qty');
            const msgEl = document.getElementById('product-cart-added-msg');
            
            if (!btn) return;
            
            function getCart() {
                try {
                    const raw = localStorage.getItem(CART_KEY);
                    if (!raw) return { items: [], total: 0 };
                    const c = JSON.parse(raw);
                    return c && Array.isArray(c.items) ? c : { items: [], total: 0 };
                } catch (e) {
                    return { items: [], total: 0 };
                }
            }
            function saveCart(cart) {
                if (!cart.items) cart.items = [];
                cart.total = cart.items.reduce(function(s, i) { return s + i.price * i.quantity; }, 0);
                localStorage.setItem(CART_KEY, JSON.stringify(cart));
            }
            
            btn.addEventListener('click', function() {
                var qty = 1;
                if (qtyInput) {
                    var v = parseInt(qtyInput.value, 10);
                    if (v > 0) qty = v;
                }
                var cart = getCart();
                var found = cart.items.filter(function(i) { return i.id === product.id; })[0];
                if (found) {
                    found.quantity += qty;
                } else {
                    cart.items.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        image: product.image,
                        quantity: qty
                    });
                }
                saveCart(cart);
                
                var origHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Adicionado!';
                btn.disabled = true;
                if (msgEl) msgEl.style.display = 'block';
                setTimeout(function() {
                    btn.innerHTML = origHtml;
                    btn.disabled = false;
                }, 1800);
            });
        })();
    </script>
    <% } %>
</body>
</html>

