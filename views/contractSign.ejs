<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assinar Contrato: <%= contract.title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.9/dist/signature_pad.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #991B1B 0%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
            color: #FFFFFF;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(28, 28, 33, 0.95);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #FFC700;
        }
        
        .header p {
            color: #888888;
            font-size: 1rem;
        }
        
        .contract-preview {
            background: #1C1C21;
            border: 2px solid #2C2C2F;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .contract-preview h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #FFC700;
        }
        
        .contract-content {
            white-space: pre-wrap;
            line-height: 1.8;
            color: #ECECEC;
        }
        
        .signature-section {
            background: #1C1C21;
            border: 2px solid #2C2C2F;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .signature-section h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #FFC700;
        }
        
        .signature-methods {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .signature-method {
            background: #0B0B0B;
            border: 2px solid #2C2C2F;
            border-radius: 8px;
            padding: 20px;
        }
        
        .signature-method.active {
            border-color: #FFC700;
        }
        
        .signature-method h4 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #FFFFFF;
        }
        
        .signature-canvas-container {
            border: 2px dashed #2C2C2F;
            border-radius: 8px;
            padding: 15px;
            background: #FFFFFF;
            margin-bottom: 15px;
        }
        
        .signature-canvas {
            width: 100%;
            height: 200px;
            border: none;
            cursor: crosshair;
        }
        
        .canvas-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-upload-container {
            margin-top: 10px;
        }
        
        .signature-typed-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border: 2px solid #2C2C2F;
            border-radius: 8px;
            background: #0B0B0B;
            color: #FFFFFF;
            font-family: 'Inter', sans-serif;
            text-align: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #FFC700;
            color: #000000;
        }
        
        .btn-primary:hover {
            background: #FFD700;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 199, 0, 0.3);
        }
        
        .btn-secondary {
            background: #2C2C2F;
            color: #FFFFFF;
        }
        
        .btn-secondary:hover {
            background: #3C3C3F;
        }
        
        .btn-danger {
            background: #991B1B;
            color: #FFFFFF;
        }
        
        .btn-danger:hover {
            background: #B91C1C;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ECECEC;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #2C2C2F;
            border-radius: 8px;
            background: #0B0B0B;
            color: #FFFFFF;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            color: #ECECEC;
            cursor: pointer;
            margin: 0;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22C55E;
            color: #22C55E;
        }
        
        .alert-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #EF4444;
            color: #EF4444;
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3B82F6;
            color: #3B82F6;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .contract-preview {
                padding: 20px;
                max-height: 400px;
            }
            
            .signature-section {
                padding: 20px;
            }
            
            .signature-canvas {
                height: 150px;
            }
            
            .signature-methods {
                gap: 15px;
            }
            
            .signature-method {
                padding: 15px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .actions .btn {
                width: 100%;
            }
            
            #verification-code {
                font-size: 1.2rem;
                padding: 12px;
            }
            
            .signature-typed-input {
                font-size: 1rem;
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .contract-preview {
                padding: 15px;
                max-height: 300px;
            }
            
            .signature-canvas {
                height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-contract"></i> Assinar Contrato</h1>
            <p>Você foi convidado para assinar: <strong><%= contract.title %></strong></p>
            <% if (signer.signed_at) { %>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Este contrato já foi assinado em <%= new Date(signer.signed_at).toLocaleString('pt-BR') %>
                </div>
            <% } %>
        </div>
        
        <div class="contract-preview">
            <h2>Visualização do Contrato</h2>
            <div class="contract-content"><%= contract.pdf_content || 'Conteúdo do contrato não disponível' %></div>
        </div>
        
        <% if (!signer.signed_at) { %>
        <!-- Verificação de Código -->
        <% if (!signer.verification_code_verified && signer.verification_code) { %>
        <div class="verification-section" id="verification-section" style="background: #1C1C21; border: 2px solid #2C2C2F; border-radius: 12px; padding: 30px; margin-bottom: 30px;">
            <h3 style="color: #FFC700; margin-bottom: 20px;"><i class="fas fa-shield-alt"></i> Verificação de Identidade</h3>
            <p style="color: #ECECEC; margin-bottom: 20px;">Um código de verificação foi enviado para <strong><%= signer.email %></strong>. Digite o código abaixo para continuar.</p>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="verification-code" placeholder="000000" maxlength="6" style="flex: 1; padding: 15px; font-size: 1.5rem; text-align: center; letter-spacing: 8px; border: 2px solid #2C2C2F; border-radius: 8px; background: #0B0B0B; color: #FFFFFF; font-family: 'Courier New', monospace;">
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="verify-code-btn" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-check"></i> Verificar Código
                </button>
                <button id="resend-code-btn" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> Reenviar
                </button>
            </div>
            <div id="verification-error" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; border-radius: 8px; padding: 15px; color: #EF4444; margin-top: 15px;"></div>
        </div>
        <% } %>
        
        <div class="signature-section" id="signature-section" style="display: <%= signer.verification_code_verified || !signer.verification_code ? 'block' : 'none' %>;">
            <h3><i class="fas fa-signature"></i> Assinatura Eletrônica</h3>
            
            <div class="signature-methods">
                <!-- Método 1: Desenhar no Canvas -->
                <div class="signature-method active" id="canvas-method">
                    <h4><i class="fas fa-pencil-alt"></i> Assinar Desenhando</h4>
                    <div class="signature-canvas-container">
                        <canvas id="signature-canvas" class="signature-canvas"></canvas>
                    </div>
                    <div class="canvas-controls">
                        <button type="button" class="btn btn-secondary" id="clear-canvas">
                            <i class="fas fa-undo"></i> Limpar
                        </button>
                    </div>
                </div>
                
                <!-- Método 2: Upload de Imagem -->
                <div class="signature-method" id="upload-method">
                    <h4><i class="fas fa-upload"></i> Enviar Imagem da Assinatura</h4>
                    <div class="signature-upload-container">
                        <input type="file" id="signature-upload" accept="image/png,image/jpeg,image/jpg" class="form-control">
                        <div id="signature-upload-preview" style="margin-top: 15px; display: none;">
                            <img id="uploaded-signature" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                        </div>
                    </div>
                </div>
                
                <!-- Método 3: Digitar Nome -->
                <div class="signature-method" id="typed-method">
                    <h4><i class="fas fa-keyboard"></i> Digitar Nome</h4>
                    <input type="text" id="signature-typed" class="signature-typed-input" placeholder="Digite seu nome completo">
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="accept-terms" required>
                <label for="accept-terms">
                    Eu aceito e concordo com os termos deste contrato. Esta assinatura tem validade legal.
                </label>
            </div>
            
            <div class="actions">
                <button type="button" class="btn btn-secondary" id="cancel-btn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="submit-signature-btn">
                    <i class="fas fa-check"></i> Confirmar Assinatura
                </button>
            </div>
        </div>
        <% } %>
    </div>
    
    <script>
        const signToken = '<%= signToken %>';
        const contractId = <%= contract.id %>;
        let signaturePad = null;
        let currentSignatureMethod = 'canvas';
        let uploadedSignatureData = null;
        let verificationRequired = <%= signer.verification_code && !signer.verification_code_verified ? 'true' : 'false' %>;
        
        // Inicializar Signature Pad (canvas)
        document.addEventListener('DOMContentLoaded', function() {
            // Verificação de código
            if (verificationRequired) {
                const verificationCodeInput = document.getElementById('verification-code');
                const verifyBtn = document.getElementById('verify-code-btn');
                const resendBtn = document.getElementById('resend-code-btn');
                const errorDiv = document.getElementById('verification-error');
                
                // Auto-focus no campo de código
                verificationCodeInput.focus();
                
                // Permitir apenas números
                verificationCodeInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
                
                // Verificar código
                verifyBtn.addEventListener('click', async function() {
                    const code = verificationCodeInput.value.trim();
                    if (code.length !== 6) {
                        errorDiv.textContent = 'Por favor, digite o código completo (6 dígitos)';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    verifyBtn.disabled = true;
                    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
                    errorDiv.style.display = 'none';
                    
                    try {
                        const response = await fetch(`/api/contracts/sign/${signToken}/verify-code`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Esconder seção de verificação e mostrar assinatura
                            document.getElementById('verification-section').style.display = 'none';
                            document.getElementById('signature-section').style.display = 'block';
                            verificationRequired = false;
                        } else {
                            errorDiv.textContent = result.error?.message || 'Código inválido';
                            errorDiv.style.display = 'block';
                            verifyBtn.disabled = false;
                            verifyBtn.innerHTML = '<i class="fas fa-check"></i> Verificar Código';
                        }
                    } catch (error) {
                        errorDiv.textContent = 'Erro ao verificar código. Tente novamente.';
                        errorDiv.style.display = 'block';
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '<i class="fas fa-check"></i> Verificar Código';
                    }
                });
                
                // Reenviar código
                resendBtn.addEventListener('click', async function() {
                    resendBtn.disabled = true;
                    resendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                    
                    try {
                        const response = await fetch(`/api/contracts/sign/${signToken}/send-code`, {
                            method: 'POST'
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            alert('✅ Código reenviado com sucesso! Verifique seu email.');
                        } else {
                            alert('Erro ao reenviar código: ' + (result.error?.message || 'Erro desconhecido'));
                        }
                    } catch (error) {
                        alert('Erro ao reenviar código. Tente novamente.');
                    } finally {
                        resendBtn.disabled = false;
                        resendBtn.innerHTML = '<i class="fas fa-redo"></i> Reenviar';
                    }
                });
                
                // Enter para verificar
                verificationCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyBtn.click();
                    }
                });
            }
            
            // Enviar código automaticamente se necessário
            if (verificationRequired) {
                fetch(`/api/contracts/sign/${signToken}/send-code`, {
                    method: 'POST'
                }).catch(err => console.error('Erro ao enviar código:', err));
            }
            const canvas = document.getElementById('signature-canvas');
            if (canvas) {
                signaturePad = new SignaturePad(canvas);
                
                // Ajustar canvas para retina
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext('2d').scale(ratio, ratio);
                signaturePad.clear();
            }
            
            // Registrar acesso
            fetch(`/api/contracts/sign/${signToken}/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).catch(err => console.error('Erro ao registrar acesso:', err));
            
            // Limpar canvas
            document.getElementById('clear-canvas')?.addEventListener('click', function() {
                if (signaturePad) {
                    signaturePad.clear();
                }
            });
            
            // Upload de imagem
            document.getElementById('signature-upload')?.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        uploadedSignatureData = event.target.result;
                        document.getElementById('signature-upload-preview').style.display = 'block';
                        document.getElementById('uploaded-signature').src = event.target.result;
                        currentSignatureMethod = 'upload';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Digitar nome
            document.getElementById('signature-typed')?.addEventListener('input', function() {
                if (this.value.trim()) {
                    currentSignatureMethod = 'typed';
                }
            });
            
            // Trocar método de assinatura
            document.querySelectorAll('.signature-method').forEach(method => {
                method.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
                    document.querySelectorAll('.signature-method').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (this.id === 'canvas-method') currentSignatureMethod = 'canvas';
                    else if (this.id === 'upload-method') currentSignatureMethod = 'upload';
                    else if (this.id === 'typed-method') currentSignatureMethod = 'typed';
                });
            });
            
            // Submeter assinatura
            document.getElementById('submit-signature-btn')?.addEventListener('click', async function() {
                const acceptTerms = document.getElementById('accept-terms');
                if (!acceptTerms.checked) {
                    alert('Você deve aceitar os termos do contrato para continuar.');
                    return;
                }
                
                let signatureData = null;
                let signatureImageUrl = null;
                
                if (currentSignatureMethod === 'canvas') {
                    if (signaturePad.isEmpty()) {
                        alert('Por favor, desenhe sua assinatura no canvas.');
                        return;
                    }
                    signatureData = signaturePad.toDataURL('image/png');
                    signatureImageUrl = signatureData;
                } else if (currentSignatureMethod === 'upload') {
                    if (!uploadedSignatureData) {
                        alert('Por favor, faça upload de uma imagem da sua assinatura.');
                        return;
                    }
                    signatureData = uploadedSignatureData;
                    signatureImageUrl = uploadedSignatureData;
                } else if (currentSignatureMethod === 'typed') {
                    const typedName = document.getElementById('signature-typed').value.trim();
                    if (!typedName) {
                        alert('Por favor, digite seu nome completo.');
                        return;
                    }
                    signatureData = typedName;
                }
                
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                
                try {
                    const response = await fetch(`/api/contracts/sign/${signToken}/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            signature_type: currentSignatureMethod,
                            signature_data: signatureData,
                            signature_image_url: signatureImageUrl
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('✅ Assinatura realizada com sucesso!');
                        window.location.reload();
                    } else {
                        alert('Erro ao assinar: ' + (result.error?.message || 'Erro desconhecido'));
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check"></i> Confirmar Assinatura';
                    }
                } catch (error) {
                    alert('Erro ao assinar: ' + error.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check"></i> Confirmar Assinatura';
                }
            });
        });
    </script>
</body>
</html>
