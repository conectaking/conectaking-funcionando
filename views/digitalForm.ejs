<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title><%= formData.form_title || 'Formul√°rio Digital' %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/css/digitalForm.css">
    <style>
        :root {
            --primary-color: <%= formData.primary_color || '#4A90E2' %>;
            --secondary-color: <%= (formData.secondary_color && formData.secondary_color.trim()) ? formData.secondary_color : (formData.primary_color || '#4A90E2') %>;
            --text-color: <%= formData.text_color || '#333333' %>;
            --background-color: <%= formData.background_color || '#FFFFFF' %>;
            --card-color: <%= formData.card_color || '#FFFFFF' %>;
            --theme: <%= formData.theme || 'light' %>;
        }
        <% if (formData.background_image_url) { %>
        body {
            background-image: url('<%= formData.background_image_url %>');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            <% if (formData.background_color) { %>
            background-color: <%= formData.background_color %>;
            <% } %>
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: <%= formData.background_color || 'rgba(255, 255, 255, 0.95)' %>;
            opacity: <%= 1 - (formData.background_opacity || 1.0) %>;
            z-index: -1;
        }
        <% } %>
        <% if (formData.background_color) { %>
        body {
            background-color: <%= formData.background_color %> !important;
        }
        .digital-form-page {
            background-color: <%= formData.background_color %> !important;
        }
        <% } %>
        <% if (formData.header_image_url) { %>
        .header-image-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }
        .header-image {
            width: 100%;
            height: auto;
            min-height: 280px;
            max-height: 500px;
            object-fit: cover;
            display: block;
        }
        .header-image-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.3));
            pointer-events: none;
        }
        <% } %>
    </style>
</head>
<body class="digital-form-page theme-<%= formData.theme || 'light' %>" data-form-id="<%= item.id %>" data-whatsapp="<%= formData.whatsapp_number || '' %>" style="<% if (formData.background_color && !formData.background_image_url) { %>background-color: <%= formData.background_color %> !important;<% } %>">
    <!-- Header Image -->
    <% if (formData.header_image_url) { %>
    <div class="header-image-container">
        <img src="<%= formData.header_image_url %>" alt="Header" class="header-image">
    </div>
    <% } %>
    
    <!-- Logo fixo no cantinho (se configurado) -->
    <% if (formData.form_logo_url && formData.show_logo_corner) { %>
    <div class="corner-logo" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: var(--card-color, white); padding: 12px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: all 0.3s; max-width: 120px; max-height: 120px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 30px rgba(0,0,0,0.25)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)';">
        <img src="<%= formData.form_logo_url %>" alt="Logo" style="max-width: 100%; max-height: 100%; object-fit: contain; display: block;">
    </div>
    <% } %>
    
    <!-- Header -->
    <header class="form-header">
        <div class="container">
            <% if (typeof profileSlug !== 'undefined' && profileSlug) { %>
            <a href="/<%= profileSlug %>" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Voltar</span>
            </a>
            <% } %>
            <% if (formData.form_logo_url && !formData.show_logo_corner) { %>
            <img src="<%= formData.form_logo_url %>" alt="Logo" class="form-logo">
            <% } %>
            <h1 class="form-title"><%= formData.form_title || 'King Forms' %></h1>
        </div>
    </header>

    <!-- Main Content - Layout Checkout Premium -->
    <main class="form-container">
        <div class="container">
            <div class="checkout-layout">
                <!-- Coluna Principal - Formul√°rio -->
                <div class="checkout-main">
                    <!-- Descri√ß√£o -->
                    <% if (formData.form_description) { %>
                    <div class="form-description">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color, #4A90E2), var(--secondary-color, #4A90E2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text-color, #202124);">Informa√ß√µes</h2>
                        </div>
                        <p style="margin: 0; padding-left: 52px;"><%= formData.form_description %></p>
                    </div>
                    <% } %>

                    <!-- Formul√°rio -->
                    <form id="digital-form" class="digital-form">
                        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e8eaed;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 800; color: var(--text-color, #202124); letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px;">
                                <div style="width: 6px; height: 32px; background: linear-gradient(180deg, var(--primary-color, #4A90E2), var(--secondary-color, #4A90E2)); border-radius: 3px;"></div>
                                Preencha os dados
                            </h2>
                            <p style="margin: 12px 0 0 18px; color: #5f6368; font-size: 14px;">Todos os campos marcados com * s√£o obrigat√≥rios</p>
                        </div>
                        
                        <!-- Campos Din√¢micos (form_fields) -->
                        <div id="dynamic-fields-container"></div>

                        <!-- Bot√£o Enviar (WhatsApp Normal) -->
                        <button type="submit" class="submit-btn" id="form-submit-btn">
                            <i class="fab fa-whatsapp" style="font-size: 22px;"></i>
                            <span>Enviar via WhatsApp</span>
                            <i class="fas fa-arrow-right" style="font-size: 16px; margin-left: auto;"></i>
                        </button>
                    </form>
                    
                    <!-- Bot√£o Enviar Mensagem para o Pastor (Abaixo do formul√°rio) -->
                    <% if (formData.enable_pastor_button && formData.pastor_whatsapp_number) { %>
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e8eaed;">
                        <button type="button" class="submit-btn" id="pastor-message-btn" style="background: linear-gradient(135deg, #FFC700, #FFA500); color: #000; border: none; box-shadow: 0 4px 20px rgba(255, 199, 0, 0.4);">
                            <i class="fas fa-praying-hands" style="font-size: 22px;"></i>
                            <span><%= formData.pastor_button_name || 'Enviar Mensagem para o Pastor' %></span>
                            <i class="fas fa-arrow-right" style="font-size: 16px; margin-left: auto;"></i>
                        </button>
                    </div>
                    <% } %>
                </div>
                
                <!-- Sidebar - Informa√ß√µes Adicionais (Estilo Checkout) -->
                <aside class="checkout-sidebar" style="position: sticky; top: 100px;">
                    <div class="checkout-sidebar-card" style="background: linear-gradient(135deg, var(--card-color, #f8f9fa) 0%, var(--card-color, #ffffff) 100%); border-radius: 20px; padding: 32px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); animation: fadeInUp 0.6s ease-out;">
                        <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #e8eaed;">
                            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700; color: var(--text-color, #202124); display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-shield-alt" style="color: var(--primary-color, #4A90E2);"></i>
                                Seguro e Confi√°vel
                            </h3>
                            <p style="margin: 0; font-size: 13px; color: #5f6368; line-height: 1.6;">Seus dados est√£o protegidos e ser√£o usados apenas para contato.</p>
                        </div>
                        
                        <div style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #e8eaed;">
                            <h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700; color: var(--text-color, #202124); display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-clock" style="color: var(--primary-color, #4A90E2);"></i>
                                Resposta R√°pida
                            </h3>
                            <p style="margin: 0; font-size: 13px; color: #5f6368; line-height: 1.6;">Enviaremos sua mensagem diretamente pelo WhatsApp para um atendimento imediato.</p>
                        </div>
                        
                        <% if (formData.enable_pastor_button && formData.pastor_whatsapp_number) { %>
                        <div style="background: linear-gradient(135deg, rgba(255,199,0,0.15), rgba(255,199,0,0.08)); border-radius: 14px; padding: 20px; border: 2px solid rgba(255,199,0,0.3);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FFC700, #FFA500); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-size: 18px; font-weight: 700;">
                                    <i class="fas fa-praying-hands"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 800; font-size: 15px; color: var(--text-color, #202124);">Enviar Mensagem para o Pastor</div>
                                    <div style="font-size: 12px; color: #5f6368; margin-top: 2px;">Contato direto e pessoal</div>
                                </div>
                            </div>
                            <p style="margin: 0; font-size: 13px; color: #5f6368; line-height: 1.6; font-weight: 500;">Ao clicar em "Enviar", voc√™ ser√° redirecionado para o WhatsApp do pastor com sua mensagem formatada.</p>
                        </div>
                        <% } else { %>
                        <div style="background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(74, 144, 226, 0.05)); border-radius: 14px; padding: 20px; border: 1px solid rgba(74, 144, 226, 0.2);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary-color, #4A90E2), var(--secondary-color, #4A90E2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">
                                    <i class="fab fa-whatsapp"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 700; font-size: 14px; color: var(--text-color, #202124);">Envio via WhatsApp</div>
                                    <div style="font-size: 12px; color: #5f6368; margin-top: 2px;">Resposta instant√¢nea</div>
                                </div>
                            </div>
                            <p style="margin: 0; font-size: 12px; color: #5f6368; line-height: 1.6;">Ao clicar em "Enviar", voc√™ ser√° redirecionado para o WhatsApp com sua mensagem formatada.</p>
                        </div>
                        <% } %>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <script>
        // Dados do formul√°rio
        const formDataObj = <%- JSON.stringify(formData) %>;
        const enablePastorButton = <%= formData.enable_pastor_button || false %>;
        const pastorWhatsappNumber = '<%= formData.pastor_whatsapp_number || '' %>';
        const whatsappNumber = enablePastorButton && pastorWhatsappNumber ? pastorWhatsappNumber : '<%= formData.whatsapp_number || '' %>';
        const itemId = <%= itemId || item.id %>;
        const slug = '<%= typeof profileSlug !== 'undefined' && profileSlug ? profileSlug : slug %>';
        
        // Gerar session ID √∫nico
        let sessionId = sessionStorage.getItem('form_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('form_session_id', sessionId);
        }
        
        // Fun√ß√£o para registrar eventos de analytics
        async function trackEvent(eventType) {
            try {
                await fetch(`/${slug}/form/${itemId}/analytics`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: eventType,
                        session_id: sessionId
                    })
                });
            } catch (error) {
                console.error('Erro ao registrar analytics:', error);
                // N√£o bloquear a experi√™ncia se analytics falhar
            }
        }
        
        // Registrar view quando a p√°gina carregar
        trackEvent('view');
        
        // Registrar start quando o usu√°rio come√ßar a interagir com o formul√°rio
        let formStarted = false;
        document.addEventListener('focusin', function(e) {
            if (e.target.closest('#digital-form') && !formStarted) {
                formStarted = true;
                trackEvent('start');
            }
        }, true);

        // Carregar campos din√¢micos se existirem
        function renderFormFields(containerEl, fields) {
            if (!fields || fields.length === 0) {
                containerEl.innerHTML = '<p style="text-align: center; color: var(--text-color, #666); padding: 40px;">Nenhum campo configurado neste formul√°rio.</p>';
                console.warn('‚ö†Ô∏è [PUBLIC] Nenhum campo para renderizar');
                return;
            }
            
            console.log(`üîÑ [PUBLIC] Renderizando ${fields.length} campos...`);
            containerEl.innerHTML = ''; // Limpar container antes de adicionar
            
            fields.forEach((field, index) => {
                // Normalizar campo (case-insensitive para label)
                const normalizedField = {
                    ...field,
                    label: field.label || field.Label || 'Campo sem t√≠tulo',
                    type: field.type || 'short_text',
                    required: field.required !== undefined ? field.required : (field.Required !== undefined ? field.Required : false),
                    placeholder: field.placeholder || field.Placeholder || '',
                    options: field.options || field.Options || []
                };
                
                const group = document.createElement('div');
                group.className = 'form-group';
                group.dataset.fieldType = normalizedField.type;
                group.dataset.fieldId = normalizedField.id || `field_${index}`;
                
                console.log(`üîÑ [PUBLIC] Processando campo ${index + 1}/${fields.length}:`, normalizedField.label, '- Tipo:', normalizedField.type);
                console.log(`üîç [PUBLIC] Campo completo:`, normalizedField);
                
                let fieldHTML = `<label for="field-${index}">${normalizedField.label} ${normalizedField.required ? '<span class="required">*</span>' : ''}</label>`;
                
                switch(normalizedField.type) {
                    case 'short_text':
                        fieldHTML += `<input type="text" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}">`;
                        break;
                    case 'paragraph':
                        fieldHTML += `<textarea id="field-${index}" name="${normalizedField.id || `field_${index}`}" rows="4" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}"></textarea>`;
                        break;
                    case 'multiple_choice':
                        if (normalizedField.options && normalizedField.options.length > 0) {
                            normalizedField.options.forEach((opt, optIdx) => {
                                fieldHTML += `
                                    <label class="radio-label">
                                        <input type="radio" name="${normalizedField.id || `field_${index}`}" value="${opt}" ${normalizedField.required ? 'required' : ''}>
                                        <span>${opt}</span>
                                    </label>
                                `;
                            });
                        }
                        break;
                    case 'checkbox':
                        if (normalizedField.options && normalizedField.options.length > 0) {
                            normalizedField.options.forEach((opt, optIdx) => {
                                fieldHTML += `
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="${normalizedField.id || `field_${index}`}" value="${opt}">
                                        <span>${opt}</span>
                                    </label>
                                `;
                            });
                        }
                        break;
                    case 'dropdown':
                        fieldHTML += `<select id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}><option value="">Selecione...</option>`;
                        if (normalizedField.options && normalizedField.options.length > 0) {
                            normalizedField.options.forEach(opt => {
                                fieldHTML += `<option value="${opt}">${opt}</option>`;
                            });
                        }
                        fieldHTML += `</select>`;
                        break;
                    case 'yes_no':
                        fieldHTML += `
                            <div class="yes-no-group">
                                <label class="radio-label">
                                    <input type="radio" name="${normalizedField.id || `field_${index}`}" value="sim" ${normalizedField.required ? 'required' : ''}>
                                    <span>Sim</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="${normalizedField.id || `field_${index}`}" value="n√£o" ${normalizedField.required ? 'required' : ''}>
                                    <span>N√£o</span>
                                </label>
                            </div>
                        `;
                        break;
                    case 'date':
                        fieldHTML += `<input type="date" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}>`;
                        break;
                    case 'time':
                        fieldHTML += `<input type="time" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}>`;
                        break;
                    case 'datetime':
                        fieldHTML += `<input type="datetime-local" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}>`;
                        break;
                    case 'email':
                        fieldHTML += `<input type="email" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder || 'exemplo@email.com'}">`;
                        break;
                    case 'number':
                        fieldHTML += `<input type="number" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}" ${normalizedField.min !== undefined ? `min="${normalizedField.min}"` : ''} ${normalizedField.max !== undefined ? `max="${normalizedField.max}"` : ''}>`;
                        break;
                    case 'phone':
                        fieldHTML += `<input type="tel" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder || '(00) 00000-0000'}">`;
                        break;
                    case 'url':
                        fieldHTML += `<input type="url" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder || 'https://exemplo.com'}">`;
                        break;
                    case 'linear_scale':
                        const min = normalizedField.min || field.min || 1;
                        const max = normalizedField.max || field.max || 5;
                        fieldHTML += `<div class="linear-scale-group">`;
                        fieldHTML += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-dark, #666);"><span>${min}</span><span>${max}</span></div>`;
                        for (let i = min; i <= max; i++) {
                            fieldHTML += `
                                <label class="radio-label">
                                    <input type="radio" name="${normalizedField.id || `field_${index}`}" value="${i}" ${normalizedField.required ? 'required' : ''}>
                                    <span>${i}</span>
                                </label>
                            `;
                        }
                        fieldHTML += `</div>`;
                        break;
                    case 'rating':
                        const ratingMax = normalizedField.max || field.max || 5;
                        fieldHTML += `<div class="rating-group">`;
                        for (let i = 1; i <= ratingMax; i++) {
                            fieldHTML += `<input type="radio" name="${normalizedField.id || `field_${index}`}" value="${i}" id="rating-${index}-${i}" ${normalizedField.required ? 'required' : ''}><label for="rating-${index}-${i}">‚òÖ</label>`;
                        }
                        fieldHTML += `</div>`;
                        break;
                    case 'file_upload':
                        fieldHTML += `<input type="file" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} accept="${normalizedField.accept || field.accept || '*/*'}" style="padding: 12px; border: 1.5px solid #dadce0; border-radius: 12px; background: white; cursor: pointer;">`;
                        break;
                    case 'multiple_choice_grid':
                        if ((normalizedField.rows || field.rows) && (normalizedField.columns || field.columns)) {
                            const rows = normalizedField.rows || field.rows;
                            const columns = normalizedField.columns || field.columns;
                            fieldHTML += `<div class="choice-grid" style="overflow-x: auto;">`;
                            fieldHTML += `<table style="width: 100%; border-collapse: collapse; min-width: 500px;">`;
                            fieldHTML += `<thead><tr><th style="padding: 12px; text-align: left; border-bottom: 2px solid #dadce0;"></th>`;
                            columns.forEach(col => {
                                fieldHTML += `<th style="padding: 12px; text-align: center; border-bottom: 2px solid #dadce0;">${col}</th>`;
                            });
                            fieldHTML += `</tr></thead><tbody>`;
                            rows.forEach(row => {
                                fieldHTML += `<tr><td style="padding: 12px; font-weight: 600;">${row}</td>`;
                                columns.forEach(col => {
                                    fieldHTML += `<td style="padding: 12px; text-align: center;"><input type="radio" name="${normalizedField.id || `field_${index}`}_${row}" value="${col}" ${normalizedField.required ? 'required' : ''}></td>`;
                                });
                                fieldHTML += `</tr>`;
                            });
                            fieldHTML += `</tbody></table></div>`;
                        }
                        break;
                    case 'checkbox_grid':
                        if ((normalizedField.rows || field.rows) && (normalizedField.columns || field.columns)) {
                            const rows = normalizedField.rows || field.rows;
                            const columns = normalizedField.columns || field.columns;
                            fieldHTML += `<div class="checkbox-grid" style="overflow-x: auto;">`;
                            fieldHTML += `<table style="width: 100%; border-collapse: collapse; min-width: 500px;">`;
                            fieldHTML += `<thead><tr><th style="padding: 12px; text-align: left; border-bottom: 2px solid #dadce0;"></th>`;
                            columns.forEach(col => {
                                fieldHTML += `<th style="padding: 12px; text-align: center; border-bottom: 2px solid #dadce0;">${col}</th>`;
                            });
                            fieldHTML += `</tr></thead><tbody>`;
                            rows.forEach(row => {
                                fieldHTML += `<tr><td style="padding: 12px; font-weight: 600;">${row}</td>`;
                                columns.forEach(col => {
                                    fieldHTML += `<td style="padding: 12px; text-align: center;"><input type="checkbox" name="${normalizedField.id || `field_${index}`}_${row}" value="${col}"></td>`;
                                });
                                fieldHTML += `</tr>`;
                            });
                            fieldHTML += `</tbody></table></div>`;
                        }
                        break;
                    default:
                        fieldHTML += `<input type="text" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}">`;
                }
                
                group.innerHTML = fieldHTML;
                containerEl.appendChild(group);
                console.log(`‚úÖ [PUBLIC] Campo ${index + 1} renderizado:`, field.label || field.type);
            });
            
            console.log(`‚úÖ [PUBLIC] Todos os ${fields.length} campos foram renderizados com sucesso!`);
            
            // Adicionar classe 'checked' aos labels quando inputs s√£o marcados (fallback para :has())
            setTimeout(() => {
                document.querySelectorAll('.radio-label input[type="radio"], .checkbox-label input[type="checkbox"]').forEach(input => {
                    input.addEventListener('change', function() {
                        // Remover 'checked' de todos os irm√£os do mesmo grupo (para radio)
                        if (this.type === 'radio') {
                            const name = this.name;
                            document.querySelectorAll(`input[type="radio"][name="${name}"]`).forEach(radio => {
                                radio.closest('.radio-label')?.classList.remove('checked');
                            });
                        }
                        // Adicionar/remover 'checked' baseado no estado
                        if (this.checked) {
                            this.closest('.radio-label, .checkbox-label')?.classList.add('checked');
                        } else {
                            this.closest('.checkbox-label')?.classList.remove('checked');
                        }
                    });
                });
            }, 100);
        }
        
        // Inicializar renderiza√ß√£o dos campos
        (function() {
            console.log('üîç [DEBUG] formDataObj completo:', formDataObj);
            console.log('üîç [DEBUG] formDataObj.form_fields (tipo):', typeof formDataObj.form_fields);
            console.log('üîç [DEBUG] formDataObj.form_fields (valor):', formDataObj.form_fields);
            
            let formFields = formDataObj.form_fields || [];
            
            // Garantir que formFields seja um array
            if (typeof formFields === 'string') {
                try {
                    formFields = JSON.parse(formFields);
                } catch (e) {
                    console.error('‚ùå Erro ao parsear form_fields:', e);
                    formFields = [];
                }
            }
            if (!Array.isArray(formFields)) {
                console.warn('‚ö†Ô∏è formFields n√£o √© um array:', typeof formFields, formFields);
                formFields = [];
            }
            
            console.log('‚úÖ Form fields carregados (array):', formFields);
            console.log('‚úÖ Total de campos:', formFields.length);
            console.log('üîç [PUBLIC] formDataObj completo:', formDataObj);
            console.log('üîç [PUBLIC] formFields detalhado:', JSON.stringify(formFields, null, 2));
            
            const container = document.getElementById('dynamic-fields-container');
            
            if (!container) {
                console.error('‚ùå [PUBLIC] Container dynamic-fields-container n√£o encontrado!');
                // Tentar aguardar e tentar novamente
                setTimeout(() => {
                    const containerRetry = document.getElementById('dynamic-fields-container');
                    if (containerRetry && formFields && formFields.length > 0) {
                        console.log('‚úÖ [PUBLIC] Container encontrado no retry, renderizando campos...');
                        renderFormFields(containerRetry, formFields);
                    }
                }, 500);
                return;
            }
            
            renderFormFields(container, formFields);
            
            // Tornar formFields acess√≠vel globalmente para event listeners
            window.formFields = formFields;
        })();

        // Formatar WhatsApp
        function formatWhatsApp(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d+)/, '($1) $2');
            }
            input.value = value;
        }

        const whatsappInput = document.getElementById('form-whatsapp');
        if (whatsappInput) {
            whatsappInput.addEventListener('input', () => formatWhatsApp(whatsappInput));
        }

        // Enviar formul√°rio
        // Fun√ß√£o de valida√ß√£o robusta
        function validateForm() {
            let isValid = true;
            const errors = [];
            
            currentFormFields.forEach((field, index) => {
                const fieldId = field.id || `field_${index}`;
                const fieldLabel = field.label || 'Campo sem t√≠tulo';
                const fieldElement = document.querySelector(`#field-${index}`);
                const fieldGroup = fieldElement?.closest('.form-group');
                
                // Remover estados de erro anteriores
                if (fieldGroup) {
                    fieldGroup.classList.remove('field-error', 'field-valid');
                    const errorMsg = fieldGroup.querySelector('.field-error-message');
                    if (errorMsg) errorMsg.remove();
                }
                
                // Validar campo obrigat√≥rio
                if (field.required) {
                    let fieldValue = '';
                    
                    if (field.type === 'checkbox') {
                        const checked = document.querySelectorAll(`input[name="${fieldId}"]:checked`);
                        fieldValue = checked.length > 0 ? Array.from(checked).map(c => c.value).join(',') : '';
                    } else if (field.type === 'multiple_choice' || field.type === 'yes_no') {
                        const selected = document.querySelector(`input[name="${fieldId}"]:checked`);
                        fieldValue = selected ? selected.value : '';
                    } else if (fieldElement) {
                        fieldValue = fieldElement.value ? fieldElement.value.trim() : '';
                    }
                    
                    if (!fieldValue) {
                        isValid = false;
                        errors.push(`${fieldLabel} √© obrigat√≥rio`);
                        if (fieldGroup) {
                            fieldGroup.classList.add('field-error');
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'field-error-message';
                            errorDiv.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 4px;';
                            errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Este campo √© obrigat√≥rio';
                            fieldGroup.appendChild(errorDiv);
                        }
                    }
                }
                
                // Valida√ß√£o espec√≠fica por tipo
                if (fieldElement && fieldElement.value) {
                    const value = fieldElement.value.trim();
                    
                    // Valida√ß√£o de email
                    if (field.type === 'email' && value) {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(value)) {
                            isValid = false;
                            errors.push(`${fieldLabel} deve ser um email v√°lido`);
                            if (fieldGroup) {
                                fieldGroup.classList.add('field-error');
                                const errorDiv = fieldGroup.querySelector('.field-error-message') || document.createElement('div');
                                errorDiv.className = 'field-error-message';
                                errorDiv.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 4px;';
                                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Email inv√°lido';
                                if (!fieldGroup.querySelector('.field-error-message')) {
                                    fieldGroup.appendChild(errorDiv);
                                }
                            }
                        }
                    }
                    
                    // Valida√ß√£o de telefone
                    if (field.type === 'phone' && value) {
                        const phoneRegex = /^[\d\s\(\)\-\+]{10,}$/;
                        const digitsOnly = value.replace(/\D/g, '');
                        if (digitsOnly.length < 10 || digitsOnly.length > 15) {
                            isValid = false;
                            errors.push(`${fieldLabel} deve ser um telefone v√°lido`);
                            if (fieldGroup) {
                                fieldGroup.classList.add('field-error');
                                const errorDiv = fieldGroup.querySelector('.field-error-message') || document.createElement('div');
                                errorDiv.className = 'field-error-message';
                                errorDiv.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 4px;';
                                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Telefone inv√°lido (m√≠nimo 10 d√≠gitos)';
                                if (!fieldGroup.querySelector('.field-error-message')) {
                                    fieldGroup.appendChild(errorDiv);
                                }
                            }
                        }
                    }
                    
                    // Valida√ß√£o de n√∫mero
                    if (field.type === 'number' && value) {
                        if (isNaN(value)) {
                            isValid = false;
                            errors.push(`${fieldLabel} deve ser um n√∫mero v√°lido`);
                            if (fieldGroup) {
                                fieldGroup.classList.add('field-error');
                            }
                        } else {
                            if (field.min !== undefined && parseFloat(value) < field.min) {
                                isValid = false;
                                errors.push(`${fieldLabel} deve ser no m√≠nimo ${field.min}`);
                            }
                            if (field.max !== undefined && parseFloat(value) > field.max) {
                                isValid = false;
                                errors.push(`${fieldLabel} deve ser no m√°ximo ${field.max}`);
                            }
                        }
                    }
                    
                    // Feedback visual de sucesso
                    if (isValid && fieldGroup && fieldElement.value) {
                        fieldGroup.classList.add('field-valid');
                    }
                }
            });
            
            return { isValid, errors };
        }
        
        // Valida√ß√£o em tempo real
        document.querySelectorAll('#digital-form input, #digital-form textarea, #digital-form select').forEach(input => {
            input.addEventListener('blur', () => {
                const fieldGroup = input.closest('.form-group');
                if (fieldGroup) {
                    const fieldIndex = parseInt(input.id.replace('field-', ''));
                    const field = currentFormFields[fieldIndex];
                    if (field && field.required && !input.value.trim()) {
                        fieldGroup.classList.add('field-error');
                    } else if (fieldGroup.classList.contains('field-error')) {
                        fieldGroup.classList.remove('field-error');
                        fieldGroup.classList.add('field-valid');
                    }
                }
            });
        });
        
        document.getElementById('digital-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!whatsappNumber) {
                alert('N√∫mero do WhatsApp n√£o configurado!');
                return;
            }
            
            // Validar formul√°rio antes de enviar
            const validation = validateForm();
            if (!validation.isValid) {
                // Scroll para o primeiro erro
                const firstError = document.querySelector('.field-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                // Mostrar mensagem de erro
                const submitBtn = document.getElementById('form-submit-btn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Corrija os erros acima';
                submitBtn.style.background = '#d32f2f';
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.style.background = '';
                }, 3000);
                
                return;
            }

            // Coletar dados do formul√°rio
            const formData = new FormData(this);
            const data = {};
            const responseData = {};

            // Obter formFields (pode estar no escopo global)
            let currentFormFields = window.formFields || formDataObj.form_fields || [];
            if (typeof currentFormFields === 'string') {
                try {
                    currentFormFields = JSON.parse(currentFormFields);
                } catch (e) {
                    currentFormFields = [];
                }
            }
            if (!Array.isArray(currentFormFields)) {
                currentFormFields = [];
            }

            // Coletar todos os campos
            for (const [key, value] of formData.entries()) {
                // Verificar se √© um campo din√¢mico
                const field = currentFormFields.find(f => {
                    const fieldId = f.id || `field_${currentFormFields.indexOf(f)}`;
                    return fieldId === key;
                });
                if (field) {
                    if (field.type === 'checkbox') {
                        if (!responseData[key]) responseData[key] = [];
                        responseData[key].push(value);
                    } else {
                        responseData[key] = value;
                    }
                    data[key] = responseData[key];
                } else {
                    data[key] = value;
                }
            }
            
            // Coletar dados de todos os campos din√¢micos
            currentFormFields.forEach((field, index) => {
                const fieldId = field.id || `field_${index}`;
                
                if (field.type === 'checkbox') {
                    // Checkboxes: m√∫ltiplos valores
                    const checkboxes = document.querySelectorAll(`input[name="${fieldId}"]:checked`);
                    if (checkboxes.length > 0) {
                        responseData[fieldId] = Array.from(checkboxes).map(cb => cb.value);
                        data[fieldId] = responseData[fieldId].join(', ');
                    }
                } else if (field.type === 'multiple_choice_grid' || field.type === 'checkbox_grid') {
                    // Grids: estrutura complexa
                    const gridData = {};
                    if (field.rows) {
                        field.rows.forEach(row => {
                            const rowName = `${fieldId}_${row}`;
                            if (field.type === 'multiple_choice_grid') {
                                const selected = document.querySelector(`input[name="${rowName}"]:checked`);
                                if (selected) {
                                    gridData[row] = selected.value;
                                }
                            } else {
                                const selected = document.querySelectorAll(`input[name="${rowName}"]:checked`);
                                if (selected.length > 0) {
                                    gridData[row] = Array.from(selected).map(cb => cb.value);
                                }
                            }
                        });
                        if (Object.keys(gridData).length > 0) {
                            responseData[fieldId] = gridData;
                            // Formatar para WhatsApp
                            let gridText = '';
                            Object.entries(gridData).forEach(([row, value]) => {
                                gridText += `${row}: ${Array.isArray(value) ? value.join(', ') : value}\n`;
                            });
                            data[fieldId] = gridText.trim();
                        }
                    }
                } else if (field.type === 'multiple_choice' || field.type === 'yes_no' || field.type === 'linear_scale' || field.type === 'rating') {
                    // Radio buttons: valor √∫nico
                    const selected = document.querySelector(`input[name="${fieldId}"]:checked`);
                    if (selected) {
                        responseData[fieldId] = selected.value;
                        data[fieldId] = selected.value;
                    }
                } else {
                    // Campos de texto, n√∫mero, data, etc.
                    const input = document.querySelector(`#field-${index}`);
                    if (input && input.value) {
                        responseData[fieldId] = input.value;
                        data[fieldId] = input.value;
                    }
                }
            });
            
            // Enviar para o servidor
            try {
                const submitResponse = await fetch(`/<%= typeof profileSlug !== 'undefined' && profileSlug ? profileSlug : slug %>/form/<%= item.id %>/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        response_data: responseData,
                        responder_name: data.name || null,
                        responder_email: data.email || null,
                        responder_phone: data.phone || null,
                        session_id: sessionId
                    })
                });
                
                if (!submitResponse.ok) {
                    console.error('Erro ao salvar resposta no servidor');
                }
            } catch (error) {
                console.error('Erro ao salvar resposta:', error);
            }

            // Formatando mensagem para WhatsApp
            let message = `*${formDataObj.form_title || 'King Forms'}*\n\n`;
            
            // Adicionar respostas dos campos din√¢micos (currentFormFields j√° foi declarado acima)
            currentFormFields.forEach((field, index) => {
                const fieldId = field.id || `field_${index}`;
                const fieldValue = data[fieldId];
                if (fieldValue) {
                    const fieldLabel = field.label || field.Label || 'Campo';
                    if (Array.isArray(fieldValue)) {
                        message += `*${fieldLabel}:* ${fieldValue.join(', ')}\n`;
                    } else {
                        message += `*${fieldLabel}:* ${fieldValue}\n`;
                    }
                }
            });

            // Limpar n√∫mero do WhatsApp (apenas n√∫meros)
            const cleanWhatsapp = whatsappNumber.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${cleanWhatsapp}?text=${encodeURIComponent(message)}`;
            
            // Abrir WhatsApp
            window.open(whatsappUrl, '_blank');
        });
        
        // Bot√£o "Enviar Mensagem para o Pastor"
        <% if (formData.enable_pastor_button && formData.pastor_whatsapp_number) { %>
        const pastorBtn = document.getElementById('pastor-message-btn');
        if (pastorBtn) {
            pastorBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                
                const pastorWhatsapp = '<%= formData.pastor_whatsapp_number || '' %>';
                if (!pastorWhatsapp) {
                    alert('N√∫mero do WhatsApp do pastor n√£o configurado!');
                    return;
                }
                
                // Validar formul√°rio antes de enviar
                const validation = validateForm();
                if (!validation.isValid) {
                    const firstError = document.querySelector('.field-error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    
                    const submitBtn = document.getElementById('pastor-message-btn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Corrija os erros acima';
                    submitBtn.style.background = '#d32f2f';
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.style.background = '';
                    }, 3000);
                    
                    return;
                }
                
                // Coletar dados do formul√°rio (mesmo processo do bot√£o normal)
                const form = document.getElementById('digital-form');
                const formData = new FormData(form);
                const data = {};
                const responseData = {};
                
                let currentFormFields = window.formFields || formDataObj.form_fields || [];
                if (typeof currentFormFields === 'string') {
                    try {
                        currentFormFields = JSON.parse(currentFormFields);
                    } catch (e) {
                        currentFormFields = [];
                    }
                }
                if (!Array.isArray(currentFormFields)) {
                    currentFormFields = [];
                }
                
                // Coletar todos os campos (mesmo c√≥digo do submit normal)
                for (const [key, value] of formData.entries()) {
                    const field = currentFormFields.find(f => {
                        const fieldId = f.id || `field_${currentFormFields.indexOf(f)}`;
                        return fieldId === key;
                    });
                    if (field) {
                        if (field.type === 'checkbox') {
                            if (!responseData[key]) responseData[key] = [];
                            responseData[key].push(value);
                        } else {
                            responseData[key] = value;
                        }
                        data[key] = responseData[key];
                    } else {
                        data[key] = value;
                    }
                }
                
                currentFormFields.forEach((field, index) => {
                    const fieldId = field.id || `field_${index}`;
                    
                    if (field.type === 'checkbox') {
                        const checkboxes = document.querySelectorAll(`input[name="${fieldId}"]:checked`);
                        if (checkboxes.length > 0) {
                            responseData[fieldId] = Array.from(checkboxes).map(cb => cb.value);
                            data[fieldId] = responseData[fieldId].join(', ');
                        }
                    } else if (field.type === 'multiple_choice' || field.type === 'yes_no' || field.type === 'linear_scale' || field.type === 'rating') {
                        const selected = document.querySelector(`input[name="${fieldId}"]:checked`);
                        if (selected) {
                            responseData[fieldId] = selected.value;
                            data[fieldId] = selected.value;
                        }
                    } else {
                        const input = document.querySelector(`#field-${index}`);
                        if (input && input.value) {
                            responseData[fieldId] = input.value;
                            data[fieldId] = input.value;
                        }
                    }
                });
                
                // Salvar resposta no servidor
                try {
                    const submitResponse = await fetch(`/<%= typeof profileSlug !== 'undefined' && profileSlug ? profileSlug : slug %>/form/<%= item.id %>/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            response_data: responseData,
                            responder_name: data.name || null,
                            responder_email: data.email || null,
                            responder_phone: data.phone || null,
                            session_id: sessionId
                        })
                    });
                    
                    if (!submitResponse.ok) {
                        console.error('Erro ao salvar resposta no servidor');
                    }
                } catch (error) {
                    console.error('Erro ao salvar resposta:', error);
                }
                
                // Formatar mensagem para WhatsApp do Pastor
                let message = `*${formDataObj.form_title || 'King Forms'}*\n\n`;
                message += '*Mensagem para o Pastor*\n\n';
                
                currentFormFields.forEach((field, index) => {
                    const fieldId = field.id || `field_${index}`;
                    const fieldValue = data[fieldId];
                    if (fieldValue) {
                        const fieldLabel = field.label || field.Label || 'Campo';
                        if (Array.isArray(fieldValue)) {
                            message += `*${fieldLabel}:* ${fieldValue.join(', ')}\n`;
                        } else {
                            message += `*${fieldLabel}:* ${fieldValue}\n`;
                        }
                    }
                });
                
                // Limpar n√∫mero do WhatsApp do pastor (apenas n√∫meros)
                const cleanPastorWhatsapp = pastorWhatsapp.replace(/\D/g, '');
                const pastorWhatsappUrl = `https://wa.me/${cleanPastorWhatsapp}?text=${encodeURIComponent(message)}`;
                
                // Abrir WhatsApp do Pastor
                window.open(pastorWhatsappUrl, '_blank');
            });
        }
        <% } %>
    </script>
    
    <!-- Rodap√© com Direitos Autorais -->
    <footer style="margin-top: 60px; padding: 40px 24px; text-align: center; border-top: 1px solid rgba(0,0,0,0.1); background: <%= formData.background_color || 'transparent' %>;">
        <div style="max-width: 1000px; margin: 0 auto;">
            <p style="margin: 0 0 12px 0; color: var(--text-color, #5f6368); font-size: 14px; line-height: 1.6;">
                <strong style="color: var(--primary-color, #4A90E2);">King Forms</strong> √© um sistema desenvolvido pela <strong style="color: var(--primary-color, #4A90E2);">Conecta King</strong>
            </p>
            <p style="margin: 0; color: var(--text-color, #5f6368); font-size: 13px; opacity: 0.8;">
                ¬© <%= new Date().getFullYear() %> Conecta King. Todos os direitos reservados.
            </p>
            <p style="margin: 12px 0 0 0; color: var(--text-color, #5f6368); font-size: 12px; opacity: 0.7;">
                King Forms √© uma solu√ß√£o premium para cria√ß√£o de formul√°rios digitais profissionais.
            </p>
        </div>
    </footer>
</body>
</html>

