<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-timestamp" content="<%= typeof _timestamp !== 'undefined' ? _timestamp : Date.now() %>">
    <meta name="updated-at" content="<%= typeof _updatedAt !== 'undefined' ? _updatedAt : Date.now() %>">
    <title><%= formData.form_title || 'Formul√°rio Digital' %> <%= typeof _cacheBust !== 'undefined' ? _cacheBust : '' %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico<%= typeof _cacheBust !== 'undefined' ? _cacheBust : '' %>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/css/digitalForm.css<%= typeof _cacheBust !== 'undefined' ? _cacheBust : '' %>">
    <style>
        <%
            // LOG NO SERVIDOR (EJS) - Verificar valores recebidos
            console.log('üé® [EJS] Dados recebidos no template:', {
                primary_color: formData.primary_color,
                primary_color_type: typeof formData.primary_color,
                secondary_color: formData.secondary_color,
                secondary_color_type: typeof formData.secondary_color,
                form_title: formData.form_title
            });
            
            // Garantir que secondary_color seja tratado corretamente
            let secondaryColor = formData.secondary_color;
            if (!secondaryColor || 
                secondaryColor === 'null' || 
                secondaryColor === 'undefined' ||
                secondaryColor === null ||
                secondaryColor === undefined ||
                (typeof secondaryColor === 'string' && secondaryColor.trim() === '')) {
                secondaryColor = formData.primary_color || '#4A90E2';
                console.log('‚ö†Ô∏è [EJS] secondary_color estava vazio/null, usando primary_color:', secondaryColor);
            }
            const primaryColor = formData.primary_color || '#4A90E2';
            
            // LOG FINAL DAS CORES QUE SER√ÉO USADAS
            console.log('‚úÖ [EJS] Cores finais que ser√£o aplicadas:', {
                primaryColor: primaryColor,
                secondaryColor: secondaryColor
            });
        %>
        :root {
            --primary-color: <%= primaryColor %>;
            --secondary-color: <%= secondaryColor %>;
            --text-color: <%= formData.text_color || '#333333' %>;
            --background-color: <%= formData.background_color || '#FFFFFF' %>;
            --card-color: <%= formData.card_color || '#FFFFFF' %>;
            --theme: <%= formData.theme || 'light' %>;
        }
        
        /* DEBUG: For√ßar cores diretamente no body para garantir aplica√ß√£o */
        body {
            --primary-color: <%= primaryColor %> !important;
            --secondary-color: <%= secondaryColor %> !important;
        }
        
        /* DEBUG: Log visual das cores aplicadas (descomente para ver) */
        /* body::after {
            content: 'Primary: <%= primaryColor %> | Secondary: <%= secondaryColor %>';
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            font-size: 10px;
            z-index: 99999;
            border-radius: 4px;
        } */
        
        /* Garantir que o header use a cor secund√°ria - FOR√áAR com !important e especificidade */
        header.form-header,
        .form-header {
            background: linear-gradient(135deg, <%= primaryColor %> 0%, <%= secondaryColor %> 100%) !important;
            background-image: linear-gradient(135deg, <%= primaryColor %> 0%, <%= secondaryColor %> 100%) !important;
        }
        
        /* Aplicar gradiente em todos os elementos que usam cor prim√°ria */
        .welcome-section {
            background: linear-gradient(135deg, <%= primaryColor %> 0%, <%= secondaryColor %> 100%) !important;
            background-image: linear-gradient(135deg, <%= primaryColor %> 0%, <%= secondaryColor %> 100%) !important;
        }
        
        .digital-form::before {
            background: linear-gradient(90deg, <%= primaryColor %>, <%= secondaryColor %>) !important;
            background-image: linear-gradient(90deg, <%= primaryColor %>, <%= secondaryColor %>) !important;
        }
        
        /* For√ßar aplica√ß√£o em todos os elementos com gradiente */
        [style*="gradient"] {
            background-image: linear-gradient(135deg, <%= primaryColor %> 0%, <%= secondaryColor %> 100%) !important;
        }
        <% if (formData.background_image_url) { %>
        body {
            background-image: url('<%= formData.background_image_url %>');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            <% if (formData.background_color) { %>
            background-color: <%= formData.background_color %>;
            <% } %>
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: <%= formData.background_color || 'rgba(255, 255, 255, 0.95)' %>;
            opacity: <%= 1 - (formData.background_opacity || 1.0) %>;
            z-index: -1;
        }
        <% } %>
        <% if (formData.background_color) { %>
        body {
            background-color: <%= formData.background_color %> !important;
        }
        .digital-form-page {
            background-color: <%= formData.background_color %> !important;
        }
        <% } %>
        <% if (formData.header_image_url) { %>
        .header-image-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }
        .header-image {
            width: 100%;
            height: auto;
            min-height: 280px;
            max-height: 500px;
            object-fit: cover;
            display: block;
        }
        .header-image-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.3));
            pointer-events: none;
        }
        <% } %>
    </style>
</head>
<body class="digital-form-page theme-<%= formData.theme || 'light' %>" data-form-id="<%= item.id %>" data-whatsapp="<%= formData.whatsapp_number || '' %>" style="<% if (formData.background_color && !formData.background_image_url) { %>background-color: <%= formData.background_color %> !important;<% } %>">
    <!-- Header Image -->
    <% if (formData.header_image_url) { %>
    <div class="header-image-container">
        <img src="<%= formData.header_image_url %>" alt="Header" class="header-image">
    </div>
    <% } %>
    
    <!-- Logo fixo no cantinho (se configurado) -->
    <% if (formData.form_logo_url && formData.show_logo_corner) { %>
    <% 
        // Calcular tamanho da logo no canto (usar button_logo_size se dispon√≠vel, sen√£o usar padr√£o)
        let cornerLogoSize = 80; // Tamanho padr√£o para logo no canto
        if (formData.button_logo_size !== undefined && formData.button_logo_size !== null) {
            const parsed = parseInt(formData.button_logo_size, 10);
            if (!isNaN(parsed) && parsed >= 20 && parsed <= 120) {
                cornerLogoSize = parsed;
            }
        }
        // Para logo no canto, usar um tamanho um pouco maior que o padr√£o
        const cornerContainerSize = Math.max(cornerLogoSize + 24, 100);
    %>
    <div class="corner-logo" style="position: fixed; top: 20px; right: 20px; z-index: 1000; background: var(--card-color, white); padding: 12px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transition: all 0.3s; max-width: <%= cornerContainerSize %>px; max-height: <%= cornerContainerSize %>px; width: <%= cornerContainerSize %>px; height: <%= cornerContainerSize %>px; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 30px rgba(0,0,0,0.25)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.15)';">
        <img src="<%= formData.form_logo_url %>" alt="Logo" style="max-width: <%= cornerLogoSize %>px; max-height: <%= cornerLogoSize %>px; width: auto; height: auto; object-fit: contain; display: block;">
    </div>
    <% } %>
    
    <!-- Header -->
    <header class="form-header" style="background: linear-gradient(135deg, <%= primaryColor %> 0%, <%= secondaryColor %> 100%) !important; background-image: linear-gradient(135deg, <%= primaryColor %> 0%, <%= secondaryColor %> 100%) !important;">
        <div class="container">
            <% if (typeof profileSlug !== 'undefined' && profileSlug) { %>
            <a href="/<%= profileSlug %>" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Voltar</span>
            </a>
            <% } %>
            <% if (formData.form_logo_url && !formData.show_logo_corner) { %>
            <% 
                // Calcular tamanho da logo (usar button_logo_size se dispon√≠vel, sen√£o usar padr√£o)
                let logoSize = 60; // Tamanho padr√£o
                if (formData.button_logo_size !== undefined && formData.button_logo_size !== null) {
                    const parsed = parseInt(formData.button_logo_size, 10);
                    if (!isNaN(parsed) && parsed >= 20 && parsed <= 120) {
                        logoSize = parsed;
                    }
                }
            %>
            <img src="<%= formData.form_logo_url %>" alt="Logo" class="form-logo" style="max-width: <%= logoSize %>px; max-height: <%= logoSize %>px; width: auto; height: auto; object-fit: contain;">
            <% } %>
            <h1 class="form-title"><%= formData.form_title || 'King Forms' %></h1>
        </div>
    </header>

    <!-- Main Content - Layout Checkout Premium -->
    <main class="form-container">
        <div class="container">
            <div class="checkout-layout <%= (formData.enable_pastor_button && formData.pastor_whatsapp_number) ? 'has-sidebar' : '' %>">
                <!-- Coluna Principal - Formul√°rio -->
                <div class="checkout-main">
                    <!-- Informa√ß√µes do Evento (se dispon√≠veis) -->
                    <% if (formData.event_date || formData.event_address) { %>
                    <div class="event-info" style="background: rgba(255,199,0,0.1); border: 2px solid rgba(255,199,0,0.3); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <i class="fas fa-calendar-alt" style="color: <%= secondaryColor || primaryColor || '#FFC700' %>; font-size: 20px;"></i>
                            <h3 style="margin: 0; color: <%= formData.text_color || '#333333' %>; font-size: 18px; font-weight: 700;">Informa√ß√µes do Evento</h3>
                        </div>
                        <% if (formData.event_date) { %>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px;">
                            <i class="fas fa-calendar" style="color: <%= secondaryColor || primaryColor || '#FFC700' %>; font-size: 18px;"></i>
                            <div>
                                <div style="font-weight: 600; color: <%= formData.text_color || '#333333' %>; font-size: 14px; margin-bottom: 4px;">Data do Evento</div>
                                <div style="color: <%= formData.text_color || '#666666' %>; font-size: 16px; font-weight: 600;">
                                    <%= new Date(formData.event_date).toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                                </div>
                            </div>
                        </div>
                        <% } %>
                        <% if (formData.event_address) { %>
                        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px;">
                            <i class="fas fa-map-marker-alt" style="color: <%= secondaryColor || primaryColor || '#FFC700' %>; font-size: 18px; margin-top: 2px;"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: <%= formData.text_color || '#333333' %>; font-size: 14px; margin-bottom: 4px;">Endere√ßo do Evento</div>
                                <div style="color: <%= formData.text_color || '#666666' %>; font-size: 16px; line-height: 1.6;">
                                    <%= formData.event_address %>
                                </div>
                            </div>
                        </div>
                        <% } %>
                    </div>
                    <% } %>
                    
                    <!-- Descri√ß√£o -->
                    <% if (formData.form_description) { %>
                    <div class="form-description">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color, #4A90E2), var(--secondary-color, #4A90E2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <h2 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text-color, #202124);">Informa√ß√µes</h2>
                        </div>
                        <p style="margin: 0; padding-left: 52px;"><%= formData.form_description %></p>
                    </div>
                    <% } %>

                    <!-- Formul√°rio -->
                    <form id="digital-form" class="digital-form">
                        <div style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid #e8eaed;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 800; color: var(--text-color, #202124); letter-spacing: -0.5px; display: flex; align-items: center; gap: 12px;">
                                <div style="width: 6px; height: 32px; background: linear-gradient(180deg, var(--primary-color, #4A90E2), var(--secondary-color, #4A90E2)); border-radius: 3px;"></div>
                                Preencha os dados
                            </h2>
                            <p style="margin: 12px 0 0 18px; color: #5f6368; font-size: 14px;">Todos os campos marcados com * s√£o obrigat√≥rios</p>
                        </div>
                        
                        <!-- Campos Din√¢micos (form_fields) -->
                        <div id="dynamic-fields-container"></div>

                        <!-- Bot√µes de Envio (Din√¢micos baseado nas op√ß√µes) -->
                        <% 
                            // IMPORTANTE: Garantir que enable_guest_list_submit seja sempre booleano
                            const enableGuestListSubmitRaw = formData.enable_guest_list_submit;
                            const enableGuestListSubmitValue = enableGuestListSubmitRaw === true || enableGuestListSubmitRaw === 'true' || enableGuestListSubmitRaw === 1 || enableGuestListSubmitRaw === '1';
                            
                            // LOG para debug
                            console.log('üîò [EJS] Bot√µes - enable_guest_list_submit:', {
                                raw: enableGuestListSubmitRaw,
                                tipo: typeof enableGuestListSubmitRaw,
                                value: enableGuestListSubmitValue,
                                enable_whatsapp_raw: formData.enable_whatsapp
                            });
                            
                            // IMPORTANTE: Se "Salvar na Lista" est√° ativo, WhatsApp deve ser false
                            // Porque "Salvar na Lista" significa enviar s√≥ para o sistema (sem WhatsApp)
                            const enableWhatsappValue = enableGuestListSubmitValue ? false : (formData.enable_whatsapp === true || formData.enable_whatsapp === 'true' || formData.enable_whatsapp === 1 || formData.enable_whatsapp === '1');
                        %>
                        
                        <!-- Bot√£o para enviar apenas para o sistema (sem WhatsApp) - AMARELO -->
                        <!-- Este bot√£o aparece quando "Salvar na Lista" est√° ativo (enableGuestListSubmitValue = true) -->
                        <% if (enableGuestListSubmitValue) { %>
                        <button type="submit" class="submit-btn" id="form-submit-btn" data-submit-type="system-only" style="background: linear-gradient(135deg, #FFC700, #FFA500) !important; color: #000 !important; box-shadow: 0 4px 20px rgba(255, 199, 0, 0.4) !important;">
                            <i class="fas fa-user-plus" style="font-size: 22px;"></i>
                            <span>Inscrever-se</span>
                            <i class="fas fa-arrow-right" style="font-size: 16px; margin-left: auto;"></i>
                        </button>
                        <% } %>
                        
                        <!-- Bot√£o gen√©rico de envio (fallback) - AMARELO quando WhatsApp desativado e "Salvar na Lista" tamb√©m desativado -->
                        <% if (!enableWhatsappValue && !enableGuestListSubmitValue) { %>
                        <button type="submit" class="submit-btn" id="form-submit-btn" data-submit-type="generic" style="background: linear-gradient(135deg, #FFC700, #FFA500) !important; color: #000 !important; box-shadow: 0 4px 20px rgba(255, 199, 0, 0.4) !important;">
                            <i class="fas fa-paper-plane" style="font-size: 22px;"></i>
                            <span>Enviar</span>
                            <i class="fas fa-arrow-right" style="font-size: 16px; margin-left: auto;"></i>
                        </button>
                        <% } %>
                        
                        <!-- Bot√£o para enviar via WhatsApp (verde) -->
                        <!-- IMPORTANTE: Este bot√£o s√≥ aparece se WhatsApp est√° ativo E "Salvar na Lista" est√° inativo -->
                        <% if (enableWhatsappValue && !enableGuestListSubmitValue) { %>
                        <button type="button" class="submit-btn" id="whatsapp-submit-btn" style="background: linear-gradient(135deg, #25D366, #20BA5A) !important; color: #fff !important; box-shadow: 0 4px 16px rgba(37, 211, 102, 0.3) !important;">
                            <i class="fab fa-whatsapp" style="font-size: 22px;"></i>
                            <span>Enviar via WhatsApp</span>
                            <i class="fas fa-arrow-right" style="font-size: 16px; margin-left: auto;"></i>
                        </button>
                        <% } %>
                    </form>
                    
                    <!-- Bot√£o Enviar Mensagem para o Pastor (Abaixo do formul√°rio) -->
                    <% if (formData.enable_pastor_button && formData.pastor_whatsapp_number) { %>
                    <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e8eaed;">
                        <button type="button" class="submit-btn" id="pastor-message-btn" style="background: linear-gradient(135deg, #FFC700, #FFA500); color: #000; border: none; box-shadow: 0 4px 20px rgba(255, 199, 0, 0.4);">
                            <i class="fas fa-praying-hands" style="font-size: 22px;"></i>
                            <span><%= formData.pastor_button_name || 'Enviar Mensagem para o Pastor' %></span>
                            <i class="fas fa-arrow-right" style="font-size: 16px; margin-left: auto;"></i>
                        </button>
                    </div>
                    <% } %>
                </div>
                
                <!-- Sidebar - Informa√ß√µes Adicionais (Estilo Checkout) - Apenas se houver bot√£o do pastor -->
                <% if (formData.enable_pastor_button && formData.pastor_whatsapp_number) { %>
                <aside class="checkout-sidebar" style="position: sticky; top: 100px;">
                    <div class="checkout-sidebar-card" style="background: linear-gradient(135deg, var(--card-color, #f8f9fa) 0%, var(--card-color, #ffffff) 100%); border-radius: 20px; padding: 32px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.06); animation: fadeInUp 0.6s ease-out;">
                        <div style="background: linear-gradient(135deg, rgba(255,199,0,0.15), rgba(255,199,0,0.08)); border-radius: 14px; padding: 20px; border: 2px solid rgba(255,199,0,0.3);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FFC700, #FFA500); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-size: 18px; font-weight: 700;">
                                    <i class="fas fa-praying-hands"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 800; font-size: 15px; color: var(--text-color, #202124);">Enviar Mensagem para o Pastor</div>
                                    <div style="font-size: 12px; color: #5f6368; margin-top: 2px;">Contato direto e pessoal</div>
                                </div>
                            </div>
                            <p style="margin: 0; font-size: 13px; color: #5f6368; line-height: 1.6; font-weight: 500;">Ao clicar em "Enviar", voc√™ ser√° redirecionado para o WhatsApp do pastor com sua mensagem formatada.</p>
                        </div>
                    </div>
                </aside>
                <% } %>
            </div>
        </div>
    </main>

    <script>
        // Dados do formul√°rio
        const formDataObj = <%- JSON.stringify(formData) %>;
        const enablePastorButton = <%= formData.enable_pastor_button || false %>;
        const pastorWhatsappNumber = '<%= formData.pastor_whatsapp_number || '' %>';
        const whatsappNumber = enablePastorButton && pastorWhatsappNumber ? pastorWhatsappNumber : '<%= formData.whatsapp_number || '' %>';
        const itemId = <%= itemId || item.id %>;
        const slug = '<%= typeof profileSlug !== 'undefined' && profileSlug ? profileSlug : slug %>';
        const pageTimestamp = <%= typeof _timestamp !== 'undefined' ? _timestamp : Date.now() %>;
        
        // LOG DETALHADO NO CLIENTE
        console.log('üîç [FORM/CLIENT] Dados recebidos do servidor:', {
            formDataObj: formDataObj,
            enable_whatsapp_raw: formDataObj.enable_whatsapp,
            enable_whatsapp_type: typeof formDataObj.enable_whatsapp,
            enable_guest_list_submit_raw: formDataObj.enable_guest_list_submit,
            enable_guest_list_submit_type: typeof formDataObj.enable_guest_list_submit,
            primary_color: formDataObj.primary_color,
            secondary_color: formDataObj.secondary_color,
            form_title: formDataObj.form_title,
            pageTimestamp: pageTimestamp
        });
        
        // Verificar enable_whatsapp e enable_guest_list_submit corretamente
        // IMPORTANTE: Se "Salvar na Lista" est√° ativo, WhatsApp deve ser false
        // Porque "Salvar na Lista" significa enviar s√≥ para o sistema (sem WhatsApp)
        const enableGuestListSubmit = formDataObj.enable_guest_list_submit === true || formDataObj.enable_guest_list_submit === 'true' || formDataObj.enable_guest_list_submit === 1 || formDataObj.enable_guest_list_submit === '1';
        const enableWhatsapp = enableGuestListSubmit ? false : (formDataObj.enable_whatsapp === true || formDataObj.enable_whatsapp === 'true' || formDataObj.enable_whatsapp === 1 || formDataObj.enable_whatsapp === '1');
        
        console.log('üîç [FORM] Configura√ß√µes processadas:', {
            enable_whatsapp_raw: formDataObj.enable_whatsapp,
            enable_whatsapp_type: typeof formDataObj.enable_whatsapp,
            enableWhatsapp: enableWhatsapp,
            enable_guest_list_submit_raw: formDataObj.enable_guest_list_submit,
            enable_guest_list_submit_type: typeof formDataObj.enable_guest_list_submit,
            enableGuestListSubmit: enableGuestListSubmit,
            whatsappNumber: whatsappNumber,
            rule: 'Se enableGuestListSubmit=true, enableWhatsapp deve ser false'
        });
        
        // Gerar session ID √∫nico
        let sessionId = sessionStorage.getItem('form_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('form_session_id', sessionId);
        }
        
        // Fun√ß√£o para registrar eventos de analytics
        async function trackEvent(eventType) {
            try {
                await fetch(`/${slug}/form/${itemId}/analytics`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: eventType,
                        session_id: sessionId
                    })
                });
            } catch (error) {
                console.error('Erro ao registrar analytics:', error);
                // N√£o bloquear a experi√™ncia se analytics falhar
            }
        }
        
        // Registrar view quando a p√°gina carregar
        trackEvent('view');
        
        // Registrar start quando o usu√°rio come√ßar a interagir com o formul√°rio
        let formStarted = false;
        document.addEventListener('focusin', function(e) {
            if (e.target.closest('#digital-form') && !formStarted) {
                formStarted = true;
                trackEvent('start');
            }
        }, true);

        // Carregar campos din√¢micos se existirem
        function renderFormFields(containerEl, fields) {
            if (!fields || fields.length === 0) {
                containerEl.innerHTML = '<p style="text-align: center; color: var(--text-color, #666); padding: 40px;">Nenhum campo configurado neste formul√°rio.</p>';
                console.warn('‚ö†Ô∏è [PUBLIC] Nenhum campo para renderizar');
                return;
            }
            
            console.log(`üîÑ [PUBLIC] Renderizando ${fields.length} campos...`);
            containerEl.innerHTML = ''; // Limpar container antes de adicionar
            
            fields.forEach((field, index) => {
                // Normalizar campo (case-insensitive para label)
                const normalizedField = {
                    ...field,
                    label: field.label || field.Label || 'Campo sem t√≠tulo',
                    type: field.type || 'short_text',
                    required: field.required !== undefined ? field.required : (field.Required !== undefined ? field.Required : false),
                    placeholder: field.placeholder || field.Placeholder || '',
                    options: field.options || field.Options || []
                };
                
                const group = document.createElement('div');
                group.className = 'form-group';
                group.dataset.fieldType = normalizedField.type;
                group.dataset.fieldId = normalizedField.id || `field_${index}`;
                
                console.log(`üîÑ [PUBLIC] Processando campo ${index + 1}/${fields.length}:`, normalizedField.label, '- Tipo:', normalizedField.type);
                console.log(`üîç [PUBLIC] Campo completo:`, normalizedField);
                
                let fieldHTML = `<label for="field-${index}">${normalizedField.label} ${normalizedField.required ? '<span class="required">*</span>' : ''}</label>`;
                
                switch(normalizedField.type) {
                    case 'short_text':
                        fieldHTML += `<input type="text" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}">`;
                        break;
                    case 'paragraph':
                        fieldHTML += `<textarea id="field-${index}" name="${normalizedField.id || `field_${index}`}" rows="4" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}"></textarea>`;
                        break;
                    case 'multiple_choice':
                        if (normalizedField.options && normalizedField.options.length > 0) {
                            normalizedField.options.forEach((opt, optIdx) => {
                                fieldHTML += `
                                    <label class="radio-label">
                                        <input type="radio" name="${normalizedField.id || `field_${index}`}" value="${opt}" ${normalizedField.required ? 'required' : ''}>
                                        <span>${opt}</span>
                                    </label>
                                `;
                            });
                        }
                        break;
                    case 'checkbox':
                        if (normalizedField.options && normalizedField.options.length > 0) {
                            normalizedField.options.forEach((opt, optIdx) => {
                                fieldHTML += `
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="${normalizedField.id || `field_${index}`}" value="${opt}">
                                        <span>${opt}</span>
                                    </label>
                                `;
                            });
                        }
                        break;
                    case 'dropdown':
                        fieldHTML += `<select id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}><option value="">Selecione...</option>`;
                        if (normalizedField.options && normalizedField.options.length > 0) {
                            normalizedField.options.forEach(opt => {
                                fieldHTML += `<option value="${opt}">${opt}</option>`;
                            });
                        }
                        fieldHTML += `</select>`;
                        break;
                    case 'yes_no':
                        fieldHTML += `
                            <div class="yes-no-group">
                                <label class="radio-label">
                                    <input type="radio" name="${normalizedField.id || `field_${index}`}" value="sim" ${normalizedField.required ? 'required' : ''}>
                                    <span>Sim</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="${normalizedField.id || `field_${index}`}" value="n√£o" ${normalizedField.required ? 'required' : ''}>
                                    <span>N√£o</span>
                                </label>
                            </div>
                        `;
                        break;
                    case 'date':
                        fieldHTML += `<input type="date" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}>`;
                        break;
                    case 'time':
                        fieldHTML += `<input type="time" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}>`;
                        break;
                    case 'datetime':
                        fieldHTML += `<input type="datetime-local" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''}>`;
                        break;
                    case 'email':
                        fieldHTML += `<input type="email" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder || 'exemplo@email.com'}">`;
                        break;
                    case 'number':
                        fieldHTML += `<input type="number" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}" ${normalizedField.min !== undefined ? `min="${normalizedField.min}"` : ''} ${normalizedField.max !== undefined ? `max="${normalizedField.max}"` : ''}>`;
                        break;
                    case 'phone':
                        fieldHTML += `<input type="tel" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder || '(00) 00000-0000'}">`;
                        break;
                    case 'url':
                        fieldHTML += `<input type="url" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder || 'https://exemplo.com'}">`;
                        break;
                    case 'linear_scale':
                        const min = normalizedField.min || field.min || 1;
                        const max = normalizedField.max || field.max || 5;
                        fieldHTML += `<div class="linear-scale-group">`;
                        fieldHTML += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-dark, #666);"><span>${min}</span><span>${max}</span></div>`;
                        for (let i = min; i <= max; i++) {
                            fieldHTML += `
                                <label class="radio-label">
                                    <input type="radio" name="${normalizedField.id || `field_${index}`}" value="${i}" ${normalizedField.required ? 'required' : ''}>
                                    <span>${i}</span>
                                </label>
                            `;
                        }
                        fieldHTML += `</div>`;
                        break;
                    case 'rating':
                        const ratingMax = normalizedField.max || field.max || 5;
                        fieldHTML += `<div class="rating-group">`;
                        for (let i = 1; i <= ratingMax; i++) {
                            fieldHTML += `<input type="radio" name="${normalizedField.id || `field_${index}`}" value="${i}" id="rating-${index}-${i}" ${normalizedField.required ? 'required' : ''}><label for="rating-${index}-${i}">‚òÖ</label>`;
                        }
                        fieldHTML += `</div>`;
                        break;
                    case 'file_upload':
                        fieldHTML += `<input type="file" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} accept="${normalizedField.accept || field.accept || '*/*'}" style="padding: 12px; border: 1.5px solid #dadce0; border-radius: 12px; background: white; cursor: pointer;">`;
                        break;
                    case 'multiple_choice_grid':
                        if ((normalizedField.rows || field.rows) && (normalizedField.columns || field.columns)) {
                            const rows = normalizedField.rows || field.rows;
                            const columns = normalizedField.columns || field.columns;
                            fieldHTML += `<div class="choice-grid" style="overflow-x: auto;">`;
                            fieldHTML += `<table style="width: 100%; border-collapse: collapse; min-width: 500px;">`;
                            fieldHTML += `<thead><tr><th style="padding: 12px; text-align: left; border-bottom: 2px solid #dadce0;"></th>`;
                            columns.forEach(col => {
                                fieldHTML += `<th style="padding: 12px; text-align: center; border-bottom: 2px solid #dadce0;">${col}</th>`;
                            });
                            fieldHTML += `</tr></thead><tbody>`;
                            rows.forEach(row => {
                                fieldHTML += `<tr><td style="padding: 12px; font-weight: 600;">${row}</td>`;
                                columns.forEach(col => {
                                    fieldHTML += `<td style="padding: 12px; text-align: center;"><input type="radio" name="${normalizedField.id || `field_${index}`}_${row}" value="${col}" ${normalizedField.required ? 'required' : ''}></td>`;
                                });
                                fieldHTML += `</tr>`;
                            });
                            fieldHTML += `</tbody></table></div>`;
                        }
                        break;
                    case 'checkbox_grid':
                        if ((normalizedField.rows || field.rows) && (normalizedField.columns || field.columns)) {
                            const rows = normalizedField.rows || field.rows;
                            const columns = normalizedField.columns || field.columns;
                            fieldHTML += `<div class="checkbox-grid" style="overflow-x: auto;">`;
                            fieldHTML += `<table style="width: 100%; border-collapse: collapse; min-width: 500px;">`;
                            fieldHTML += `<thead><tr><th style="padding: 12px; text-align: left; border-bottom: 2px solid #dadce0;"></th>`;
                            columns.forEach(col => {
                                fieldHTML += `<th style="padding: 12px; text-align: center; border-bottom: 2px solid #dadce0;">${col}</th>`;
                            });
                            fieldHTML += `</tr></thead><tbody>`;
                            rows.forEach(row => {
                                fieldHTML += `<tr><td style="padding: 12px; font-weight: 600;">${row}</td>`;
                                columns.forEach(col => {
                                    fieldHTML += `<td style="padding: 12px; text-align: center;"><input type="checkbox" name="${normalizedField.id || `field_${index}`}_${row}" value="${col}"></td>`;
                                });
                                fieldHTML += `</tr>`;
                            });
                            fieldHTML += `</tbody></table></div>`;
                        }
                        break;
                    default:
                        fieldHTML += `<input type="text" id="field-${index}" name="${normalizedField.id || `field_${index}`}" ${normalizedField.required ? 'required' : ''} placeholder="${normalizedField.placeholder}">`;
                }
                
                group.innerHTML = fieldHTML;
                containerEl.appendChild(group);
                console.log(`‚úÖ [PUBLIC] Campo ${index + 1} renderizado:`, field.label || field.type);
            });
            
            console.log(`‚úÖ [PUBLIC] Todos os ${fields.length} campos foram renderizados com sucesso!`);
            
            // Adicionar classe 'checked' aos labels quando inputs s√£o marcados (fallback para :has())
            setTimeout(() => {
                document.querySelectorAll('.radio-label input[type="radio"], .checkbox-label input[type="checkbox"]').forEach(input => {
                    input.addEventListener('change', function() {
                        // Remover 'checked' de todos os irm√£os do mesmo grupo (para radio)
                        if (this.type === 'radio') {
                            const name = this.name;
                            document.querySelectorAll(`input[type="radio"][name="${name}"]`).forEach(radio => {
                                radio.closest('.radio-label')?.classList.remove('checked');
                            });
                        }
                        // Adicionar/remover 'checked' baseado no estado
                        if (this.checked) {
                            this.closest('.radio-label, .checkbox-label')?.classList.add('checked');
                        } else {
                            this.closest('.checkbox-label')?.classList.remove('checked');
                        }
                    });
                });
            }, 100);
        }
        
        // Inicializar renderiza√ß√£o dos campos
        (function() {
            console.log('üîç [DEBUG] formDataObj completo:', formDataObj);
            console.log('üîç [DEBUG] formDataObj.form_fields (tipo):', typeof formDataObj.form_fields);
            console.log('üîç [DEBUG] formDataObj.form_fields (valor):', formDataObj.form_fields);
            
            let formFields = formDataObj.form_fields || [];
            
            // Garantir que formFields seja um array
            if (typeof formFields === 'string') {
                try {
                    formFields = JSON.parse(formFields);
                } catch (e) {
                    console.error('‚ùå Erro ao parsear form_fields:', e);
                    formFields = [];
                }
            }
            if (!Array.isArray(formFields)) {
                console.warn('‚ö†Ô∏è formFields n√£o √© um array:', typeof formFields, formFields);
                formFields = [];
            }
            
            console.log('‚úÖ Form fields carregados (array):', formFields);
            console.log('‚úÖ Total de campos:', formFields.length);
            console.log('üîç [PUBLIC] formDataObj completo:', formDataObj);
            console.log('üîç [PUBLIC] formFields detalhado:', JSON.stringify(formFields, null, 2));
            
            // IMPORTANTE: Fun√ß√£o para renderizar campos quando o DOM estiver pronto
            function renderFieldsWhenReady() {
                const container = document.getElementById('dynamic-fields-container');
                
                if (!container) {
                    console.warn('‚ö†Ô∏è [PUBLIC] Container dynamic-fields-container ainda n√£o encontrado, tentando novamente em 100ms...');
                    // Tentar v√°rias vezes at√© encontrar o container
                    setTimeout(renderFieldsWhenReady, 100);
                    return;
                }
                
                console.log('‚úÖ [PUBLIC] Container encontrado, verificando campos...');
                console.log('üîç [PUBLIC] Total de campos para renderizar:', formFields.length);
                
                if (formFields && formFields.length > 0) {
                    console.log(`‚úÖ [PUBLIC] Renderizando ${formFields.length} campos no container...`);
                    renderFormFields(container, formFields);
                    
                    // Tornar formFields acess√≠vel globalmente para event listeners e fun√ß√µes
                    window.formFields = formFields;
                    // Atualizar currentFormFields no escopo global tamb√©m
                    if (typeof currentFormFields !== 'undefined') {
                        currentFormFields = formFields;
                    }
                    console.log('‚úÖ [PUBLIC] Campos renderizados e vari√°veis globais atualizadas');
                } else {
                    console.warn('‚ö†Ô∏è [PUBLIC] Nenhum campo configurado no formul√°rio');
                    container.innerHTML = '<p style="text-align: center; color: var(--text-color, #666); padding: 40px; font-size: 16px;">‚ö†Ô∏è Nenhum campo configurado neste formul√°rio. Entre em contato com o administrador.</p>';
                }
            }
            
            // Aguardar DOM estar pronto antes de tentar renderizar
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', renderFieldsWhenReady);
            } else {
                // DOM j√° est√° pronto, mas pode precisar de um pequeno delay para garantir que o container existe
                setTimeout(renderFieldsWhenReady, 50);
            }
        })();

        // Formatar WhatsApp
        function formatWhatsApp(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d+)/, '($1) $2');
            }
            input.value = value;
        }

        const whatsappInput = document.getElementById('form-whatsapp');
        if (whatsappInput) {
            whatsappInput.addEventListener('input', () => formatWhatsApp(whatsappInput));
        }

        // Enviar formul√°rio
        // IMPORTANTE: Vari√°vel global para currentFormFields (ser√° atualizada quando necess√°rio)
        let currentFormFields = window.formFields || formDataObj.form_fields || [];
        if (typeof currentFormFields === 'string') {
            try {
                currentFormFields = JSON.parse(currentFormFields);
            } catch (e) {
                console.error('‚ùå [VALIDATE] Erro ao parsear formFields:', e);
                currentFormFields = [];
            }
        }
        if (!Array.isArray(currentFormFields)) {
            currentFormFields = [];
        }
        
        // Fun√ß√£o de valida√ß√£o robusta
        function validateForm() {
            let isValid = true;
            const errors = [];
            
            // Garantir que currentFormFields esteja atualizado
            let fieldsToValidate = window.formFields || currentFormFields || formDataObj.form_fields || [];
            if (typeof fieldsToValidate === 'string') {
                try {
                    fieldsToValidate = JSON.parse(fieldsToValidate);
                } catch (e) {
                    console.error('‚ùå [VALIDATE] Erro ao parsear formFields:', e);
                    fieldsToValidate = [];
                }
            }
            if (!Array.isArray(fieldsToValidate)) {
                fieldsToValidate = [];
            }
            
            fieldsToValidate.forEach((field, index) => {
                const fieldId = field.id || `field_${index}`;
                const fieldLabel = field.label || 'Campo sem t√≠tulo';
                const fieldElement = document.querySelector(`#field-${index}`);
                const fieldGroup = fieldElement?.closest('.form-group');
                
                // Remover estados de erro anteriores
                if (fieldGroup) {
                    fieldGroup.classList.remove('field-error', 'field-valid');
                    const errorMsg = fieldGroup.querySelector('.field-error-message');
                    if (errorMsg) errorMsg.remove();
                }
                
                // Validar campo obrigat√≥rio
                if (field.required) {
                    let fieldValue = '';
                    
                    if (field.type === 'checkbox') {
                        const checked = document.querySelectorAll(`input[name="${fieldId}"]:checked`);
                        fieldValue = checked.length > 0 ? Array.from(checked).map(c => c.value).join(',') : '';
                    } else if (field.type === 'multiple_choice' || field.type === 'yes_no') {
                        const selected = document.querySelector(`input[name="${fieldId}"]:checked`);
                        fieldValue = selected ? selected.value : '';
                    } else if (fieldElement) {
                        fieldValue = fieldElement.value ? fieldElement.value.trim() : '';
                    }
                    
                    if (!fieldValue) {
                        isValid = false;
                        errors.push(`${fieldLabel} √© obrigat√≥rio`);
                        if (fieldGroup) {
                            fieldGroup.classList.add('field-error');
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'field-error-message';
                            errorDiv.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 4px;';
                            errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Este campo √© obrigat√≥rio';
                            fieldGroup.appendChild(errorDiv);
                        }
                    }
                }
                
                // Valida√ß√£o espec√≠fica por tipo
                if (fieldElement && fieldElement.value) {
                    const value = fieldElement.value.trim();
                    
                    // Valida√ß√£o de email
                    if (field.type === 'email' && value) {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(value)) {
                            isValid = false;
                            errors.push(`${fieldLabel} deve ser um email v√°lido`);
                            if (fieldGroup) {
                                fieldGroup.classList.add('field-error');
                                const errorDiv = fieldGroup.querySelector('.field-error-message') || document.createElement('div');
                                errorDiv.className = 'field-error-message';
                                errorDiv.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 4px;';
                                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Email inv√°lido';
                                if (!fieldGroup.querySelector('.field-error-message')) {
                                    fieldGroup.appendChild(errorDiv);
                                }
                            }
                        }
                    }
                    
                    // Valida√ß√£o de telefone
                    if (field.type === 'phone' && value) {
                        const phoneRegex = /^[\d\s\(\)\-\+]{10,}$/;
                        const digitsOnly = value.replace(/\D/g, '');
                        if (digitsOnly.length < 10 || digitsOnly.length > 15) {
                            isValid = false;
                            errors.push(`${fieldLabel} deve ser um telefone v√°lido`);
                            if (fieldGroup) {
                                fieldGroup.classList.add('field-error');
                                const errorDiv = fieldGroup.querySelector('.field-error-message') || document.createElement('div');
                                errorDiv.className = 'field-error-message';
                                errorDiv.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 4px;';
                                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Telefone inv√°lido (m√≠nimo 10 d√≠gitos)';
                                if (!fieldGroup.querySelector('.field-error-message')) {
                                    fieldGroup.appendChild(errorDiv);
                                }
                            }
                        }
                    }
                    
                    // Valida√ß√£o de n√∫mero
                    if (field.type === 'number' && value) {
                        if (isNaN(value)) {
                            isValid = false;
                            errors.push(`${fieldLabel} deve ser um n√∫mero v√°lido`);
                            if (fieldGroup) {
                                fieldGroup.classList.add('field-error');
                            }
                        } else {
                            if (field.min !== undefined && parseFloat(value) < field.min) {
                                isValid = false;
                                errors.push(`${fieldLabel} deve ser no m√≠nimo ${field.min}`);
                            }
                            if (field.max !== undefined && parseFloat(value) > field.max) {
                                isValid = false;
                                errors.push(`${fieldLabel} deve ser no m√°ximo ${field.max}`);
                            }
                        }
                    }
                    
                    // Feedback visual de sucesso
                    if (isValid && fieldGroup && fieldElement.value) {
                        fieldGroup.classList.add('field-valid');
                    }
                }
            });
            
            return { isValid, errors };
        }
        
        // Valida√ß√£o em tempo real (ap√≥s campos serem renderizados)
        // IMPORTANTE: Aguardar renderiza√ß√£o dos campos antes de adicionar listeners
        setTimeout(() => {
            document.querySelectorAll('#digital-form input, #digital-form textarea, #digital-form select').forEach(input => {
                input.addEventListener('blur', () => {
                    const fieldGroup = input.closest('.form-group');
                    if (fieldGroup) {
                        // Obter campos atualizados de window.formFields ou currentFormFields
                        const fields = window.formFields || currentFormFields || formDataObj.form_fields || [];
                        let fieldsArray = fields;
                        if (typeof fieldsArray === 'string') {
                            try {
                                fieldsArray = JSON.parse(fieldsArray);
                            } catch (e) {
                                fieldsArray = [];
                            }
                        }
                        if (!Array.isArray(fieldsArray)) {
                            fieldsArray = [];
                        }
                        
                        const fieldIndex = parseInt(input.id.replace('field-', ''));
                        const field = fieldsArray[fieldIndex];
                        if (field && field.required && !input.value.trim()) {
                            fieldGroup.classList.add('field-error');
                        } else if (fieldGroup.classList.contains('field-error')) {
                            fieldGroup.classList.remove('field-error');
                            fieldGroup.classList.add('field-valid');
                        }
                    }
                });
            });
        }, 1000); // Aguardar 1 segundo para garantir que os campos foram renderizados
        
        // Fun√ß√£o para mostrar loading state
        function showLoadingState(button, message = 'Enviando...') {
            button.disabled = true;
            button.style.opacity = '0.7';
            button.style.cursor = 'not-allowed';
            const originalHTML = button.innerHTML;
            button.dataset.originalHTML = originalHTML;
            button.innerHTML = `<i class="fas fa-spinner fa-spin" style="font-size: 22px;"></i> <span>${message}</span>`;
            return originalHTML;
        }
        
        // Fun√ß√£o para restaurar bot√£o
        function restoreButton(button, originalHTML) {
            button.disabled = false;
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
            button.innerHTML = originalHTML;
        }
        
        // Fun√ß√£o para mostrar mensagem de sucesso
        function showSuccessMessage(message, duration = 5000) {
            const form = document.getElementById('digital-form');
            const successDiv = document.createElement('div');
            successDiv.className = 'form-success-message';
            successDiv.style.cssText = `
                background: linear-gradient(135deg, #4caf50, #45a049);
                color: white;
                padding: 24px;
                border-radius: 12px;
                margin: 20px 0;
                box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
                display: flex;
                align-items: center;
                gap: 16px;
                animation: slideDown 0.3s ease-out;
            `;
            successDiv.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 32px;"></i>
                <div style="flex: 1;">
                    <strong style="display: block; font-size: 18px; margin-bottom: 4px;">Sucesso!</strong>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">${message}</p>
                </div>
            `;
            
            // Adicionar anima√ß√£o CSS se n√£o existir
            if (!document.getElementById('form-success-styles')) {
                const style = document.createElement('style');
                style.id = 'form-success-styles';
                style.textContent = `
                    @keyframes slideDown {
                        from {
                            opacity: 0;
                            transform: translateY(-20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            form.insertBefore(successDiv, form.firstChild);
            
            // Scroll para a mensagem
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Remover ap√≥s dura√ß√£o
            setTimeout(() => {
                successDiv.style.animation = 'slideDown 0.3s ease-out reverse';
                setTimeout(() => successDiv.remove(), 300);
            }, duration);
        }
        
        // Fun√ß√£o para mostrar erro de forma amig√°vel
        function showErrorMessage(message, field = null) {
            if (field) {
                const fieldGroup = field.closest('.form-group');
                if (fieldGroup) {
                    fieldGroup.classList.add('field-error');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'field-error-message';
                    errorDiv.style.cssText = 'color: #d32f2f; font-size: 12px; margin-top: 8px; display: flex; align-items: center; gap: 6px; animation: shake 0.3s;';
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                    fieldGroup.appendChild(errorDiv);
                    
                    // Scroll para o erro
                    fieldGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            } else {
                // Mensagem global
                const form = document.getElementById('digital-form');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'form-error-message';
                errorDiv.style.cssText = `
                    background: #ffebee;
                    border-left: 4px solid #d32f2f;
                    color: #c62828;
                    padding: 16px;
                    border-radius: 8px;
                    margin: 20px 0;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    animation: shake 0.3s;
                `;
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="font-size: 20px;"></i>
                    <div>
                        <strong style="display: block; margin-bottom: 4px;">Erro</strong>
                        <p style="margin: 0; font-size: 14px;">${message}</p>
                    </div>
                `;
                
                // Adicionar anima√ß√£o shake se n√£o existir
                if (!document.getElementById('form-error-styles')) {
                    const style = document.createElement('style');
                    style.id = 'form-error-styles';
                    style.textContent = `
                        @keyframes shake {
                            0%, 100% { transform: translateX(0); }
                            25% { transform: translateX(-10px); }
                            75% { transform: translateX(10px); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                form.insertBefore(errorDiv, form.firstChild);
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                setTimeout(() => {
                    errorDiv.style.opacity = '0';
                    errorDiv.style.transition = 'opacity 0.3s';
                    setTimeout(() => errorDiv.remove(), 300);
                }, 5000);
            }
        }

        const form = document.getElementById('digital-form');
        if (form) {
            // Adicionar listener ao formul√°rio
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                console.log('üîÑ [SUBMIT] Evento submit capturado, prevenindo default...');
                
                const submitBtn = document.getElementById('form-submit-btn');
            if (!submitBtn) {
                console.error('‚ùå [SUBMIT] Bot√£o de submit n√£o encontrado!');
                showErrorMessage('Erro: Bot√£o de envio n√£o encontrado. Recarregue a p√°gina e tente novamente.');
                return;
            }
            
            const originalHTML = showLoadingState(submitBtn, 'Validando...');

            // Verificar se WhatsApp est√° habilitado e se tem n√∫mero configurado
            // IMPORTANTE: S√≥ verificar WhatsApp se realmente estiver ativo (n√£o quando "Salvar na Lista" est√° ativo)
            if (enableWhatsapp && !enableGuestListSubmit && !whatsappNumber) {
                restoreButton(submitBtn, originalHTML);
                showErrorMessage('N√∫mero do WhatsApp n√£o configurado. Entre em contato com o administrador.');
                return;
            }
            
            // Se nem WhatsApp nem lista de convidados est√£o ativos, mostrar erro
            // Mas lembrar que quando "Salvar na Lista" est√° ativo, enableWhatsapp ser√° false
            if (!enableWhatsapp && !enableGuestListSubmit) {
                restoreButton(submitBtn, originalHTML);
                showErrorMessage('Nenhuma op√ß√£o de envio est√° configurada. Entre em contato com o administrador.');
                return;
            }
            
            console.log('‚úÖ [SUBMIT] Valida√ß√£o passou:', {
                enableWhatsapp,
                enableGuestListSubmit,
                whatsappNumber: whatsappNumber || 'n√£o configurado',
                submitBtnFound: !!submitBtn
            });
            
            // Validar formul√°rio antes de enviar
            showLoadingState(submitBtn, 'Validando dados...');
            const validation = validateForm();
            if (!validation.isValid) {
                restoreButton(submitBtn, originalHTML);
                // Scroll para o primeiro erro
                const firstError = document.querySelector('.field-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                // Mostrar mensagem de erro global
                showErrorMessage('Por favor, corrija os erros destacados acima antes de enviar.');
                return;
            }

            // Obter formFields (pode estar no escopo global)
            // IMPORTANTE: Atualizar a vari√°vel global currentFormFields se j√° existir
            let fieldsToSubmit = window.formFields || currentFormFields || formDataObj.form_fields || [];
            if (typeof fieldsToSubmit === 'string') {
                try {
                    fieldsToSubmit = JSON.parse(fieldsToSubmit);
                } catch (e) {
                    console.error('‚ùå [SUBMIT] Erro ao parsear formFields:', e);
                    fieldsToSubmit = [];
                }
            }
            if (!Array.isArray(fieldsToSubmit)) {
                fieldsToSubmit = [];
            }
            
            // Atualizar currentFormFields global e window.formFields
            currentFormFields = fieldsToSubmit;
            window.formFields = fieldsToSubmit;
            
            // Verificar se h√° campos configurados
            if (!currentFormFields || currentFormFields.length === 0) {
                restoreButton(submitBtn, originalHTML);
                showErrorMessage('Nenhum campo configurado neste formul√°rio. Entre em contato com o administrador.');
                return;
            }
            
            // Coletar dados de todos os campos din√¢micos - CORRIGIDO: Uma √∫nica passagem
            const data = {};
            const responseData = {};
            
            // IMPORTANTE: Garantir que currentFormFields esteja definido
            // Usar fieldsToSubmit que j√° foi processado acima
            let fieldsToProcess = fieldsToSubmit || currentFormFields || window.formFields || formDataObj.form_fields || [];
            if (typeof fieldsToProcess === 'string') {
                try {
                    fieldsToProcess = JSON.parse(fieldsToProcess);
                } catch (e) {
                    console.error('‚ùå [SUBMIT] Erro ao parsear fieldsToProcess:', e);
                    fieldsToProcess = [];
                }
            }
            if (!Array.isArray(fieldsToProcess)) {
                fieldsToProcess = [];
            }
            
            fieldsToProcess.forEach((field, index) => {
                // IMPORTANTE: Usar o mesmo padr√£o de ID usado na renderiza√ß√£o
                const fieldId = field.id || `field_${index}`;
                const fieldName = fieldId; // name e id s√£o iguais na renderiza√ß√£o
                const fieldLabel = field.label || 'Campo sem t√≠tulo';
                
                console.log(`üîç [SUBMIT] Coletando campo ${index + 1}:`, {
                    fieldId,
                    fieldName,
                    fieldLabel,
                    type: field.type
                });
                
                try {
                    if (field.type === 'checkbox') {
                        // Checkboxes: m√∫ltiplos valores
                        const checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${fieldName}"]:checked`);
                        if (checkboxes.length > 0) {
                            responseData[fieldId] = Array.from(checkboxes).map(cb => cb.value);
                            data[fieldId] = responseData[fieldId].join(', ');
                            console.log(`‚úÖ [SUBMIT] Checkbox coletado:`, responseData[fieldId]);
                        }
                    } else if (field.type === 'multiple_choice_grid' || field.type === 'checkbox_grid') {
                        // Grids: estrutura complexa
                        const gridData = {};
                        if (field.rows && Array.isArray(field.rows)) {
                            field.rows.forEach(row => {
                                const rowName = `${fieldName}_${row}`;
                                if (field.type === 'multiple_choice_grid') {
                                    const selected = document.querySelector(`input[type="radio"][name="${rowName}"]:checked`);
                                    if (selected) {
                                        gridData[row] = selected.value;
                                    }
                                } else {
                                    const selected = document.querySelectorAll(`input[type="checkbox"][name="${rowName}"]:checked`);
                                    if (selected.length > 0) {
                                        gridData[row] = Array.from(selected).map(cb => cb.value);
                                    }
                                }
                            });
                            if (Object.keys(gridData).length > 0) {
                                responseData[fieldId] = gridData;
                                // Formatar para WhatsApp
                                let gridText = '';
                                Object.entries(gridData).forEach(([row, value]) => {
                                    gridText += `${row}: ${Array.isArray(value) ? value.join(', ') : value}\n`;
                                });
                                data[fieldId] = gridText.trim();
                                console.log(`‚úÖ [SUBMIT] Grid coletado:`, gridData);
                            }
                        }
                    } else if (field.type === 'multiple_choice' || field.type === 'yes_no' || field.type === 'linear_scale' || field.type === 'rating') {
                        // Radio buttons: valor √∫nico
                        const selected = document.querySelector(`input[type="radio"][name="${fieldName}"]:checked`);
                        if (selected) {
                            responseData[fieldId] = selected.value;
                            data[fieldId] = selected.value;
                            console.log(`‚úÖ [SUBMIT] Radio coletado:`, selected.value);
                        }
                    } else if (field.type === 'dropdown' || field.type === 'select') {
                        // Dropdown/Select
                        const select = document.querySelector(`select[name="${fieldName}"], select#field-${index}`);
                        if (select && select.value) {
                            responseData[fieldId] = select.value;
                            data[fieldId] = select.value;
                            console.log(`‚úÖ [SUBMIT] Select coletado:`, select.value);
                        }
                    } else {
                        // Campos de texto, n√∫mero, data, email, textarea, etc.
                        // IMPORTANTE: Tentar ambos os seletores para garantir compatibilidade
                        const input = document.querySelector(`#field-${index}, input[name="${fieldName}"], textarea[name="${fieldName}"], textarea#field-${index}`);
                        if (input) {
                            const value = input.value ? input.value.trim() : '';
                            if (value || field.required) {
                                responseData[fieldId] = value;
                                data[fieldId] = value;
                                console.log(`‚úÖ [SUBMIT] Input coletado (${field.type}):`, value ? 'tem valor' : 'vazio mas obrigat√≥rio');
                            }
                        } else {
                            console.warn(`‚ö†Ô∏è [SUBMIT] Campo n√£o encontrado no DOM:`, {
                                fieldId,
                                fieldName,
                                index,
                                type: field.type,
                                selector1: `#field-${index}`,
                                selector2: `input[name="${fieldName}"]`
                            });
                        }
                    }
                } catch (fieldError) {
                    console.error(`‚ùå [SUBMIT] Erro ao coletar campo ${fieldId}:`, fieldError);
                    // Continuar coletando outros campos mesmo se um falhar
                }
            });
            
            // IMPORTANTE: Extrair nome, email e telefone dos campos coletados
            // Procurar por campos com labels ou tipos espec√≠ficos que indiquem nome, email ou telefone
            let extractedName = null;
            let extractedEmail = null;
            let extractedPhone = null;
            
            // Procurar nos campos coletados
            fieldsToProcess.forEach((field, index) => {
                const fieldId = field.id || `field_${index}`;
                const fieldLabel = (field.label || '').toLowerCase().trim();
                const fieldType = field.type || '';
                const fieldValue = responseData[fieldId] || data[fieldId] || '';
                
                // Extrair nome
                if (!extractedName && fieldValue && typeof fieldValue === 'string' && fieldValue.trim().length >= 2) {
                    if (fieldLabel.includes('nome') || fieldLabel.includes('name') || 
                        fieldId.toLowerCase().includes('nome') || fieldId.toLowerCase().includes('name')) {
                        extractedName = fieldValue.trim();
                        console.log('‚úÖ [SUBMIT] Nome extra√≠do do campo:', fieldLabel, '=', extractedName);
                    }
                }
                
                // Extrair email
                if (!extractedEmail && fieldValue && typeof fieldValue === 'string' && fieldValue.trim()) {
                    if (fieldType === 'email' || fieldLabel.includes('email') || fieldLabel.includes('e-mail') ||
                        fieldId.toLowerCase().includes('email')) {
                        const emailValue = fieldValue.trim();
                        // Validar formato b√°sico de email
                        if (emailValue.includes('@') && emailValue.includes('.')) {
                            extractedEmail = emailValue;
                            console.log('‚úÖ [SUBMIT] Email extra√≠do do campo:', fieldLabel, '=', extractedEmail);
                        }
                    }
                }
                
                // Extrair telefone
                if (!extractedPhone && fieldValue && typeof fieldValue === 'string' && fieldValue.trim()) {
                    if (fieldType === 'phone' || fieldLabel.includes('telefone') || fieldLabel.includes('whatsapp') ||
                        fieldLabel.includes('phone') || fieldId.toLowerCase().includes('telefone') ||
                        fieldId.toLowerCase().includes('whatsapp') || fieldId.toLowerCase().includes('phone')) {
                        extractedPhone = fieldValue.trim();
                        console.log('‚úÖ [SUBMIT] Telefone extra√≠do do campo:', fieldLabel, '=', extractedPhone);
                    }
                }
            });
            
            // Se n√£o encontrou pelos labels, tentar pelos primeiros campos preenchidos
            if (!extractedName && Object.keys(responseData).length > 0) {
                const firstFieldValue = Object.values(responseData)[0];
                if (firstFieldValue && typeof firstFieldValue === 'string' && firstFieldValue.trim().length >= 2) {
                    extractedName = firstFieldValue.trim();
                    console.log('‚úÖ [SUBMIT] Nome extra√≠do do primeiro campo preenchido:', extractedName);
                }
            }
            
            // Verificar se h√° dados coletados
            console.log('üìä [SUBMIT] Dados coletados:', {
                responseDataKeys: Object.keys(responseData),
                responseDataCount: Object.keys(responseData).length,
                responseData: responseData,
                dataKeys: Object.keys(data),
                dataCount: Object.keys(data).length,
                data: data,
                fieldsCount: fieldsToProcess.length,
                extractedName: extractedName,
                extractedEmail: extractedEmail,
                extractedPhone: extractedPhone,
                hasData: Object.keys(responseData).length > 0 || Object.keys(data).length > 0
            });
            
            // IMPORTANTE: Validar se pelo menos alguns dados foram coletados
            // Mas permitir envio mesmo se alguns campos obrigat√≥rios estiverem vazios (a valida√ß√£o j√° foi feita)
            if (Object.keys(responseData).length === 0 && Object.keys(data).length === 0) {
                restoreButton(submitBtn, originalHTML);
                console.error('‚ùå [SUBMIT] Nenhum dado coletado do formul√°rio!', {
                    formFieldsCount: fieldsToProcess.length,
                    formFields: Array.isArray(fieldsToProcess) ? fieldsToProcess.map(f => ({ id: f.id, label: f.label, type: f.type })) : 'N/A',
                    allInputs: document.querySelectorAll('input, textarea, select').length
                });
                showErrorMessage('Por favor, preencha pelo menos um campo do formul√°rio antes de enviar.');
                return;
            }
            
            // Garantir que responseData n√£o esteja vazio (pode acontecer se s√≥ data tiver valores)
            if (Object.keys(responseData).length === 0 && Object.keys(data).length > 0) {
                // Se responseData estiver vazio mas data n√£o, copiar data para responseData
                Object.assign(responseData, data);
                console.log('‚ö†Ô∏è [SUBMIT] responseData estava vazio, copiando de data:', responseData);
            }
            
            // IMPORTANTE: Garantir que response_data n√£o seja um objeto vazio antes de enviar
            if (Object.keys(responseData).length === 0) {
                restoreButton(submitBtn, originalHTML);
                console.error('‚ùå [SUBMIT] responseData vazio ap√≥s todas as tentativas de coleta!');
                showErrorMessage('Erro: N√£o foi poss√≠vel coletar os dados do formul√°rio. Recarregue a p√°gina e tente novamente.');
                return;
            }
            
            // Enviar para o servidor
            showLoadingState(submitBtn, 'Enviando formul√°rio...');
            let submitSuccess = false;
            let responseId = null;
            
            const submitUrl = `/${slug}/form/${itemId}/submit`;
            
            // IMPORTANTE: Garantir que valores vazios sejam null, n√£o strings vazias
            const finalName = (extractedName || data.name || '').trim();
            const finalEmail = (extractedEmail || data.email || '').trim();
            const finalPhone = (extractedPhone || data.phone || '').trim();
            
            const submitPayload = {
                response_data: responseData,
                responder_name: finalName.length >= 2 ? finalName : null,
                responder_email: finalEmail.length > 0 && finalEmail.includes('@') ? finalEmail : null,
                responder_phone: finalPhone.length > 0 ? finalPhone : null,
                session_id: sessionId
            };
            
            console.log('üì§ [SUBMIT] Payload final antes de enviar:', {
                response_data_keys: Object.keys(submitPayload.response_data),
                responder_name: submitPayload.responder_name,
                responder_email: submitPayload.responder_email,
                responder_phone: submitPayload.responder_phone,
                responder_name_length: submitPayload.responder_name ? submitPayload.responder_name.length : 0
            });
            
            console.log('üì§ [SUBMIT] Enviando formul√°rio:', {
                url: submitUrl,
                payload: submitPayload,
                enableGuestListSubmit,
                enableWhatsapp
            });
            
            try {
                // IMPORTANTE: Adicionar timeout para evitar que o formul√°rio fique travado
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos timeout
                
                const submitResponse = await fetch(submitUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submitPayload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('üì• [SUBMIT] Resposta recebida:', {
                    status: submitResponse.status,
                    statusText: submitResponse.statusText,
                    ok: submitResponse.ok,
                    headers: Object.fromEntries(submitResponse.headers.entries())
                });
                
                if (!submitResponse.ok) {
                    const errorText = await submitResponse.text();
                    console.error('‚ùå [SUBMIT] Erro na resposta:', errorText);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: errorText || 'Erro desconhecido' };
                    }
                    throw new Error(errorData.message || `Erro ${submitResponse.status}: ${submitResponse.statusText}`);
                }
                
                const submitResult = await submitResponse.json();
                console.log('‚úÖ [SUBMIT] Resultado do submit:', submitResult);
                
                submitSuccess = true;
                responseId = submitResult.response_id || submitResult.id || null;
                
                // IMPORTANTE: Sempre redirecionar para p√°gina de sucesso quando o formul√°rio √© enviado
                // Se "Salvar na Lista" est√° ativo OU n√£o h√° WhatsApp, SEMPRE redirecionar
                // Se WhatsApp est√° ativo, redirecionar apenas se n√£o for para abrir WhatsApp
                if (submitResult.success || submitResult.success_page_url || !enableWhatsapp || enableGuestListSubmit) {
                    const successUrl = submitResult.success_page_url || `/${slug}/form/${itemId}/success?response_id=${responseId || ''}`;
                    
                    // Passar dados do formul√°rio via URL para mostrar na p√°gina de sucesso
                    const formDataParams = new URLSearchParams();
                    formDataParams.append('response_id', responseId || '');
                    
                    // Adicionar dados do formul√°rio para exibir na p√°gina de sucesso
                    Object.keys(data).forEach(key => {
                        if (data[key] && typeof data[key] === 'string' && data[key].trim() !== '') {
                            // Codificar valor para URL
                            try {
                                formDataParams.append(`data_${key}`, encodeURIComponent(data[key]));
                            } catch (e) {
                                console.warn('‚ö†Ô∏è [SUBMIT] Erro ao codificar dado para URL:', key, e);
                            }
                        }
                    });
                    
                    // Montar URL final
                    const separator = successUrl.includes('?') ? '&' : '?';
                    const finalUrl = `${successUrl}${separator}${formDataParams.toString()}`;
                    
                    console.log('üîÑ [SUBMIT] Redirecionando para p√°gina de sucesso:', {
                        finalUrl,
                        enableWhatsapp,
                        enableGuestListSubmit,
                        hasSuccessPageUrl: !!submitResult.success_page_url,
                        responseId
                    });
                    
                    // IMPORTANTE: For√ßar redirecionamento imediatamente
                    window.location.replace(finalUrl);
                    return;
                }
                
                // Se chegou aqui e WhatsApp est√° ativo (caso raro), tentar abrir WhatsApp
                console.log('‚úÖ [SUBMIT] Formul√°rio enviado com sucesso, tentando abrir WhatsApp');
                // Abrir WhatsApp ser√° tratado pelo handler espec√≠fico do bot√£o WhatsApp
                
            } catch (error) {
                console.error('‚ùå [SUBMIT] Erro ao salvar resposta:', error);
                console.error('‚ùå [SUBMIT] Stack:', error.stack);
                console.error('‚ùå [SUBMIT] Error name:', error.name);
                console.error('‚ùå [SUBMIT] Error message:', error.message);
                restoreButton(submitBtn, originalHTML);
                
                // Mensagem de erro espec√≠fica
                let errorMessage = 'Erro ao enviar formul√°rio. ';
                if (error.name === 'AbortError' || error.message && error.message.includes('aborted')) {
                    errorMessage += 'Tempo de espera esgotado. Verifique sua conex√£o e tente novamente.';
                } else if (error.message && (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Failed to fetch'))) {
                    errorMessage += 'Verifique sua conex√£o com a internet e tente novamente.';
                } else if (error.message && error.message.includes('429')) {
                    errorMessage += 'Muitas tentativas. Aguarde alguns minutos antes de tentar novamente.';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Tente novamente em alguns instantes.';
                }
                
                // Mostrar erro na p√°gina mesmo (n√£o redirecionar imediatamente)
                showErrorMessage(errorMessage);
                
                // Apenas redirecionar para p√°gina de erro se n√£o houver bot√£o de submit ou se o erro for cr√≠tico
                if (!submitBtn || error.message && error.message.includes('404')) {
                    const errorParams = new URLSearchParams();
                    errorParams.append('error', encodeURIComponent(errorMessage));
                    errorParams.append('form_url', `/${slug}/form/${itemId}`);
                    window.location.href = `/${slug}/form/${itemId}/error?${errorParams.toString()}`;
                }
                return;
            }

            // Se chegou aqui, o formul√°rio foi enviado com sucesso mas n√£o foi redirecionado
            // Isso n√£o deveria acontecer, mas vamos garantir o redirecionamento
            console.warn('‚ö†Ô∏è [SUBMIT] Formul√°rio enviado mas n√£o houve redirecionamento no bloco anterior, garantindo redirecionamento...');
            showLoadingState(submitBtn, 'Redirecionando...');
            
            // Redirecionar para p√°gina de sucesso imediatamente
            const fallbackSuccessUrl = `/${slug}/form/${itemId}/success?response_id=${responseId || 'success'}`;
            
            // Adicionar dados b√°sicos se dispon√≠veis
            const fallbackParams = new URLSearchParams();
            if (responseId) fallbackParams.append('response_id', responseId);
            if (data.name) fallbackParams.append('data_name', encodeURIComponent(data.name));
            if (data.email) fallbackParams.append('data_email', encodeURIComponent(data.email));
            
            const finalFallbackUrl = fallbackParams.toString() 
                ? `${fallbackSuccessUrl}&${fallbackParams.toString()}` 
                : fallbackSuccessUrl;
            
            console.log('üîÑ [SUBMIT] Redirecionando via fallback para:', finalFallbackUrl);
            
            // Redirecionar imediatamente (usar replace para n√£o adicionar ao hist√≥rico)
            setTimeout(() => {
                window.location.replace(finalFallbackUrl);
            }, 500); // Pequeno delay para garantir que o loading state seja visto
        });
        } else {
            console.error('‚ùå [FORM] Formul√°rio n√£o encontrado!');
        }
        
        // Bot√£o "Enviar Mensagem para o Pastor"
        <% if (formData.enable_pastor_button && formData.pastor_whatsapp_number) { %>
        const pastorBtn = document.getElementById('pastor-message-btn');
        if (pastorBtn) {
            pastorBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                
                const pastorWhatsapp = '<%= formData.pastor_whatsapp_number || '' %>';
                if (!pastorWhatsapp) {
                    alert('N√∫mero do WhatsApp do pastor n√£o configurado!');
                    return;
                }
                
                // Validar formul√°rio antes de enviar
                const validation = validateForm();
                if (!validation.isValid) {
                    const firstError = document.querySelector('.field-error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    
                    const submitBtn = document.getElementById('pastor-message-btn');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Corrija os erros acima';
                    submitBtn.style.background = '#d32f2f';
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.style.background = '';
                    }, 3000);
                    
                    return;
                }
                
                // Coletar dados do formul√°rio (mesmo processo do bot√£o normal)
                const form = document.getElementById('digital-form');
                const formData = new FormData(form);
                const data = {};
                const responseData = {};
                
                let currentFormFields = window.formFields || formDataObj.form_fields || [];
                if (typeof currentFormFields === 'string') {
                    try {
                        currentFormFields = JSON.parse(currentFormFields);
                    } catch (e) {
                        currentFormFields = [];
                    }
                }
                if (!Array.isArray(currentFormFields)) {
                    currentFormFields = [];
                }
                
                // Coletar todos os campos (mesmo c√≥digo do submit normal)
                for (const [key, value] of formData.entries()) {
                    const field = currentFormFields.find(f => {
                        const fieldId = f.id || `field_${currentFormFields.indexOf(f)}`;
                        return fieldId === key;
                    });
                    if (field) {
                        if (field.type === 'checkbox') {
                            if (!responseData[key]) responseData[key] = [];
                            responseData[key].push(value);
                        } else {
                            responseData[key] = value;
                        }
                        data[key] = responseData[key];
                    } else {
                        data[key] = value;
                    }
                }
                
                currentFormFields.forEach((field, index) => {
                    const fieldId = field.id || `field_${index}`;
                    
                    if (field.type === 'checkbox') {
                        const checkboxes = document.querySelectorAll(`input[name="${fieldId}"]:checked`);
                        if (checkboxes.length > 0) {
                            responseData[fieldId] = Array.from(checkboxes).map(cb => cb.value);
                            data[fieldId] = responseData[fieldId].join(', ');
                        }
                    } else if (field.type === 'multiple_choice' || field.type === 'yes_no' || field.type === 'linear_scale' || field.type === 'rating') {
                        const selected = document.querySelector(`input[name="${fieldId}"]:checked`);
                        if (selected) {
                            responseData[fieldId] = selected.value;
                            data[fieldId] = selected.value;
                        }
                    } else {
                        const input = document.querySelector(`#field-${index}`);
                        if (input && input.value) {
                            responseData[fieldId] = input.value;
                            data[fieldId] = input.value;
                        }
                    }
                });
                
                // Salvar resposta no servidor
                try {
                    const submitResponse = await fetch(`/<%= typeof profileSlug !== 'undefined' && profileSlug ? profileSlug : slug %>/form/<%= item.id %>/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            response_data: responseData,
                            responder_name: data.name || null,
                            responder_email: data.email || null,
                            responder_phone: data.phone || null,
                            session_id: sessionId
                        })
                    });
                    
                    if (!submitResponse.ok) {
                        console.error('Erro ao salvar resposta no servidor');
                    }
                } catch (error) {
                    console.error('Erro ao salvar resposta:', error);
                }
                
                // Formatar mensagem para WhatsApp do Pastor
                let message = `*${formDataObj.form_title || 'King Forms'}*\n\n`;
                message += '*Mensagem para o Pastor*\n\n';
                
                currentFormFields.forEach((field, index) => {
                    const fieldId = field.id || `field_${index}`;
                    const fieldValue = data[fieldId];
                    if (fieldValue) {
                        const fieldLabel = field.label || field.Label || 'Campo';
                        if (Array.isArray(fieldValue)) {
                            message += `*${fieldLabel}:* ${fieldValue.join(', ')}\n`;
                        } else {
                            message += `*${fieldLabel}:* ${fieldValue}\n`;
                        }
                    }
                });
                
                // Limpar n√∫mero do WhatsApp do pastor (apenas n√∫meros)
                const cleanPastorWhatsapp = pastorWhatsapp.replace(/\D/g, '');
                const pastorWhatsappUrl = `https://wa.me/${cleanPastorWhatsapp}?text=${encodeURIComponent(message)}`;
                
                // Abrir WhatsApp do Pastor
                window.open(pastorWhatsappUrl, '_blank');
            });
        }
        <% } %>
        
        // Bot√£o "Enviar via WhatsApp" - SEMPRE salva no sistema tamb√©m
        const whatsappBtn = document.getElementById('whatsapp-submit-btn');
        if (whatsappBtn) {
            whatsappBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                
                // Validar formul√°rio antes de enviar
                const validation = validateForm();
                if (!validation.isValid) {
                    const firstError = document.querySelector('.field-error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    showErrorMessage('Por favor, corrija os erros destacados acima antes de enviar.');
                    return;
                }
                
                const originalHTML = showLoadingState(whatsappBtn, 'Salvando...');
                
                // Coletar dados do formul√°rio
                const form = document.getElementById('digital-form');
                const formData = new FormData(form);
                const data = {};
                const responseData = {};
                
                let currentFormFields = window.formFields || formDataObj.form_fields || [];
                if (typeof currentFormFields === 'string') {
                    try {
                        currentFormFields = JSON.parse(currentFormFields);
                    } catch (e) {
                        currentFormFields = [];
                    }
                }
                if (!Array.isArray(currentFormFields)) {
                    currentFormFields = [];
                }
                
                // Coletar todos os campos
                for (const [key, value] of formData.entries()) {
                    const field = currentFormFields.find(f => {
                        const fieldId = f.id || `field_${currentFormFields.indexOf(f)}`;
                        return fieldId === key;
                    });
                    if (field) {
                        if (field.type === 'checkbox') {
                            if (!responseData[key]) responseData[key] = [];
                            responseData[key].push(value);
                        } else {
                            responseData[key] = value;
                        }
                        data[key] = responseData[key];
                    } else {
                        data[key] = value;
                    }
                }
                
                currentFormFields.forEach((field, index) => {
                    const fieldId = field.id || `field_${index}`;
                    
                    if (field.type === 'checkbox') {
                        const checkboxes = document.querySelectorAll(`input[name="${fieldId}"]:checked`);
                        if (checkboxes.length > 0) {
                            responseData[fieldId] = Array.from(checkboxes).map(cb => cb.value);
                            data[fieldId] = responseData[fieldId].join(', ');
                        }
                    } else if (field.type === 'multiple_choice' || field.type === 'yes_no' || field.type === 'linear_scale' || field.type === 'rating') {
                        const selected = document.querySelector(`input[name="${fieldId}"]:checked`);
                        if (selected) {
                            responseData[fieldId] = selected.value;
                            data[fieldId] = selected.value;
                        }
                    } else {
                        const input = document.querySelector(`#field-${index}`);
                        if (input && input.value) {
                            responseData[fieldId] = input.value;
                            data[fieldId] = input.value;
                        }
                    }
                });
                
                // IMPORTANTE: Sempre salvar no sistema primeiro
                try {
                    showLoadingState(whatsappBtn, 'Salvando no sistema...');
                    const submitResponse = await fetch(`/${slug}/form/${itemId}/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            response_data: responseData,
                            responder_name: data.name || null,
                            responder_email: data.email || null,
                            responder_phone: data.phone || null,
                            session_id: sessionId
                        })
                    });
                    
                    if (!submitResponse.ok) {
                        const errorData = await submitResponse.json().catch(() => ({ message: 'Erro desconhecido' }));
                        throw new Error(errorData.message || 'Erro ao salvar resposta no servidor');
                    }
                    
                    const submitResult = await submitResponse.json();
                    console.log('‚úÖ [WHATSAPP] Resposta salva no sistema:', submitResult);
                    
                    // Obter responseId do resultado
                    const responseId = submitResult.response_id || submitResult.id || null;
                    
                    // Formatar mensagem para WhatsApp
                    let message = `*${formDataObj.form_title || 'King Forms'}*\n\n`;
                    
                    currentFormFields.forEach((field, index) => {
                        const fieldId = field.id || `field_${index}`;
                        const fieldValue = data[fieldId];
                        if (fieldValue) {
                            const fieldLabel = field.label || field.Label || 'Campo';
                            if (Array.isArray(fieldValue)) {
                                message += `*${fieldLabel}:* ${fieldValue.join(', ')}\n`;
                            } else {
                                message += `*${fieldLabel}:* ${fieldValue}\n`;
                            }
                        }
                    });
                    
                    // Limpar n√∫mero do WhatsApp (apenas n√∫meros)
                    const cleanWhatsapp = whatsappNumber.replace(/\D/g, '');
                    const whatsappUrl = `https://wa.me/${cleanWhatsapp}?text=${encodeURIComponent(message)}`;
                    
                    // IMPORTANTE: Sempre redirecionar para p√°gina de sucesso, mesmo quando envia por WhatsApp
                    // Isso garante que o QR Code e outras informa√ß√µes apare√ßam
                    const successUrl = submitResult.success_page_url || `/${slug}/form/${itemId}/success?response_id=${responseId || ''}`;
                
                // Passar dados do formul√°rio via URL para mostrar na p√°gina de sucesso
                const formDataParams = new URLSearchParams();
                formDataParams.append('response_id', responseId || '');
                formDataParams.append('whatsapp_sent', 'true');
                
                // Adicionar dados do formul√°rio para exibir na p√°gina de sucesso
                Object.keys(data).forEach(key => {
                    if (data[key] && typeof data[key] === 'string' && data[key].trim() !== '') {
                        try {
                            formDataParams.append(`data_${key}`, encodeURIComponent(data[key]));
                        } catch (e) {
                            console.warn('‚ö†Ô∏è [WHATSAPP] Erro ao codificar dado para URL:', key, e);
                        }
                    }
                });
                
                // Montar URL final
                const separator = successUrl.includes('?') ? '&' : '?';
                const finalUrl = `${successUrl}${separator}${formDataParams.toString()}`;
                
                // Abrir WhatsApp em nova aba
                window.open(whatsappUrl, '_blank');
                
                // Redirecionar para p√°gina de sucesso ap√≥s pequeno delay para garantir que dados foram salvos
                setTimeout(() => {
                    window.location.replace(finalUrl);
                }, 500);
            });
        }
    </script>
    
    <!-- Rodap√© com Direitos Autorais -->
    <% 
        // Determinar tema para ajustar cores do rodap√© - l√≥gica melhorada e mais robusta
        let isDarkTheme = false;
        
        // Verificar tema expl√≠cito primeiro
        if (formData.theme === 'dark') {
            isDarkTheme = true;
        } else if (formData.theme === 'light') {
            isDarkTheme = false;
        } else if (formData.background_color) {
            // Analisar cor de fundo para determinar tema
            const bgColor = formData.background_color.toLowerCase().trim();
            
            // Verificar se √© um tom escuro
            // Tons escuros: come√ßa com #0, #1, #2, #3, #4, #5 ou cont√©m palavras-chave
            const darkPatterns = [
                /^#[0-5][0-9a-f]/,  // #0x, #1x, #2x, #3x, #4x, #5x
                /dark/i,
                /black/i,
                /preto/i,
                /#0d/i,
                /#1c/i,
                /#2c/i,
                /rgb\(0,\s*0,\s*0\)/i,
                /rgb\(13,\s*13,\s*15\)/i,
                /rgb\(28,\s*28,\s*33\)/i
            ];
            
            const isDarkColor = darkPatterns.some(pattern => pattern.test(bgColor));
            
            // Verificar se √© um tom claro
            // Tons claros: come√ßa com #f, #e, #d, #c, #b, #a, #9, #8, #7, #6 ou branco
            const lightPatterns = [
                /^#[6-9a-f][0-9a-f]/,  // #6x, #7x, #8x, #9x, #ax, #bx, #cx, #dx, #ex, #fx
                /white/i,
                /branco/i,
                /#fff/i,
                /#f8/i,
                /#fa/i,
                /rgb\(255,\s*255,\s*255\)/i,
                /rgb\(248,\s*249,\s*250\)/i
            ];
            
            const isLightColor = lightPatterns.some(pattern => pattern.test(bgColor));
            
            if (isDarkColor) {
                isDarkTheme = true;
            } else if (isLightColor) {
                isDarkTheme = false;
            } else {
                // Se n√£o conseguir determinar, usar padr√£o baseado no valor do tema
                isDarkTheme = formData.theme === 'dark';
            }
        } else {
            // Padr√£o: tema claro se n√£o especificado
            isDarkTheme = false;
        }
        
        // Cores do rodap√© baseadas no tema - garantindo contraste adequado
        const footerBg = isDarkTheme ? '#1C1C21' : '#f8f9fa';
        const footerTextMain = isDarkTheme ? '#ECECEC' : '#1a1a1a'; // Texto principal sempre vis√≠vel
        const footerTextSecondary = isDarkTheme ? '#A1A1A1' : '#4a4a4a'; // Texto secund√°rio com bom contraste
        const footerTextTertiary = isDarkTheme ? '#7a7a7a' : '#6b6b6b'; // Texto terci√°rio leg√≠vel
        const footerBorder = isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)';
        const footerPrimaryColor = isDarkTheme ? '#4A90E2' : (primaryColor || '#4A90E2');
    %>
    <footer style="margin-top: 60px; padding: 40px 24px; text-align: center; border-top: 1px solid <%= footerBorder %>; background: <%= footerBg %> !important;">
        <div style="max-width: 1000px; margin: 0 auto;">
            <p style="margin: 0 0 12px 0; color: <%= footerTextMain %> !important; font-size: 15px; line-height: 1.7; font-weight: 600;">
                <span style="color: <%= footerPrimaryColor %> !important; font-weight: 700; font-size: 16px;">King Forms</span> 
                <span style="color: <%= footerTextSecondary %> !important;">√© um sistema desenvolvido pela</span> 
                <span style="color: <%= footerPrimaryColor %> !important; font-weight: 700;">Conecta King</span>
            </p>
            <p style="margin: 0; color: <%= footerTextTertiary %> !important; font-size: 13px; line-height: 1.6; font-weight: 500;">
                ¬© <%= new Date().getFullYear() %> Conecta King. Todos os direitos reservados.
            </p>
            <p style="margin: 8px 0 0 0; color: <%= footerTextTertiary %> !important; font-size: 12px; line-height: 1.5; font-weight: 400;">
                Solu√ß√£o premium para cria√ß√£o de formul√°rios digitais profissionais.
            </p>
        </div>
    </footer>
</body>
</html>

