<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title><%= formData.form_title || 'Formulário Digital' %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/css/digitalForm.css">
    <style>
        :root {
            --primary-color: <%= formData.primary_color || '#4A90E2' %>;
            --text-color: <%= formData.text_color || '#333333' %>;
            --theme: <%= formData.theme || 'light' %>;
        }
        <% if (formData.background_image_url) { %>
        body {
            background-image: url('<%= formData.background_image_url %>');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, <%= 1 - (formData.background_opacity || 1.0) %>);
            z-index: -1;
        }
        <% } %>
        <% if (formData.header_image_url) { %>
        .header-image-container {
            position: relative;
            width: 100%;
            overflow: hidden;
        }
        .header-image {
            width: 100%;
            height: auto;
            min-height: 280px;
            max-height: 500px;
            object-fit: cover;
            display: block;
        }
        .header-image-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.3));
            pointer-events: none;
        }
        <% } %>
    </style>
</head>
<body class="digital-form-page theme-<%= formData.theme || 'light' %>" data-form-id="<%= item.id %>" data-whatsapp="<%= formData.whatsapp_number || '' %>">
    <!-- Header Image -->
    <% if (formData.header_image_url) { %>
    <div class="header-image-container">
        <img src="<%= formData.header_image_url %>" alt="Header" class="header-image">
    </div>
    <% } %>
    
    <!-- Header -->
    <header class="form-header">
        <div class="container">
            <% if (typeof profileSlug !== 'undefined' && profileSlug) { %>
            <a href="/<%= profileSlug %>" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Voltar</span>
            </a>
            <% } %>
            <% if (formData.form_logo_url) { %>
            <img src="<%= formData.form_logo_url %>" alt="Logo" class="form-logo">
            <% } %>
            <h1 class="form-title"><%= formData.form_title || 'Formulário King' %></h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="form-container">
        <div class="container">
            <!-- Descrição -->
            <% if (formData.form_description) { %>
            <div class="form-description">
                <p><%= formData.form_description %></p>
            </div>
            <% } %>

            <!-- Formulário -->
            <form id="digital-form" class="digital-form">
                <!-- Campos Dinâmicos (form_fields) -->
                <div id="dynamic-fields-container"></div>

                <!-- Botão Enviar -->
                <button type="submit" class="submit-btn">
                    <i class="fab fa-whatsapp"></i>
                    <span>Enviar via WhatsApp</span>
                </button>
            </form>
        </div>
    </main>

    <script>
        // Dados do formulário
        const formDataObj = <%- JSON.stringify(formData) %>;
        const whatsappNumber = '<%= formData.whatsapp_number || '' %>';
        const itemId = <%= itemId || item.id %>;
        const slug = '<%= typeof profileSlug !== 'undefined' && profileSlug ? profileSlug : slug %>';
        
        // Gerar session ID único
        let sessionId = sessionStorage.getItem('form_session_id');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('form_session_id', sessionId);
        }
        
        // Função para registrar eventos de analytics
        async function trackEvent(eventType) {
            try {
                await fetch(`/${slug}/form/${itemId}/analytics`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_type: eventType,
                        session_id: sessionId
                    })
                });
            } catch (error) {
                console.error('Erro ao registrar analytics:', error);
                // Não bloquear a experiência se analytics falhar
            }
        }
        
        // Registrar view quando a página carregar
        trackEvent('view');
        
        // Registrar start quando o usuário começar a interagir com o formulário
        let formStarted = false;
        document.addEventListener('focusin', function(e) {
            if (e.target.closest('#digital-form') && !formStarted) {
                formStarted = true;
                trackEvent('start');
            }
        }, true);

        // Carregar campos dinâmicos se existirem
        let formFields = formDataObj.form_fields || [];
        
        // Garantir que formFields seja um array
        if (typeof formFields === 'string') {
            try {
                formFields = JSON.parse(formFields);
            } catch (e) {
                console.error('Erro ao parsear form_fields:', e);
                formFields = [];
            }
        }
        if (!Array.isArray(formFields)) {
            formFields = [];
        }
        
        console.log('Form fields carregados:', formFields);
        const container = document.getElementById('dynamic-fields-container');
        
        if (!formFields || formFields.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-color, #666); padding: 40px;">Nenhum campo configurado neste formulário.</p>';
        } else {
            formFields.forEach((field, index) => {
                const group = document.createElement('div');
                group.className = 'form-group';
                group.dataset.fieldType = field.type;
                group.dataset.fieldId = field.id || `field_${index}`;
                
                let fieldHTML = `<label for="field-${index}">${field.label || 'Campo'} ${field.required ? '<span class="required">*</span>' : ''}</label>`;
                
                switch(field.type) {
                    case 'short_text':
                        fieldHTML += `<input type="text" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}">`;
                        break;
                    case 'paragraph':
                        fieldHTML += `<textarea id="field-${index}" name="${field.id || `field_${index}`}" rows="4" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}"></textarea>`;
                        break;
                    case 'multiple_choice':
                        if (field.options && field.options.length > 0) {
                            field.options.forEach((opt, optIdx) => {
                                fieldHTML += `
                                    <label class="radio-label">
                                        <input type="radio" name="${field.id || `field_${index}`}" value="${opt}" ${field.required ? 'required' : ''}>
                                        <span>${opt}</span>
                                    </label>
                                `;
                            });
                        }
                        break;
                    case 'checkbox':
                        if (field.options && field.options.length > 0) {
                            field.options.forEach((opt, optIdx) => {
                                fieldHTML += `
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="${field.id || `field_${index}`}" value="${opt}">
                                        <span>${opt}</span>
                                    </label>
                                `;
                            });
                        }
                        break;
                    case 'dropdown':
                        fieldHTML += `<select id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''}><option value="">Selecione...</option>`;
                        if (field.options && field.options.length > 0) {
                            field.options.forEach(opt => {
                                fieldHTML += `<option value="${opt}">${opt}</option>`;
                            });
                        }
                        fieldHTML += `</select>`;
                        break;
                    case 'yes_no':
                        fieldHTML += `
                            <div class="yes-no-group">
                                <label class="radio-label">
                                    <input type="radio" name="${field.id || `field_${index}`}" value="sim" ${field.required ? 'required' : ''}>
                                    <span>Sim</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="${field.id || `field_${index}`}" value="não" ${field.required ? 'required' : ''}>
                                    <span>Não</span>
                                </label>
                            </div>
                        `;
                        break;
                    case 'date':
                        fieldHTML += `<input type="date" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''}>`;
                        break;
                    case 'time':
                        fieldHTML += `<input type="time" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''}>`;
                        break;
                    case 'datetime':
                        fieldHTML += `<input type="datetime-local" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''}>`;
                        break;
                    case 'email':
                        fieldHTML += `<input type="email" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || 'exemplo@email.com'}">`;
                        break;
                    case 'number':
                        fieldHTML += `<input type="number" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}" ${field.min !== undefined ? `min="${field.min}"` : ''} ${field.max !== undefined ? `max="${field.max}"` : ''}>`;
                        break;
                    case 'phone':
                        fieldHTML += `<input type="tel" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || '(00) 00000-0000'}">`;
                        break;
                    case 'url':
                        fieldHTML += `<input type="url" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || 'https://exemplo.com'}">`;
                        break;
                    case 'linear_scale':
                        const min = field.min || 1;
                        const max = field.max || 5;
                        fieldHTML += `<div class="linear-scale-group">`;
                        fieldHTML += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; color: var(--text-dark, #666);"><span>${min}</span><span>${max}</span></div>`;
                        for (let i = min; i <= max; i++) {
                            fieldHTML += `
                                <label class="radio-label">
                                    <input type="radio" name="${field.id || `field_${index}`}" value="${i}" ${field.required ? 'required' : ''}>
                                    <span>${i}</span>
                                </label>
                            `;
                        }
                        fieldHTML += `</div>`;
                        break;
                    case 'rating':
                        const ratingMax = field.max || 5;
                        fieldHTML += `<div class="rating-group">`;
                        for (let i = 1; i <= ratingMax; i++) {
                            fieldHTML += `<input type="radio" name="${field.id || `field_${index}`}" value="${i}" id="rating-${index}-${i}" ${field.required ? 'required' : ''}><label for="rating-${index}-${i}">★</label>`;
                        }
                        fieldHTML += `</div>`;
                        break;
                    case 'file_upload':
                        fieldHTML += `<input type="file" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''} accept="${field.accept || '*/*'}" style="padding: 12px; border: 1.5px solid #dadce0; border-radius: 12px; background: white; cursor: pointer;">`;
                        break;
                    case 'multiple_choice_grid':
                        if (field.rows && field.columns) {
                            fieldHTML += `<div class="choice-grid" style="overflow-x: auto;">`;
                            fieldHTML += `<table style="width: 100%; border-collapse: collapse; min-width: 500px;">`;
                            fieldHTML += `<thead><tr><th style="padding: 12px; text-align: left; border-bottom: 2px solid #dadce0;"></th>`;
                            field.columns.forEach(col => {
                                fieldHTML += `<th style="padding: 12px; text-align: center; border-bottom: 2px solid #dadce0;">${col}</th>`;
                            });
                            fieldHTML += `</tr></thead><tbody>`;
                            field.rows.forEach(row => {
                                fieldHTML += `<tr><td style="padding: 12px; font-weight: 600;">${row}</td>`;
                                field.columns.forEach(col => {
                                    fieldHTML += `<td style="padding: 12px; text-align: center;"><input type="radio" name="${field.id || `field_${index}`}_${row}" value="${col}" ${field.required ? 'required' : ''}></td>`;
                                });
                                fieldHTML += `</tr>`;
                            });
                            fieldHTML += `</tbody></table></div>`;
                        }
                        break;
                    case 'checkbox_grid':
                        if (field.rows && field.columns) {
                            fieldHTML += `<div class="checkbox-grid" style="overflow-x: auto;">`;
                            fieldHTML += `<table style="width: 100%; border-collapse: collapse; min-width: 500px;">`;
                            fieldHTML += `<thead><tr><th style="padding: 12px; text-align: left; border-bottom: 2px solid #dadce0;"></th>`;
                            field.columns.forEach(col => {
                                fieldHTML += `<th style="padding: 12px; text-align: center; border-bottom: 2px solid #dadce0;">${col}</th>`;
                            });
                            fieldHTML += `</tr></thead><tbody>`;
                            field.rows.forEach(row => {
                                fieldHTML += `<tr><td style="padding: 12px; font-weight: 600;">${row}</td>`;
                                field.columns.forEach(col => {
                                    fieldHTML += `<td style="padding: 12px; text-align: center;"><input type="checkbox" name="${field.id || `field_${index}`}_${row}" value="${col}"></td>`;
                                });
                                fieldHTML += `</tr>`;
                            });
                            fieldHTML += `</tbody></table></div>`;
                        }
                        break;
                    default:
                        fieldHTML += `<input type="text" id="field-${index}" name="${field.id || `field_${index}`}" ${field.required ? 'required' : ''} placeholder="${field.placeholder || ''}">`;
                }
                
                group.innerHTML = fieldHTML;
                container.appendChild(group);
            });
            
            // Adicionar classe 'checked' aos labels quando inputs são marcados (fallback para :has())
            setTimeout(() => {
                document.querySelectorAll('.radio-label input[type="radio"], .checkbox-label input[type="checkbox"]').forEach(input => {
                    input.addEventListener('change', function() {
                        // Remover 'checked' de todos os irmãos do mesmo grupo (para radio)
                        if (this.type === 'radio') {
                            const name = this.name;
                            document.querySelectorAll(`input[type="radio"][name="${name}"]`).forEach(radio => {
                                radio.closest('.radio-label')?.classList.remove('checked');
                            });
                        }
                        // Adicionar/remover 'checked' baseado no estado
                        if (this.checked) {
                            this.closest('.radio-label, .checkbox-label')?.classList.add('checked');
                        } else {
                            this.closest('.checkbox-label')?.classList.remove('checked');
                        }
                    });
                });
            }, 100);
        }

        // Formatar WhatsApp
        function formatWhatsApp(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d+)/, '($1) $2');
            }
            input.value = value;
        }

        const whatsappInput = document.getElementById('form-whatsapp');
        if (whatsappInput) {
            whatsappInput.addEventListener('input', () => formatWhatsApp(whatsappInput));
        }

        // Enviar formulário
        document.getElementById('digital-form').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!whatsappNumber) {
                alert('Número do WhatsApp não configurado!');
                return;
            }

            // Coletar dados do formulário
            const formDataObj = new FormData(this);
            const data = {};
            const responseData = {};

            // Coletar todos os campos
            for (const [key, value] of formDataObj.entries()) {
                // Verificar se é um campo dinâmico
                const field = formFields.find(f => (f.id || `field_${formFields.indexOf(f)}`) === key);
                if (field) {
                    if (field.type === 'checkbox') {
                        if (!responseData[key]) responseData[key] = [];
                        responseData[key].push(value);
                    } else {
                        responseData[key] = value;
                    }
                    data[key] = responseData[key];
                } else {
                    data[key] = value;
                }
            }
            
            // Coletar dados de todos os campos
            formFields.forEach((field, index) => {
                const fieldId = field.id || `field_${index}`;
                
                if (field.type === 'checkbox') {
                    // Checkboxes: múltiplos valores
                    const checkboxes = document.querySelectorAll(`input[name="${fieldId}"]:checked`);
                    if (checkboxes.length > 0) {
                        responseData[fieldId] = Array.from(checkboxes).map(cb => cb.value);
                        data[fieldId] = responseData[fieldId].join(', ');
                    }
                } else if (field.type === 'multiple_choice_grid' || field.type === 'checkbox_grid') {
                    // Grids: estrutura complexa
                    const gridData = {};
                    if (field.rows) {
                        field.rows.forEach(row => {
                            const rowName = `${fieldId}_${row}`;
                            if (field.type === 'multiple_choice_grid') {
                                const selected = document.querySelector(`input[name="${rowName}"]:checked`);
                                if (selected) {
                                    gridData[row] = selected.value;
                                }
                            } else {
                                const selected = document.querySelectorAll(`input[name="${rowName}"]:checked`);
                                if (selected.length > 0) {
                                    gridData[row] = Array.from(selected).map(cb => cb.value);
                                }
                            }
                        });
                        if (Object.keys(gridData).length > 0) {
                            responseData[fieldId] = gridData;
                            // Formatar para WhatsApp
                            let gridText = '';
                            Object.entries(gridData).forEach(([row, value]) => {
                                gridText += `${row}: ${Array.isArray(value) ? value.join(', ') : value}\n`;
                            });
                            data[fieldId] = gridText.trim();
                        }
                    }
                } else if (field.type === 'multiple_choice' || field.type === 'yes_no' || field.type === 'linear_scale' || field.type === 'rating') {
                    // Radio buttons: valor único
                    const selected = document.querySelector(`input[name="${fieldId}"]:checked`);
                    if (selected) {
                        responseData[fieldId] = selected.value;
                        data[fieldId] = selected.value;
                    }
                } else {
                    // Campos de texto, número, data, etc.
                    const input = document.querySelector(`#field-${index}`);
                    if (input && input.value) {
                        responseData[fieldId] = input.value;
                        data[fieldId] = input.value;
                    }
                }
            });
            
            // Enviar para o servidor
            try {
                const submitResponse = await fetch(`/<%= typeof profileSlug !== 'undefined' && profileSlug ? profileSlug : slug %>/form/<%= item.id %>/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        response_data: responseData,
                        responder_name: data.name || null,
                        responder_email: data.email || null,
                        responder_phone: data.phone || null,
                        session_id: sessionId
                    })
                });
                
                if (!submitResponse.ok) {
                    console.error('Erro ao salvar resposta no servidor');
                }
            } catch (error) {
                console.error('Erro ao salvar resposta:', error);
            }

            // Formatando mensagem para WhatsApp
            let message = `*${formDataObj.form_title || 'Formulário King'}*\n\n`;
            
            // Adicionar respostas dos campos dinâmicos
            formFields.forEach((field, index) => {
                const fieldId = field.id || `field_${index}`;
                const fieldValue = data[fieldId];
                if (fieldValue) {
                    if (Array.isArray(fieldValue)) {
                        message += `*${field.label || 'Campo'}:* ${fieldValue.join(', ')}\n`;
                    } else {
                        message += `*${field.label || 'Campo'}:* ${fieldValue}\n`;
                    }
                }
            });

            // Limpar número do WhatsApp (apenas números)
            const cleanWhatsapp = whatsappNumber.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${cleanWhatsapp}?text=${encodeURIComponent(message)}`;
            
            // Abrir WhatsApp
            window.open(whatsappUrl, '_blank');
        });
    </script>
</body>
</html>

