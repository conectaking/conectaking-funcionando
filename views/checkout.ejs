<!DOCTYPE html>
<html class="dark" lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title><%= checkoutPageTitle ? checkoutPageTitle + ' - ' : '' %>Pagamento - <%= formTitle %><%= checkoutPageTitle ? '' : ' | KingForms' %></title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <style id="checkout-critical-css">
        /* CSS crítico: layout luxury mesmo sem Tailwind (CDN bloqueado/falha) */
        :root {
            --checkout-primary: <%= checkoutPagePrimaryColor || '#1152d4' %>;
            --checkout-bg-dark: #0a0a0a;
            --checkout-bg-light: #f6f6f8;
            --checkout-card: #161616;
            --checkout-gold: #c5a059;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            margin: 0;
            min-height: max(884px, 100dvh);
            background: var(--checkout-bg-dark);
            color: #fff;
        }
        body.dark { background: var(--checkout-bg-dark); color: #fff; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        .checkout-header {
            position: sticky; top: 0; z-index: 50;
            background: rgba(10,10,10,0.8); backdrop-filter: blur(12px);
            padding: 1rem 1rem 0.5rem;
        }
        .checkout-header-inner { display: flex; align-items: center; justify-content: space-between; max-width: 28rem; margin: 0 auto; }
        .checkout-stepper {
            display: flex; justify-content: space-between; align-items: center;
            max-width: 20rem; margin: 0 auto; padding: 1.5rem 0; position: relative;
        }
        .checkout-stepper::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 1px; background: #334155; transform: translateY(-50%); z-index: -1; }
        .checkout-step { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .checkout-step-dot { width: 8px; height: 8px; border-radius: 9999px; background: #475569; }
        .checkout-step-dot.current { width: 12px; height: 12px; background: var(--checkout-primary); box-shadow: 0 0 0 4px rgba(17,82,212,0.2); }
        .checkout-step span { font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; font-weight: 500; color: #94a3b8; }
        .checkout-step.current span { color: var(--checkout-primary); font-weight: 700; }
        .checkout-main { max-width: 28rem; margin: 0 auto; padding: 0 1.5rem 8rem; }
        .checkout-card {
            background: var(--checkout-card);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 1px solid rgba(255,255,255,0.05);
            margin-bottom: 1rem;
        }
        .checkout-card-inner { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .checkout-card-text { flex: 1; min-width: 0; }
        .checkout-card-label { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; font-weight: 600; color: var(--checkout-gold); margin-bottom: 0.25rem; }
        .checkout-card-title { font-size: 1rem; font-weight: 500; color: #fff; margin: 0 0 0.25rem; }
        .checkout-card-sub { font-size: 12px; color: #94a3b8; margin: 0; }
        .checkout-card-price { font-size: 1.125rem; font-weight: 700; color: #fff; margin-top: 1rem; }
        .checkout-card-img { width: 96px; height: 96px; flex-shrink: 0; border-radius: 0.5rem; background: #1e293b; background-size: cover; background-position: center; }
        .checkout-section-title { font-size: 1.25rem; font-weight: 300; letter-spacing: 0.05em; color: #fff; margin: 1.5rem 0 0.25rem; }
        .checkout-section-sub { font-size: 12px; color: #64748b; margin: 0 0 1rem; }
        .checkout-methods { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
        .checkout-method { flex: 1; padding: 1rem; border-radius: 0.75rem; border: 2px solid #1e293b; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
        .checkout-method.selected { border-color: var(--checkout-primary); background: rgba(17,82,212,0.1); }
        .checkout-totals { margin-top: 2.5rem; }
        .checkout-totals div { display: flex; justify-content: space-between; align-items: center; font-size: 14px; margin-bottom: 0.75rem; }
        .checkout-totals .total-row { padding-top: 1rem; border-top: 1px solid #1e293b; margin-top: 0.5rem; font-size: 1rem; }
        .checkout-totals .total-row span:last-child { font-size: 1.25rem; font-weight: 700; }
        .checkout-shipping { color: var(--checkout-gold) !important; font-size: 10px !important; letter-spacing: 0.1em; text-transform: uppercase; font-weight: 600; }
        .checkout-trust { display: flex; justify-content: center; align-items: center; gap: 1.5rem; margin-top: 2rem; opacity: 0.4; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; font-weight: 700; color: #94a3b8; }
        .checkout-cta {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 1.5rem; background: linear-gradient(to top, var(--checkout-bg-dark), transparent); padding-top: 2.5rem;
        }
        .checkout-cta button, .checkout-cta .checkout-cta-btn {
            display: flex; align-items: center; justify-content: center; gap: 0.75rem;
            width: 100%; max-width: 28rem; margin: 0 auto;
            height: 4rem; background: #fff; color: #000;
            border: none; border-radius: 0.75rem; font-family: inherit;
            font-size: 12px; font-weight: 600; letter-spacing: 0.2em; text-transform: uppercase;
            cursor: pointer; transition: transform 0.05s, box-shadow 0.2s;
        }
        .checkout-cta button:hover, .checkout-cta .checkout-cta-btn:hover { box-shadow: 0 0 0 2px var(--checkout-gold); }
        .checkout-cta p { text-align: center; font-size: 10px; color: #64748b; margin: 1rem 0 0; letter-spacing: 0.05em; }
        .checkout-input { width: 100%; height: 3.5rem; padding: 0 1rem; border-radius: 0.5rem; border: 1px solid #1e293b; background: transparent; color: #fff; font-size: 1rem; font-family: inherit; margin-top: 0.25rem; }
        .checkout-input::placeholder { color: #64748b; }
        .checkout-input:focus { outline: none; border-color: var(--checkout-primary); box-shadow: 0 0 0 1px var(--checkout-primary); }
        .checkout-label { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; font-weight: 600; color: #94a3b8; margin-left: 4px; display: block; margin-bottom: 0.25rem; }
        .checkout-grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .checkout-btn-primary { background: var(--checkout-primary) !important; color: #fff !important; border: 2px solid var(--checkout-primary) !important; }
    </style>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script type="text/tailwind-config">
        ({
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '<%= checkoutPagePrimaryColor || "#1152d4" %>',
                        'accent-gold': '#c5a059',
                        'background-light': '#f6f6f8',
                        'background-dark': '#0a0a0a',
                        'card-dark': '#161616',
                    },
                    fontFamily: { display: ['Manrope', 'sans-serif'] },
                    borderRadius: { DEFAULT: '0.25rem', lg: '0.5rem', xl: '0.75rem', full: '9999px' },
                },
            },
        })
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24; }
        .focus-primary:focus { border-color: <%= checkoutPagePrimaryColor || '#1152d4' %>; box-shadow: 0 0 0 1px <%= checkoutPagePrimaryColor || '#1152d4' %>; }
        .method-card.selected { border-color: <%= checkoutPagePrimaryColor || '#1152d4' %>; }
    </style>
</head>
<body class="dark bg-background-light dark:bg-background-dark text-slate-900 dark:text-white min-h-screen">
<!-- Top Navigation Bar -->
<div class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md">
    <div class="flex items-center p-4 pb-2 justify-between max-w-md mx-auto">
        <a href="<%= baseUrl %>/<%= slug %>/form/<%= itemId %>" class="text-slate-900 dark:text-white flex size-10 items-center justify-center cursor-pointer">
            <span class="material-symbols-outlined">arrow_back_ios</span>
        </a>
        <h2 class="text-slate-900 dark:text-white text-lg font-light tracking-[0.2em] uppercase flex-1 text-center pr-10">Checkout</h2>
    </div>
    <!-- Progress Stepper -->
    <div class="flex w-full max-w-xs mx-auto flex-row items-center justify-between py-6 relative">
        <div class="absolute top-1/2 left-0 w-full h-[1px] bg-slate-200 dark:bg-slate-800 -z-10 translate-y-[-50%]"></div>
        <div class="flex flex-col items-center gap-2">
            <div class="h-2 w-2 rounded-full bg-slate-400 dark:bg-slate-600"></div>
            <span class="text-[10px] uppercase tracking-widest text-slate-400 dark:text-slate-600 font-medium">Resumo</span>
        </div>
        <div class="flex flex-col items-center gap-2">
            <div class="h-3 w-3 rounded-full bg-primary ring-4 ring-primary/20"></div>
            <span class="text-[10px] uppercase tracking-widest text-primary font-bold">Pagamento</span>
        </div>
        <div class="flex flex-col items-center gap-2">
            <div class="h-2 w-2 rounded-full bg-slate-200 dark:bg-slate-800"></div>
            <span class="text-[10px] uppercase tracking-widest text-slate-200 dark:text-slate-800 font-medium">Concluído</span>
        </div>
    </div>
</div>

<main class="max-w-md mx-auto pb-32">
    <!-- Order Summary Card (igual ao luxury reference) -->
    <div class="px-6 py-4">
        <div class="bg-white dark:bg-card-dark rounded-xl p-5 shadow-sm border border-slate-100 dark:border-white/5">
            <div class="flex items-center justify-between gap-4">
                <div class="flex flex-col gap-1 flex-1 min-w-0">
                    <p class="text-accent-gold text-[10px] uppercase tracking-[0.15em] font-semibold">Inscrição</p>
                    <p class="text-slate-900 dark:text-white text-base font-medium leading-tight tracking-tight truncate"><%= formTitle %></p>
                    <% if (responderName) { %><p class="text-slate-400 dark:text-slate-500 text-xs font-normal"><%= responderName %></p><% } %>
                    <div class="mt-4">
                        <span class="text-slate-900 dark:text-white text-lg font-bold tracking-tight" id="price-display">R$ <%= (priceCents / 100).toFixed(2).replace('.', ',') %></span>
                    </div>
                    <% if (paymentStatus === 'PAID') { %>
                    <span class="inline-flex items-center mt-2 text-xs font-semibold text-emerald-500">Pagamento confirmado</span>
                    <% } else { %>
                    <span class="inline-flex items-center mt-2 text-xs font-semibold text-amber-500">Pagamento pendente</span>
                    <% } %>
                </div>
                <div class="w-24 h-24 flex-shrink-0 bg-center bg-no-repeat bg-cover rounded-lg shadow-inner bg-slate-100 dark:bg-slate-800 overflow-hidden"<% if (formCoverImageUrl) { %> style="background-image: url('<%= formCoverImageUrl.replace(/'/g, '&#39;') %>');"<% } %>>
                    <% if (!formCoverImageUrl) { %><span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-600 w-full h-full flex items-center justify-center">image</span><% } %>
                </div>
            </div>
        </div>
    </div>

    <% if (paymentStatus === 'PAID') { %>
    <div class="px-6 py-8 text-center" id="paid-success-block" data-success-url="<%= baseUrl %>/<%= slug %>/form/<%= itemId %>/success?response_id=<%= submissionId %>&show_success_page=true">
        <p class="text-slate-500 dark:text-slate-400 mb-2">Obrigado! Seu pagamento foi confirmado.</p>
        <p class="text-slate-400 dark:text-slate-500 text-sm mb-6" id="redirect-countdown">Redirecionando para sua confirmação em <span id="countdown-n">3</span> segundos...</p>
        <a href="<%= baseUrl %>/<%= slug %>/form/<%= itemId %>/success?response_id=<%= submissionId %>&show_success_page=true" id="btn-continue-now" class="inline-flex items-center justify-center gap-2 w-full max-w-md mx-auto bg-slate-900 dark:bg-white text-white dark:text-black h-14 rounded-xl font-semibold tracking-wide uppercase text-sm">Continuar agora</a>
    </div>
    <script>
    (function() {
        var block = document.getElementById('paid-success-block');
        var successUrl = block && block.getAttribute('data-success-url') ? block.getAttribute('data-success-url') : (document.getElementById('btn-continue-now') && document.getElementById('btn-continue-now').href) || '';
        var n = 3, el = document.getElementById('countdown-n'), countdownEl = document.getElementById('redirect-countdown');
        var interval = setInterval(function() {
            n--; if (el) el.textContent = n;
            if (n <= 0) { clearInterval(interval); if (countdownEl) countdownEl.style.display = 'none'; if (successUrl) window.location.href = successUrl; }
        }, 1000);
    })();
    </script>
    <% } else { %>
    <!-- Section Title: Payment Method -->
    <div class="px-6 pt-6 pb-2">
        <h3 class="text-slate-900 dark:text-white tracking-[0.05em] text-xl font-light">Método de pagamento</h3>
        <p class="text-slate-500 text-xs mt-1">Transações criptografadas e seguras.</p>
    </div>

    <!-- Pix vs Cartão (tabs estilo luxury) -->
    <div class="px-6 flex gap-3 mb-4">
        <div class="method-card flex-1 rounded-xl p-4 border-2 border-slate-200 dark:border-slate-800 cursor-pointer transition-all selected" data-method="pix">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-xl">qr_code_2</span>
                <span class="font-semibold text-sm">Pix</span>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Instantâneo</p>
        </div>
        <div class="method-card flex-1 rounded-xl p-4 border-2 border-slate-200 dark:border-slate-800 cursor-pointer transition-all" data-method="card">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-xl">credit_card</span>
                <span class="font-semibold text-sm">Cartão</span>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Crédito ou débito</p>
        </div>
    </div>

    <div id="state-loading" class="px-6 py-8 text-center text-slate-500" style="display:none;">Carregando...</div>
    <div id="state-error" class="mx-6 mb-4 rounded-lg bg-red-500/10 border border-red-500/30 text-red-600 dark:text-red-400 px-4 py-3 text-sm" style="display:none;"></div>

    <!-- Pix Section -->
    <div id="pix-section" class="px-6">
        <div id="qrcode-container" style="display:none;" class="rounded-xl bg-slate-100 dark:bg-slate-800/50 p-6 text-center">
            <img id="qrcode-img" alt="QR Code Pix" class="mx-auto max-w-[220px] h-auto"/>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-3 break-all" id="pix-copy-text"></p>
            <button type="button" id="btn-copy-pix" class="mt-3 w-full rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-card-dark text-slate-900 dark:text-white h-12 font-medium text-sm">Copiar código Pix</button>
        </div>
        <button type="button" id="btn-generate-pix" class="w-full rounded-xl border-2 border-primary bg-primary/10 dark:bg-primary/20 text-primary h-14 font-semibold text-sm flex items-center justify-center gap-2">
            <span class="material-symbols-outlined">qr_code_2</span>
            Gerar QR Code Pix
        </button>
    </div>

    <!-- Payment Form (cartão - layout igual ao luxury: Cardholder, Number, Expiry+CVV 2 cols) -->
    <div id="card-section" class="px-6 space-y-4" style="display:none;">
        <div class="flex flex-col gap-2">
            <label class="text-slate-500 dark:text-slate-400 text-[11px] uppercase tracking-widest font-semibold ml-1">Nome no cartão</label>
            <input id="card-holder" type="text" placeholder="Como está no cartão" autocomplete="cc-name" class="w-full rounded-lg text-slate-900 dark:text-white border border-slate-200 dark:border-slate-800 bg-white dark:bg-transparent focus:border-primary focus:ring-1 focus:ring-primary h-14 px-4 text-base font-light placeholder:text-slate-300 dark:placeholder:text-slate-700"/>
        </div>
        <div class="flex flex-col gap-2">
            <label class="text-slate-500 dark:text-slate-400 text-[11px] uppercase tracking-widest font-semibold ml-1">Número do cartão</label>
            <div class="relative">
                <input id="card-number" type="text" placeholder="**** **** **** 4421" maxlength="19" autocomplete="cc-number" class="w-full rounded-lg text-slate-900 dark:text-white border border-slate-200 dark:border-slate-800 bg-white dark:bg-transparent focus:border-primary focus:ring-1 focus:ring-primary h-14 px-4 pr-12 text-base font-light tracking-[0.2em] placeholder:text-slate-300 dark:placeholder:text-slate-700"/>
                <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">credit_card</span>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-2">
                <label class="text-slate-500 dark:text-slate-400 text-[11px] uppercase tracking-widest font-semibold ml-1">Validade</label>
                <input id="card-expiry" type="text" placeholder="MM / AA" maxlength="7" autocomplete="cc-exp" class="w-full rounded-lg text-slate-900 dark:text-white border border-slate-200 dark:border-slate-800 bg-white dark:bg-transparent focus:border-primary focus:ring-1 focus:ring-primary h-14 px-4 text-base font-light placeholder:text-slate-300 dark:placeholder:text-slate-700"/>
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-slate-500 dark:text-slate-400 text-[11px] uppercase tracking-widest font-semibold ml-1">CVV</label>
                <input id="card-cvv" type="password" placeholder="***" maxlength="4" autocomplete="cc-csc" class="w-full rounded-lg text-slate-900 dark:text-white border border-slate-200 dark:border-slate-800 bg-white dark:bg-transparent focus:border-primary focus:ring-1 focus:ring-primary h-14 px-4 text-base font-light placeholder:text-slate-300 dark:placeholder:text-slate-700"/>
            </div>
        </div>
        <div class="flex flex-col gap-2">
            <label class="text-slate-500 dark:text-slate-400 text-[11px] uppercase tracking-widest font-semibold ml-1">CPF do titular</label>
            <input id="card-holder-cpf" type="text" placeholder="Apenas números" maxlength="14" class="w-full rounded-lg text-slate-900 dark:text-white border border-slate-200 dark:border-slate-800 bg-white dark:bg-transparent focus:border-primary focus:ring-1 focus:ring-primary h-14 px-4 text-base font-light placeholder:text-slate-300 dark:placeholder:text-slate-700"/>
        </div>
        <div class="flex flex-col gap-2" id="installments-wrap">
            <label class="text-slate-500 dark:text-slate-400 text-[11px] uppercase tracking-widest font-semibold ml-1">Parcelas (crédito)</label>
            <select id="card-installments" class="w-full rounded-lg text-slate-900 dark:text-white border border-slate-200 dark:border-slate-800 bg-white dark:bg-transparent focus:border-primary focus:ring-1 focus:ring-primary h-14 px-4 text-base font-light">
                <% for (var i = 1; i <= 12; i++) { %><option value="<%= i %>"><%= i %>x sem juros</option><% } %>
            </select>
        </div>
        <div class="flex gap-3 pt-2">
            <button type="button" id="btn-pay-credit" class="flex-1 rounded-xl bg-primary/20 dark:bg-primary/30 text-primary border-2 border-primary h-14 font-semibold text-sm flex items-center justify-center gap-2"><span class="material-symbols-outlined text-lg">credit_card</span> Crédito</button>
            <button type="button" id="btn-pay-debit" class="flex-1 rounded-xl border-2 border-slate-200 dark:border-slate-700 h-14 font-semibold text-sm flex items-center justify-center gap-2"><span class="material-symbols-outlined text-lg">account_balance</span> Débito</button>
        </div>
    </div>

    <!-- Order Totals (igual ao luxury: Subtotal, Insured Shipping Complimentary, Total Amount) -->
    <div class="px-6 mt-10 space-y-3">
        <div class="flex justify-between items-center text-sm">
            <span class="text-slate-500 font-light">Subtotal</span>
            <span class="text-slate-900 dark:text-white font-medium">R$ <%= (priceCents / 100).toFixed(2).replace('.', ',') %></span>
        </div>
        <div class="flex justify-between items-center text-sm">
            <span class="text-slate-500 font-light">Envio</span>
            <span class="text-accent-gold font-medium uppercase text-[10px] tracking-widest">Cortesia</span>
        </div>
        <div class="pt-4 border-t border-slate-100 dark:border-slate-900 flex justify-between items-center">
            <span class="text-slate-900 dark:text-white text-base font-light tracking-wide">Total</span>
            <span class="text-slate-900 dark:text-white text-xl font-bold">R$ <%= (priceCents / 100).toFixed(2).replace('.', ',') %></span>
        </div>
    </div>

    <!-- Trust Badges (3 itens como no luxury: 256-bit SSL, Secure Pay, Insured) -->
    <div class="px-6 mt-8 flex justify-center items-center gap-6 opacity-40 grayscale">
        <div class="flex items-center gap-1.5">
            <span class="material-symbols-outlined text-sm">lock</span>
            <span class="text-[10px] uppercase tracking-widest font-bold">256-bit SSL</span>
        </div>
        <div class="flex items-center gap-1.5">
            <span class="material-symbols-outlined text-sm">verified_user</span>
            <span class="text-[10px] uppercase tracking-widest font-bold">Pagamento seguro</span>
        </div>
        <div class="flex items-center gap-1.5">
            <span class="material-symbols-outlined text-sm">local_shipping</span>
            <span class="text-[10px] uppercase tracking-widest font-bold">Segurado</span>
        </div>
    </div>
    <% } %>
</main>

<% if (paymentStatus !== 'PAID') { %>
<!-- Fixed Bottom CTA (igual ao luxury: Pay Now + support text) -->
<div id="cta-pix" class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-background-light dark:from-background-dark via-background-light dark:via-background-dark to-transparent pt-10">
    <div class="max-w-md mx-auto">
        <button type="button" id="cta-btn-pix" class="w-full bg-slate-900 dark:bg-white text-white dark:text-black h-16 rounded-xl font-semibold tracking-[0.2em] uppercase text-sm flex items-center justify-center gap-3 active:scale-[0.98] transition-all hover:ring-2 hover:ring-accent-gold shadow-2xl">
            <span>Gerar Pix</span>
            <span class="material-symbols-outlined !text-base">qr_code_2</span>
        </button>
        <p class="text-center text-[10px] text-slate-400 dark:text-slate-600 mt-4 font-light tracking-wide uppercase">Devolução em 30 dias e suporte incluídos</p>
    </div>
</div>
<div id="cta-card" style="display:none;" class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-background-light dark:from-background-dark via-background-light dark:via-background-dark to-transparent pt-10">
    <div class="max-w-md mx-auto">
        <button type="button" id="cta-btn-card" class="w-full bg-slate-900 dark:bg-white text-white dark:text-black h-16 rounded-xl font-semibold tracking-[0.2em] uppercase text-sm flex items-center justify-center gap-3 active:scale-[0.98] transition-all hover:ring-2 hover:ring-accent-gold shadow-2xl">
            <span>Pagar agora</span>
            <span class="material-symbols-outlined !text-base">arrow_forward</span>
        </button>
        <p class="text-center text-[10px] text-slate-400 dark:text-slate-600 mt-4 font-light tracking-wide uppercase">Devolução em 30 dias e suporte incluídos</p>
    </div>
</div>
<% } %>

<% if (paymentStatus !== 'PAID') { %>
<script>
(function() {
    const submissionId = '<%= submissionId %>';
    const baseUrl = '<%= baseUrl %>';
    const slug = '<%= slug %>';
    const itemId = '<%= itemId %>';

    const btnGenerate = document.getElementById('btn-generate-pix');
    const qrcodeContainer = document.getElementById('qrcode-container');
    const qrcodeImg = document.getElementById('qrcode-img');
    const pixCopyText = document.getElementById('pix-copy-text');
    const btnCopyPix = document.getElementById('btn-copy-pix');
    const stateLoading = document.getElementById('state-loading');
    const stateError = document.getElementById('state-error');
    const methodCards = document.querySelectorAll('.method-card');
    const pixSection = document.getElementById('pix-section');
    const cardSection = document.getElementById('card-section');
    const ctaPix = document.getElementById('cta-pix');
    const ctaCard = document.getElementById('cta-card');
    const ctaBtnPix = document.getElementById('cta-btn-pix');
    const ctaBtnCard = document.getElementById('cta-btn-card');

    let pixCodeText = '';

    function showError(msg) {
        stateError.textContent = msg;
        stateError.style.display = 'block';
    }
    function hideError() {
        stateError.style.display = 'none';
    }

    function selectMethod(method) {
        methodCards.forEach(function(el) {
            el.classList.toggle('selected', el.getAttribute('data-method') === method);
        });
        pixSection.style.display = method === 'pix' ? 'block' : 'none';
        cardSection.style.display = method === 'card' ? 'block' : 'none';
        if (ctaPix) ctaPix.style.display = method === 'pix' ? 'block' : 'none';
        if (ctaCard) ctaCard.style.display = method === 'card' ? 'block' : 'none';
    }
    methodCards.forEach(function(el) {
        el.addEventListener('click', function() {
            selectMethod(el.getAttribute('data-method'));
        });
    });

    function doGeneratePix() {
        hideError();
        stateLoading.style.display = 'block';
        if (btnGenerate) btnGenerate.disabled = true;
        fetch(baseUrl + '/api/checkout/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ submissionId: submissionId, method: 'pix' })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            stateLoading.style.display = 'none';
            if (btnGenerate) btnGenerate.disabled = false;
            if (data.error) {
                showError(data.error);
                return;
            }
            if (data.qrCode) {
                qrcodeImg.src = data.qrCode.startsWith('data:') ? data.qrCode : 'data:image/png;base64,' + data.qrCode;
                qrcodeImg.style.display = 'block';
            }
            if (data.qrCodeText) {
                pixCodeText = data.qrCodeText;
                pixCopyText.textContent = pixCodeText.substring(0, 60) + '...';
            }
            qrcodeContainer.style.display = 'block';
            if (btnGenerate) btnGenerate.style.display = 'none';
            startPaymentStatusPolling();
        })
        .catch(function() {
            stateLoading.style.display = 'none';
            if (btnGenerate) btnGenerate.disabled = false;
            showError('Erro de conexão. Tente novamente.');
        });
    }

    var paymentPollInterval = null;
    function startPaymentStatusPolling() {
        if (paymentPollInterval) return;
        paymentPollInterval = setInterval(function() {
            fetch(baseUrl + '/api/checkout/page?submissionId=' + encodeURIComponent(submissionId))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success && data.submission && data.submission.payment_status === 'PAID') {
                        if (paymentPollInterval) { clearInterval(paymentPollInterval); paymentPollInterval = null; }
                        window.location.reload();
                    }
                })
                .catch(function() {});
        }, 3000);
    }

    if (btnGenerate) btnGenerate.addEventListener('click', doGeneratePix);
    if (ctaBtnPix) ctaBtnPix.addEventListener('click', doGeneratePix);

    if (btnCopyPix) btnCopyPix.addEventListener('click', function() {
        if (!pixCodeText) return;
        navigator.clipboard.writeText(pixCodeText).then(function() {
            var t = btnCopyPix.textContent;
            btnCopyPix.textContent = 'Copiado!';
            setTimeout(function() { btnCopyPix.textContent = t; }, 2000);
        });
    });

    var cardNumber = document.getElementById('card-number');
    if (cardNumber) cardNumber.addEventListener('input', function() {
        var v = this.value.replace(/\D/g, '');
        this.value = v.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
    });

    var expiryEl = document.getElementById('card-expiry');
    if (expiryEl) expiryEl.addEventListener('input', function() {
        var v = this.value.replace(/\D/g, '');
        if (v.length >= 2) this.value = v.slice(0, 2) + ' / ' + v.slice(2, 6);
        else this.value = v;
    });

    var cpfEl = document.getElementById('card-holder-cpf');
    if (cpfEl) cpfEl.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 11);
    });

    function getCardPayload() {
        var number = (document.getElementById('card-number').value || '').replace(/\D/g, '');
        var expiry = (document.getElementById('card-expiry').value || '').replace(/\D/g, '');
        var expMonth = expiry.slice(0, 2);
        var expYearShort = expiry.length >= 4 ? expiry.slice(2, 4) : (expiry.length >= 2 ? expiry.slice(2) : '');
        return {
            number: number,
            exp_month: expMonth,
            exp_year: expYearShort,
            security_code: (document.getElementById('card-cvv').value || '').replace(/\D/g, '').slice(0, 4),
            holder_name: (document.getElementById('card-holder').value || '').trim(),
            holder_tax_id: (document.getElementById('card-holder-cpf').value || '').replace(/\D/g, '').slice(0, 11),
            installments: parseInt(document.getElementById('card-installments').value, 10) || 1
        };
    }

    function payWithCard(method) {
        var card = getCardPayload();
        if (!card.number || card.number.length < 13) { showError('Informe o número do cartão.'); return; }
        if (!card.exp_month || card.exp_month.length < 2) { showError('Informe a validade (MM / AA).'); return; }
        if (!card.security_code || card.security_code.length < 3) { showError('Informe o CVV.'); return; }
        if (!card.holder_name) { showError('Informe o nome do titular.'); return; }
        hideError();
        stateLoading.style.display = 'block';
        document.getElementById('btn-pay-credit').disabled = true;
        document.getElementById('btn-pay-debit').disabled = true;
        if (ctaBtnCard) ctaBtnCard.disabled = true;
        fetch(baseUrl + '/api/checkout/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                submissionId: submissionId,
                method: method,
                card_number: card.number,
                exp_month: card.exp_month,
                exp_year: card.exp_year,
                security_code: card.security_code,
                holder_name: card.holder_name,
                holder_tax_id: card.holder_tax_id || undefined,
                installments: method === 'credit_card' ? card.installments : 1
            })
        })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(result) {
            stateLoading.style.display = 'none';
            document.getElementById('btn-pay-credit').disabled = false;
            document.getElementById('btn-pay-debit').disabled = false;
            if (ctaBtnCard) ctaBtnCard.disabled = false;
            if (!result.ok) {
                showError(result.data.error || 'Erro ao processar pagamento.');
                return;
            }
            if (result.data.paid) {
                window.location.reload();
            } else {
                showError('Pagamento em análise ou não aprovado. Tente outro cartão ou use Pix.');
            }
        })
        .catch(function() {
            stateLoading.style.display = 'none';
            document.getElementById('btn-pay-credit').disabled = false;
            document.getElementById('btn-pay-debit').disabled = false;
            if (ctaBtnCard) ctaBtnCard.disabled = false;
            showError('Erro de conexão. Tente novamente.');
        });
    }
    document.getElementById('btn-pay-credit').addEventListener('click', function() { payWithCard('credit_card'); });
    document.getElementById('btn-pay-debit').addEventListener('click', function() { payWithCard('debit_card'); });
    if (ctaBtnCard) ctaBtnCard.addEventListener('click', function() { payWithCard('credit_card'); });
})();
</script>
<% } %>

<footer class="py-6 text-center text-slate-500 dark:text-slate-600 text-xs">
    <%= checkoutPageFooter || 'KingForms by ConectaKing' %>
</footer>
</body>
</html>
