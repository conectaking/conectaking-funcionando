<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planos de Assinatura - Conecta King</title>
    
    <!-- CSS do Helper -->
    <link rel="stylesheet" href="/css/subscription-plans.css">
    
    <style>
        body {
            background: #0D0D0F;
            color: #ECECEC;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #FFC700;
            margin-bottom: 40px;
        }
        
        .subscription-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 40px;
        }
        
        .subscription-info h2 {
            color: #FFC700;
            margin-top: 0;
        }
        
        .subscription-status {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            flex: 1;
            min-width: 200px;
        }
        
        .status-item label {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-item value {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #FFC700;
        }
        
        .status-active {
            color: #10B981;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëë Planos de Assinatura</h1>
        
        <!-- Informa√ß√µes da Assinatura Atual (se autenticado) -->
        <div id="current-subscription" class="subscription-info" style="display: none;">
            <h2>Sua Assinatura</h2>
            <div class="subscription-status">
                <div class="status-item">
                    <label>Status</label>
                    <value id="subscription-status" class="status-active">Ativa</value>
                </div>
                <div class="status-item">
                    <label>Plano Atual</label>
                    <value id="current-plan-name">Nenhum plano ativo</value>
                </div>
                <div class="status-item">
                    <label>Data de Assinatura</label>
                    <value id="subscription-date">-</value>
                </div>
                <div class="status-item">
                    <label>Data de Expira√ß√£o</label>
                    <value id="subscription-expires">-</value>
                </div>
            </div>
        </div>
        
        <!-- Container para Planos -->
        <div id="plans-container">
            <p style="text-align: center; color: rgba(255, 255, 255, 0.6);">
                Carregando planos...
            </p>
        </div>
    </div>
    
    <!-- JavaScript do Helper -->
    <script src="/js/subscription-plans-helper.js"></script>
    
    <script>
        // Fun√ß√£o para carregar informa√ß√µes da assinatura atual (se autenticado)
        async function loadCurrentSubscription() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                return; // N√£o autenticado, n√£o mostrar informa√ß√µes
            }
            
            try {
                const response = await fetch('/api/subscription/info', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.currentPlan) {
                        document.getElementById('current-subscription').style.display = 'block';
                        document.getElementById('current-plan-name').textContent = data.currentPlan.plan_name;
                        
                        if (data.user.subscriptionStatus) {
                            const statusEl = document.getElementById('subscription-status');
                            statusEl.textContent = data.user.subscriptionStatus;
                            statusEl.className = data.user.subscriptionStatus === 'active' ? 'status-active' : '';
                        }
                        
                        if (data.user.subscriptionExpiresAt) {
                            const expiresDate = new Date(data.user.subscriptionExpiresAt);
                            document.getElementById('subscription-expires').textContent = 
                                expiresDate.toLocaleDateString('pt-BR');
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar assinatura atual:', error);
            }
        }
        
        // Fun√ß√£o para lidar com sele√ß√£o de plano
        function handlePlanSelection(plan, paymentMethod) {
            console.log('Plano selecionado:', plan.plan_name);
            console.log('M√©todo de pagamento:', paymentMethod);
            
            // Obter informa√ß√µes de pagamento
            const paymentInfo = window.SubscriptionPlansHelper.getPaymentInfo(plan, paymentMethod);
            
            // Montar mensagem para WhatsApp (exemplo)
            const pixKey = plan.pix_key || 'CHAVE_PIX_AQUI';
            const whatsappNumber = plan.whatsapp_number || '5511999999999';
            
            let message = `Ol√°! Gostaria de assinar o plano *${plan.plan_name}*\n\n`;
            message += `*Forma de Pagamento:* ${paymentInfo.method}\n`;
            message += `*Valor:* ${window.SubscriptionPlansHelper.formatCurrency(paymentInfo.price)}\n`;
            
            if (paymentMethod === 'installment') {
                message += `*Parcelas:* ${plan.paymentOptions.installment.installments}x\n`;
                message += `*Valor por parcela:* ${window.SubscriptionPlansHelper.formatCurrency(plan.paymentOptions.installment.installmentValue)}\n`;
                message += `*Valor total:* ${window.SubscriptionPlansHelper.formatCurrency(plan.paymentOptions.installment.totalPrice)}\n`;
            }
            
            message += `\nPor favor, envie a chave PIX: *${pixKey}*`;
            
            // Abrir WhatsApp
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Alternativa: Redirecionar para checkout
            // const checkoutUrl = `/checkout?` + new URLSearchParams({
            //     plan_id: plan.id,
            //     plan_code: plan.plan_code,
            //     payment_method: paymentMethod,
            //     amount: paymentInfo.price
            // });
            // window.location.href = checkoutUrl;
        }
        
        // Carregar planos quando a p√°gina estiver pronta
        document.addEventListener('DOMContentLoaded', async () => {
            // Carregar assinatura atual (se autenticado)
            await loadCurrentSubscription();
            
            // Carregar e renderizar planos
            const container = document.getElementById('plans-container');
            
            if (typeof window.SubscriptionPlansHelper === 'undefined') {
                container.innerHTML = `
                    <div class="error-message">
                        <p>Erro: Helper de planos n√£o carregado. Verifique se o arquivo est√° acess√≠vel.</p>
                    </div>
                `;
                return;
            }
            
            try {
                await window.SubscriptionPlansHelper.loadAndRenderPlans(container, {
                    apiEndpoint: '/api/subscription/plans-public',
                    onSelectPlan: handlePlanSelection,
                    showFeatures: true,
                    showDescription: true
                });
                
                console.log('‚úÖ Planos carregados com sucesso');
            } catch (error) {
                console.error('‚ùå Erro ao carregar planos:', error);
                container.innerHTML = `
                    <div class="error-message">
                        <p>Erro ao carregar planos. Por favor, tente novamente.</p>
                        <button onclick="location.reload()">Recarregar</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
