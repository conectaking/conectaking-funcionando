const express = require('express');
const db = require('../db');
const { protectUser } = require('../middleware/protectUser');
const { protectAdmin } = require('../middleware/protectAdmin');
const { asyncHandler } = require('../middleware/errorHandler');

const router = express.Router();

console.log('‚úÖ Rotas IA KING carregadas');

// POST /api/ia-king/train-initial - Treinamento inicial completo do sistema (ADM)
router.post('/train-initial', protectAdmin, asyncHandler(async (req, res) => {
    console.log('üì• Requisi√ß√£o recebida: POST /api/ia-king/train-initial');
    const client = await db.pool.connect();
    try {
        console.log('üß† Iniciando treinamento inicial completo da IA KING...');
        
        // Buscar informa√ß√µes do sistema
        const plansResult = await client.query('SELECT * FROM subscription_plans WHERE is_active = true ORDER BY price ASC');
        const modulesResult = await client.query(`
            SELECT DISTINCT module_type 
            FROM module_plan_availability 
            WHERE is_available = true 
            ORDER BY module_type
        `);
        
        const knowledgeEntries = [];
        
        // 1. Informa√ß√µes gerais do sistema
        knowledgeEntries.push({
            title: 'O que √© o Conecta King?',
            content: `O Conecta King √© uma plataforma completa e profissional para cria√ß√£o de cart√µes virtuais digitais. Com ele, voc√™ pode criar um cart√£o de visita virtual moderno e interativo que funciona como um hub central para todas as suas informa√ß√µes profissionais e de contato.

Funcionalidades principais:
‚Ä¢ Cria√ß√£o de cart√£o virtual personalizado
‚Ä¢ M√∫ltiplos m√≥dulos integrados (redes sociais, contatos, links, etc.)
‚Ä¢ Sistema de assinatura com diferentes planos
‚Ä¢ P√°gina de vendas integrada
‚Ä¢ Compartilhamento f√°cil via link √∫nico
‚Ä¢ Design responsivo e profissional
‚Ä¢ Analytics e relat√≥rios de visualiza√ß√µes

O Conecta King √© ideal para profissionais, empresas e empreendedores que querem ter uma presen√ßa digital profissional e moderna.`,
            keywords: ['conecta king', 'plataforma', 'cart√£o virtual', 'o que √©', 'funcionalidades', 'recursos'],
            category: 'Sistema'
        });
        
        // 2. Planos e valores detalhados
        if (plansResult.rows.length > 0) {
            let plansContent = 'O Conecta King oferece os seguintes planos de assinatura:\n\n';
            
            plansResult.rows.forEach((plan, index) => {
                const features = plan.features ? JSON.parse(plan.features) : {};
                plansContent += `**${plan.plan_name}** - R$ ${plan.price.toFixed(2)}/m√™s\n`;
                plansContent += `C√≥digo: ${plan.plan_code}\n`;
                if (plan.description) {
                    plansContent += `${plan.description}\n`;
                }
                
                if (plan.plan_code === 'basic') {
                    plansContent += `\nRecursos inclu√≠dos:\n`;
                    plansContent += `‚Ä¢ Todas as funcionalidades do cart√£o\n`;
                    plansContent += `‚Ä¢ Todos os m√≥dulos dispon√≠veis\n`;
                    plansContent += `‚Ä¢ 1 perfil/cart√£o\n`;
                    plansContent += `‚Ä¢ N√ÉO pode alterar a logomarca do Conecta King no rodap√©\n`;
                } else if (plan.plan_code === 'premium') {
                    plansContent += `\nRecursos inclu√≠dos:\n`;
                    plansContent += `‚Ä¢ Todas as funcionalidades do cart√£o\n`;
                    plansContent += `‚Ä¢ Todos os m√≥dulos dispon√≠veis\n`;
                    plansContent += `‚Ä¢ 1 perfil/cart√£o\n`;
                    plansContent += `‚Ä¢ PODE alterar a logomarca do Conecta King no rodap√©\n`;
                } else if (plan.plan_code === 'enterprise') {
                    plansContent += `\nRecursos inclu√≠dos:\n`;
                    plansContent += `‚Ä¢ Todas as funcionalidades do cart√£o\n`;
                    plansContent += `‚Ä¢ Todos os m√≥dulos dispon√≠veis\n`;
                    plansContent += `‚Ä¢ 3 perfis/cart√µes em uma √∫nica assinatura\n`;
                    plansContent += `‚Ä¢ PODE alterar a logomarca do Conecta King no rodap√© para cada cart√£o\n`;
                    plansContent += `‚Ä¢ Ideal para empresas que precisam de m√∫ltiplos cart√µes\n`;
                }
                
                if (plan.whatsapp_number) {
                    plansContent += `\nPara assinar: Entre em contato via WhatsApp ${plan.whatsapp_number}\n`;
                }
                if (plan.pix_key) {
                    plansContent += `Pagamento via PIX: ${plan.pix_key}\n`;
                }
                plansContent += '\n';
            });
            
            knowledgeEntries.push({
                title: 'Planos e Valores do Conecta King',
                content: plansContent,
                keywords: ['planos', 'valores', 'pre√ßos', 'assinatura', 'pacotes', 'basic', 'premium', 'enterprise', 'individual', 'empresarial'],
                category: 'Assinatura'
            });
            
            // Entrada espec√≠fica sobre valores
            knowledgeEntries.push({
                title: 'Quais s√£o os valores dos planos?',
                content: `Os valores dos planos do Conecta King s√£o:\n\n${plansResult.rows.map(p => `‚Ä¢ **${p.plan_name}**: R$ ${p.price.toFixed(2)} por m√™s`).join('\n')}\n\nCada plano oferece funcionalidades espec√≠ficas. O Pacote 1 (R$ 480) inclui todas as funcionalidades mas n√£o permite alterar a logomarca. O Pacote 2 (R$ 700) permite alterar a logomarca. O Pacote 3 (R$ 1.500) √© empresarial e inclui 3 cart√µes com logomarcas personaliz√°veis.`,
                keywords: ['valores', 'pre√ßos', 'quanto custa', 'mensalidade', '480', '700', '1500', 'R$', 'reais'],
                category: 'Assinatura'
            });
            
            // Entrada sobre como assinar
            knowledgeEntries.push({
                title: 'Como assinar um plano?',
                content: `Para assinar um plano do Conecta King:\n\n1. Acesse a se√ß√£o "Assinatura" no seu dashboard\n2. Escolha o plano que deseja (Pacote 1, 2 ou 3)\n3. Clique em "Assinar agora"\n4. Entre em contato via WhatsApp ou fa√ßa o pagamento via PIX\n5. Ap√≥s a confirma√ß√£o do pagamento, seu plano ser√° ativado\n\nOs valores s√£o:\n${plansResult.rows.map(p => `‚Ä¢ ${p.plan_name}: R$ ${p.price.toFixed(2)}/m√™s`).join('\n')}`,
                keywords: ['como assinar', 'assinar', 'contratar', 'adquirir plano', 'pagamento'],
                category: 'Assinatura'
            });
        }
        
        // 3. M√≥dulos dispon√≠veis
        if (modulesResult.rows.length > 0) {
            const moduleNames = {
                'whatsapp': 'WhatsApp',
                'telegram': 'Telegram',
                'email': 'E-mail',
                'pix': 'PIX',
                'pix_qrcode': 'PIX QR Code',
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'tiktok': 'TikTok',
                'twitter': 'Twitter',
                'youtube': 'YouTube',
                'spotify': 'Spotify',
                'linkedin': 'LinkedIn',
                'pinterest': 'Pinterest',
                'link': 'Link Personalizado',
                'portfolio': 'Portf√≥lio',
                'banner': 'Banner',
                'carousel': 'Carrossel',
                'youtube_embed': 'YouTube Incorporado',
                'sales_page': 'P√°gina de Vendas'
            };
            
            const modulesList = modulesResult.rows.map(r => {
                const name = moduleNames[r.module_type] || r.module_type;
                return `‚Ä¢ ${name}`;
            }).join('\n');
            
            knowledgeEntries.push({
                title: 'M√≥dulos Dispon√≠veis no Conecta King',
                content: `O Conecta King oferece os seguintes m√≥dulos que podem ser adicionados ao seu cart√£o virtual:\n\n${modulesList}\n\nVoc√™ pode adicionar quantos m√≥dulos quiser (de acordo com seu plano) e organiz√°-los na ordem que preferir. Cada m√≥dulo permite adicionar suas informa√ß√µes espec√≠ficas, como links de redes sociais, n√∫meros de WhatsApp, e-mails, e muito mais.`,
                keywords: ['m√≥dulos', 'dispon√≠veis', 'adicionar', 'tipos', 'redes sociais', 'contato'],
                category: 'M√≥dulos'
            });
        }
        
        // 4. Como funciona o sistema
        knowledgeEntries.push({
            title: 'Como funciona o Conecta King?',
            content: `O Conecta King funciona de forma simples e intuitiva:

1. **Cria√ß√£o do Cart√£o**: Voc√™ cria seu cart√£o virtual personalizado com suas informa√ß√µes
2. **Adi√ß√£o de M√≥dulos**: Adicione os m√≥dulos que deseja (WhatsApp, Instagram, links, etc.)
3. **Personaliza√ß√£o**: Organize os m√≥dulos na ordem que preferir, adicione fotos, banners
4. **Compartilhamento**: Compartilhe seu link √∫nico do cart√£o com quem quiser
5. **Acompanhamento**: Veja quantas pessoas visualizaram seu cart√£o atrav√©s dos relat√≥rios

O cart√£o funciona como um site pessoal, mas muito mais simples e focado em conectar voc√™ com seus contatos e clientes.`,
            keywords: ['como funciona', 'funcionamento', 'usar', 'tutorial', 'passo a passo'],
            category: 'Sistema'
        });
        
        // 5. Diferen√ßas entre planos
        knowledgeEntries.push({
            title: 'Qual a diferen√ßa entre os planos?',
            content: `As principais diferen√ßas entre os planos s√£o:

**Pacote 1 (R$ 480/m√™s)**:
‚Ä¢ Todas as funcionalidades do cart√£o
‚Ä¢ Todos os m√≥dulos dispon√≠veis
‚Ä¢ 1 cart√£o/perfil
‚Ä¢ N√ÉO pode alterar a logomarca do Conecta King no rodap√©

**Pacote 2 (R$ 700/m√™s)**:
‚Ä¢ Todas as funcionalidades do cart√£o
‚Ä¢ Todos os m√≥dulos dispon√≠veis
‚Ä¢ 1 cart√£o/perfil
‚Ä¢ PODE alterar a logomarca do Conecta King no rodap√©

**Pacote 3 (R$ 1.500/m√™s)**:
‚Ä¢ Todas as funcionalidades do cart√£o
‚Ä¢ Todos os m√≥dulos dispon√≠veis
‚Ä¢ 3 cart√µes/perfis em uma √∫nica assinatura
‚Ä¢ PODE alterar a logomarca do Conecta King no rodap√© para cada cart√£o
‚Ä¢ Ideal para empresas`,
            keywords: ['diferen√ßa', 'compara√ß√£o', 'qual escolher', 'qual plano', 'individual', 'empresarial'],
            category: 'Assinatura'
        });
        
        // 6. Informa√ß√µes sobre m√≥dulos espec√≠ficos
        knowledgeEntries.push({
            title: 'Como adicionar m√≥dulos ao cart√£o?',
            content: `Para adicionar m√≥dulos ao seu cart√£o virtual:

1. Acesse seu dashboard
2. Clique em "Adicionar M√≥dulo" ou no bot√£o "+"
3. Escolha o tipo de m√≥dulo que deseja adicionar
4. Preencha as informa√ß√µes solicitadas (links, n√∫meros, textos, etc.)
5. Adicione uma imagem se necess√°rio
6. Salve e publique as altera√ß√µes

Voc√™ pode adicionar m√∫ltiplos m√≥dulos e organiz√°-los na ordem que preferir usando os bot√µes de mover ou arrastando e soltando.

Os m√≥dulos dispon√≠veis dependem do seu plano de assinatura.`,
            keywords: ['adicionar m√≥dulo', 'como adicionar', 'm√≥dulos', 'adicionar', 'criar m√≥dulo'],
            category: 'M√≥dulos'
        });
        
        // 7. Informa√ß√µes sobre p√°gina de vendas
        knowledgeEntries.push({
            title: 'P√°gina de Vendas - Conecta King',
            content: `A P√°gina de Vendas √© um m√≥dulo especial do Conecta King que permite criar uma p√°gina completa de vendas personalizada.

Funcionalidades:
‚Ä¢ Design personalizado com cores e estilos
‚Ä¢ Banner principal com imagem
‚Ä¢ Logo personalizada (com sistema de corte)
‚Ä¢ Descri√ß√£o completa do produto/servi√ßo
‚Ä¢ Cat√°logo de produtos integrado
‚Ä¢ Bot√µes de a√ß√£o (WhatsApp, compra, etc.)
‚Ä¢ Analytics de visualiza√ß√µes e cliques

Como usar:
1. Adicione o m√≥dulo "P√°gina de Vendas"
2. Configure o banner, logo e descri√ß√£o
3. Adicione produtos ao cat√°logo se desejar
4. Personalize cores e estilos
5. Publique e compartilhe o link

A p√°gina de vendas √© ideal para profissionais que querem vender produtos ou servi√ßos diretamente pelo cart√£o virtual.`,
            keywords: ['p√°gina de vendas', 'sales page', 'vendas', 'produtos', 'cat√°logo'],
            category: 'M√≥dulos'
        });
        
        // 8. Informa√ß√µes sobre compartilhamento
        knowledgeEntries.push({
            title: 'Como compartilhar meu cart√£o?',
            content: `Compartilhar seu cart√£o virtual √© muito simples:

1. Acesse seu dashboard
2. Clique em "Ver Cart√£o" ou "Compartilhar"
3. Copie o link √∫nico do seu cart√£o
4. Compartilhe onde quiser: WhatsApp, Instagram, email, etc.

O link √© √∫nico e permanente. Todas as pessoas que acessarem ver√£o seu cart√£o atualizado com todas as informa√ß√µes e m√≥dulos que voc√™ configurou.

Voc√™ tamb√©m pode usar o QR Code para compartilhamento f√≠sico (impress√£o em cart√µes de visita, por exemplo).

Todas as visualiza√ß√µes s√£o registradas e voc√™ pode acompanhar nos relat√≥rios.`,
            keywords: ['compartilhar', 'link', 'QR code', 'como compartilhar', 'link √∫nico'],
            category: 'Sistema'
        });
        
        // Inserir todas as entradas na base de conhecimento
        let insertedCount = 0;
        const categoryMap = {};
        
        // Buscar categorias
        const categoriesResult = await client.query('SELECT id, name FROM ia_categories');
        categoriesResult.rows.forEach(cat => {
            categoryMap[cat.name] = cat.id;
        });
        
        for (const entry of knowledgeEntries) {
            try {
                // Verificar se j√° existe
                const existing = await client.query(
                    'SELECT id FROM ia_knowledge_base WHERE LOWER(title) = LOWER($1)',
                    [entry.title]
                );
                
                if (existing.rows.length === 0) {
                    await client.query(
                        `INSERT INTO ia_knowledge_base (title, content, category_id, keywords, source_type, priority)
                         VALUES ($1, $2, $3, $4, $5, $6)`,
                        [
                            entry.title,
                            entry.content,
                            categoryMap[entry.category] || null,
                            Array.isArray(entry.keywords) ? entry.keywords : [],
                            'system_training',
                            100 // Alta prioridade
                        ]
                    );
                    insertedCount++;
                }
            } catch (error) {
                console.error(`Erro ao inserir conhecimento: ${entry.title}`, error);
            }
        }
        
        console.log(`‚úÖ Treinamento inicial conclu√≠do! ${insertedCount} entradas adicionadas.`);
        
        res.json({
            message: `Treinamento inicial conclu√≠do com sucesso! ${insertedCount} entradas de conhecimento adicionadas √† base.`,
            inserted: insertedCount,
            total: knowledgeEntries.length
        });
        
    } catch (error) {
        console.error('‚ùå Erro no treinamento inicial:', error);
        throw error;
    } finally {
        client.release();
    }
}));

module.exports = router;
